<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.returns">
	<!-- ============================================ -->
	<!-- 반품 신청 등록 (INSERT) -->
	<!-- ============================================ -->
	<!-- 용도: 사용자가 반품 신청할 때 
	returns 테이블에 데이터 저장 호출: Service에서 반품 신청 버튼 클릭 시 -->
	<insert id="insertReturns" parameterType="dto.Returns"
		useGeneratedKeys="true" keyProperty="returnsId">
		INSERT INTO returns (
		member_id,
		order_item_id,
		image1_file_id,
		image2_file_id,
		image3_file_id,
		rejection_reason,
		reason,
		shipping_cost,
		shipping_cost_payer,
		return_carrier_name,
		return_tracking_no
		) VALUES (
		#{memberId},
		#{orderItemId},
		#{image1FileId},
		#{image2FileId},
		#{image3FileId},
		#{rejectionReason},
		#{reason},
		#{shippingCost},
		#{shippingCostPayer},
		#{returnCarrierName},
		#{returnTrackingNo}
		)
	</insert>

	<!-- ============================================ -->
	<!-- 반품 목록 조회 (회원별) -->
	<!-- ============================================ -->
	<!-- 용도: 마이페이지에서 내 반품 내역 리스트 보여주기 
	     교환/반품/취소 내역 페이지 
	     반환: 반품 정보 + 주문 상품 정보 (상품명, 가격, 수량 등) -->
	<select id="selectReturnsListByMemberId" parameterType="long"
		resultType="map">
		SELECT
		r.returns_id,
		r.member_id,
		r.order_id,
		r.order_item_id,
		r.rejection_reason,
		r.reason,
		r.shipping_cost,
		r.shipping_cost_payer,
		r.return_carrier_name,
		r.return_tracking_no,
		r.updated_at,
		/* 주문 상품 정보 */
		oi.brand_id,
		oi.product_id,
		oi.option_id,
		oi.unit_price,
		oi.quantity,
		oi.status,
		/* 주문 정보 */
		o.order_code
		FROM returns r
		INNER JOIN order_item oi ON r.order_item_id = oi.order_item_id
		INNER JOIN orders o ON oi.order_id = o.orders_id
		WHERE r.member_id = #{memberId}
		ORDER BY r.updated_at DESC
	</select>

	<!-- ============================================ -->
	<!-- 3. 반품 상세 조회 (1건) -->
	<!-- ============================================ -->
	<!-- 용도: 반품 상세 페이지에서 1건의 반품 정보 조회 
	     반품 상세정보 페이지 -->
	<select id="selectReturnsById" parameterType="long"
		resultType="dto.Returns">
		SELECT
		returns_id AS returnsId,
		member_id AS memberId,
		order_item_id AS orderItemId,
		image1_file_id AS image1FileId,
		image2_file_id AS image2FileId,
		image3_file_id AS image3FileId,
		rejection_reason AS rejectionReason,
		reason,
		shipping_cost AS shippingCost,
		shipping_cost_payer AS shippingCostPayer,
		return_carrier_name AS returnCarrierName,
		return_tracking_no AS returnTrackingNo,
		updated_at AS updatedAt
		FROM returns
		WHERE returns_id = #{returnsId}
	</select>

	<!-- ============================================ -->
	<!-- 4. 주문 상품 상태 변경 (반품 관련) -->
	<!-- ============================================ -->
	<!-- 용도: 반품 신청/승인/거부/완료 시 order_item의 status 변경 
	     예시: DELIVERED → RETURN_REQUESTED 
		→ RETURN_APPROVED → RETURN_COMPLETED -->
	<update id="updateOrderItemStatus" parameterType="map">
		UPDATE order_item
		SET status = #{status},
		updated_at = CURRENT_TIMESTAMP
		WHERE order_item_id = #{orderItemId}
	</update>

	<!-- ============================================ -->
	<!-- 5. 특정 주문 상품의 반품 정보 조회 -->
	<!-- ============================================ -->
	<!-- 용도: 해당 주문 상품에 대한 반품 신청이 있는지 확인 예: 중복 신청 방지용 -->
	<select id="selectReturnsByOrderItemId" parameterType="long"
		resultType="dto.Returns">
		SELECT
		returns_id AS returnsId,
		member_id AS memberId,
		order_item_id AS orderItemId,
		image1_file_id AS image1FileId,
		image2_file_id AS image2FileId,
		image3_file_id AS image3FileId,
		rejection_reason AS rejectionReason,
		reason,
		shipping_cost AS shippingCost,
		shipping_cost_payer AS shippingCostPayer,
		return_carrier_name AS returnCarrierName,
		return_tracking_no AS returnTrackingNo,
		updated_at AS updatedAt
		FROM returns
		WHERE order_item_id = #{orderItemId}
		ORDER BY updated_at DESC
		LIMIT 1
	</select>
</mapper>