<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.exchange">
    <!-- ============================================ -->
    <!-- 교환 신청 등록 (INSERT)                    -->
    <!-- ============================================ -->
    <!-- 
        용도: 사용자가 교환 신청할 때 exchange 테이블에 데이터 저장
        호출: Service에서 교환 신청 버튼 클릭 시
    -->
    <insert id="insertExchange" parameterType="dto.Exchange" useGeneratedKeys="true" keyProperty="exchangeId">
        INSERT INTO exchange (
            member_id,
            order_id,
            order_item_id,
            product_option_id,
            image1_file_id,
            image2_file_id,
            image3_file_id,
            rejection_reason,
            reason,
            shipping_cost,
            shipping_cost_payer,
            note,
            return_carrier_name,
            return_tracking_no,
            shipping_carrier_name,
            shipping_tracking_no
        ) VALUES (
            #{memberId},
            #{orderId},
            #{orderItemId},
            #{productOptionId},
            #{image1FileId},
            #{image2FileId},
            #{image3FileId},
            #{rejectionReason},
            #{reason},
            #{shippingCost},
            #{shippingCostPayer},
            #{note},
            #{returnCarrierName},
            #{returnTrackingNo},
            #{shippingCarrierName},
            #{shippingTrackingNo}
        )
    </insert>

    <!-- ============================================ -->
    <!-- 교환 목록 조회 (회원별)                    -->
    <!-- ============================================ -->
    <!-- 
        용도: 마이페이지에서 내 교환 내역 리스트 보여주기
        교환/반품/취소 내역 페이지
        반환: 교환 정보 + 주문 상품 정보 (상품명, 가격, 수량 등)
    -->
    <select id="selectExchangeListByMemberId" parameterType="long" resultType="map">
        SELECT 
            e.exchange_id,
            e.member_id,
            e.order_id,
            e.order_item_id,
            e.product_option_id,
            e.rejection_reason,
            e.reason,
            e.shipping_cost,
            e.shipping_cost_payer,
            e.note,
            e.return_carrier_name,
            e.return_tracking_no,
            e.shipping_carrier_name,
            e.shipping_tracking_no,
            e.updated_at,
            oi.brand_id,
            oi.product_id,
            oi.option_id,
            oi.unit_price,
            oi.quantity,
            oi.status,
            o.order_code
        FROM exchange e
        INNER JOIN order_item oi ON e.order_item_id = oi.order_item_id
        INNER JOIN orders o ON e.order_id = o.orders_id
        WHERE e.member_id = #{memberId}
        ORDER BY e.updated_at DESC
    </select>

    <!-- ============================================ -->
    <!-- 교환 상세 조회 (1건)                       -->
    <!-- ============================================ -->
    <!-- 
        용도: 교환 상세 페이지에서 1건의 교환 정보 조회
        화면: 이미지2, 이미지4 - 교환 상세정보 페이지
    -->
    <select id="selectExchangeById" parameterType="long" resultType="dto.Exchange">
        SELECT 
            exchange_id AS exchangeId,
            member_id AS memberId,
            order_id AS orderId,
            order_item_id AS orderItemId,
            product_option_id AS productOptionId,
            image1_file_id AS image1FileId,
            image2_file_id AS image2FileId,
            image3_file_id AS image3FileId,
            rejection_reason AS rejectionReason,
            reason,
            shipping_cost AS shippingCost,
            shipping_cost_payer AS shippingCostPayer,
            note,
            return_carrier_name AS returnCarrierName,
            return_tracking_no AS returnTrackingNo,
            shipping_carrier_name AS shippingCarrierName,
            shipping_tracking_no AS shippingTrackingNo,
            updated_at AS updatedAt
        FROM exchange
        WHERE exchange_id = #{exchangeId}
    </select>

    <!-- ============================================ -->
    <!--  주문 상품 상태 변경 (교환 관련)             -->
    <!-- ============================================ -->
    <!-- 
        용도: 교환 신청/승인/거부/완료 시 order_item의 status 변경
        예시: DELIVERED → EXCHANGE_REQUESTED → EXCHANGE_APPROVED → EXCHANGE_COMPLETED
    -->
    <update id="updateOrderItemStatus" parameterType="map">
        UPDATE order_item
        SET status = #{status},
            updated_at = CURRENT_TIMESTAMP
        WHERE order_item_id = #{orderItemId}
    </update>

    <!-- ============================================ -->
    <!--  특정 주문 상품의 교환 정보 조회              -->
    <!-- ============================================ -->
    <!-- 
        용도: 해당 주문 상품에 대한 교환 신청이 있는지 확인
        예: 중복 신청 방지용
    -->
    <select id="selectExchangeByOrderItemId" parameterType="long" resultType="dto.Exchange">
        SELECT 
            exchange_id AS exchangeId,
            member_id AS memberId,
            order_id AS orderId,
            order_item_id AS orderItemId,
            product_option_id AS productOptionId,
            image1_file_id AS image1FileId,
            image2_file_id AS image2FileId,
            image3_file_id AS image3FileId,
            rejection_reason AS rejectionReason,
            reason,
            shipping_cost AS shippingCost,
            shipping_cost_payer AS shippingCostPayer,
            note,
            return_carrier_name AS returnCarrierName,
            return_tracking_no AS returnTrackingNo,
            shipping_carrier_name AS shippingCarrierName,
            shipping_tracking_no AS shippingTrackingNo,
            updated_at AS updatedAt
        FROM exchange
        WHERE order_item_id = #{orderItemId}
        ORDER BY updated_at DESC
        LIMIT 1
    </select>
</mapper>