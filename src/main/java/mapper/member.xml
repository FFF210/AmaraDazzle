<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.member">

    <!-- Member 객체와 DB 컬럼 매핑 -->
    <resultMap id="memberResultMap" type="dto.Member">
        <id property="memberId" column="member_id"/>
        <result property="email" column="email"/>
        <result property="password" column="password"/>
        <result property="name" column="name"/>
        <result property="nickname" column="nickname"/>
        <result property="phone" column="phone"/>
        <result property="postcode" column="postcode"/>
        <result property="line1" column="line1"/>
        <result property="line2" column="line2"/>
        <result property="birthDate" column="birth_date"/>
        <result property="gender" column="gender"/>
        <result property="skinTypeId" column="skin_type_id"/>
        <result property="personalColorId" column="personal_color_id"/>
        <result property="marketingOpt" column="marketing_opt"/>
        <result property="status" column="status"/>
        <result property="pointBalance" column="point_balance"/>
        <result property="grade" column="grade"/>
        <result property="loginType" column="login_type"/>
        <result property="kakaoId" column="kakao_id"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <!-- 회원가입 - 새 회원 등록 -->
    <insert id="insertMember" parameterType="dto.Member" useGeneratedKeys="true" keyProperty="memberId">
        INSERT INTO member (
            email, password, name, nickname, phone, 
            postcode, line1, line2, birth_date, gender, 
            skin_type_id, personal_color_id, marketing_opt, 
            status, point_balance, grade, login_type, kakao_id
        ) VALUES (
            #{email}, #{password}, #{name}, #{nickname}, #{phone},
            #{postcode}, #{line1}, #{line2}, #{birthDate}, #{gender},
            #{skinTypeId}, #{personalColorId}, #{marketingOpt},
            #{status}, #{pointBalance}, #{grade}, #{loginType}, #{kakaoId}
        )
    </insert>

    <!-- 로그인 - 이메일과 비밀번호로 회원 조회 -->
    <select id="selectByEmailAndPassword" parameterType="map" resultMap="memberResultMap">
        SELECT * FROM member 
        WHERE email = #{email} 
        AND password = #{password} 
        AND status = 'ACTIVE'
    </select>
    
    <!-- 범용 회원 조회 (조건에 따라 유연하게 사용) -->
    <select id="selectMember" parameterType="map" resultMap="memberResultMap">
        SELECT * FROM member 
        WHERE status = 'ACTIVE'
        <if test="memberId != null">
            AND member_id = #{memberId}
        </if>
        <if test="email != null">
            AND email = #{email}
        </if>
        <if test="nickname != null">
            AND nickname = #{nickname}
        </if>
        <if test="phone != null">
            AND phone = #{phone}
        </if>
        <if test="kakaoId != null">
            AND kakao_id = #{kakaoId}
        </if>
    </select>

    <!--  이메일로 회원 조회 (중복 체크, 아이디 찾기 등) -->
    <select id="selectByEmail" parameterType="string" resultMap="memberResultMap">
        SELECT * FROM member 
        WHERE email = #{email} 
        AND status = 'ACTIVE'
    </select>

    <!--  회원 ID로 회원 조회 (마이페이지, 주문 등에서 사용) -->
    <select id="selectById" parameterType="long" resultMap="memberResultMap">
        SELECT * FROM member 
        WHERE member_id = #{memberId} 
        AND status = 'ACTIVE'
    </select>

    <!-- 닉네임 중복 체크 -->
    <select id="countByNickname" parameterType="string" resultType="int">
        SELECT COUNT(*) FROM member 
        WHERE nickname = #{nickname} 
        AND status = 'ACTIVE'
    </select>

    <!-- 이메일 중복 체크 -->
    <select id="countByEmail" parameterType="string" resultType="int">
        SELECT COUNT(*) FROM member 
        WHERE email = #{email} 
        AND status = 'ACTIVE'
    </select>

    <!-- 회원 정보 수정 -->
    <update id="updateMember" parameterType="dto.Member">
        UPDATE member SET 
            name = #{name},
            nickname = #{nickname},
            phone = #{phone},
            postcode = #{postcode},
            line1 = #{line1},
            line2 = #{line2},
            birth_date = #{birthDate},
            gender = #{gender},
            skin_type_id = #{skinTypeId},
            personal_color_id = #{personalColorId},
            marketing_opt = #{marketingOpt}
        WHERE member_id = #{memberId}
    </update>

    <!-- 비밀번호 변경 -->
    <update id="updatePassword" parameterType="map">
        UPDATE member SET 
            password = #{newPassword}
        WHERE member_id = #{memberId}
    </update>

    <!-- 포인트 업데이트 (적립, 사용) -->
    <update id="updatePoints" parameterType="map">
        UPDATE member SET 
            point_balance = point_balance + #{pointChange}
        WHERE member_id = #{memberId}
    </update>

    <!-- 회원 등급 업데이트 -->
    <update id="updateGrade" parameterType="map">
        UPDATE member SET 
            grade = #{grade}
        WHERE member_id = #{memberId}
    </update>

    <!-- 회원 탈퇴 (실제 삭제가 아닌 상태 변경) -->
    <update id="deleteMember" parameterType="long">
        UPDATE member SET 
            status = 'DELETED'
        WHERE member_id = #{memberId}
    </update>

    <!-- 카카오 ID로 회원 조회 (카카오 로그인용) -->
    <select id="selectByKakaoId" parameterType="long" resultMap="memberResultMap">
        SELECT * FROM member 
        WHERE kakao_id = #{kakaoId} 
        AND status = 'ACTIVE'
    </select>

    <!-- 마이페이지용 - 회원의 기본 정보만 조회 -->
    <select id="selectBasicInfo" parameterType="long" resultType="map">
        SELECT 
            member_id as memberId,
            email,
            name,
            nickname,
            phone,
            point_balance as pointBalance,
            grade,
            created_at as joinDate
        FROM member 
        WHERE member_id = #{memberId} 
        AND status = 'ACTIVE'
    </select>

</mapper>