<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.member">

	<!-- ===============소비자용================= -->
	<!-- 회원가입 - 새 회원 등록 -->
	<insert id="insertMember" parameterType="dto.Member"
		useGeneratedKeys="true" keyProperty="memberId">
		INSERT INTO member (
		email,
		password, name, nickname, phone,
		postcode, line1, line2, birth_date,
		gender,
		skin_type_id, personal_color_id, marketing_opt,
		status,
		point_balance, grade, login_type, kakao_id
		) VALUES (
		#{email},
		#{password}, #{name}, #{nickname}, #{phone},
		#{postcode}, #{line1},
		#{line2}, #{birthDate}, #{gender},
		#{skinTypeId}, #{personalColorId},
		#{marketingOpt},
		#{status}, #{pointBalance}, #{grade}, #{loginType},
		#{kakaoId}
		)
	</insert>

	<!-- 로그인 - 이메일과 비밀번호로 회원 조회 -->
	<select id="selectByEmailAndPassword" parameterType="map"
		resultType="dto.Member">
		SELECT * FROM member
		WHERE email = #{email}
		AND password =
		#{password}
		AND status = 'ACTIVE'
	</select>

	<!-- 범용 회원 조회 (조건에 따라 유연하게 사용) -->
	<select id="selectMember" parameterType="map"
		resultType="dto.Member">
		SELECT * FROM member
		WHERE status = 'ACTIVE'
		<if test="memberId != null">
			AND member_id = #{memberId}
		</if>
		<if test="email != null">
			AND email = #{email}
		</if>
		<if test="nickname != null">
			AND nickname = #{nickname}
		</if>
		<if test="phone != null">
			AND phone = #{phone}
		</if>
		<if test="kakaoId != null">
			AND kakao_id = #{kakaoId}
		</if>
	</select>

	<!-- 이메일로 회원 조회 (중복 체크용) -->
	<select id="selectByEmail" parameterType="string"
		resultType="dto.Member">
		SELECT * FROM member
		WHERE email = #{email}
		AND status =
		'ACTIVE'
	</select>

	<!-- 회원 ID로 회원 조회 (마이페이지, 주문 등에서 사용) -->
	<select id="selectById" parameterType="Long"
		resultType="dto.Member">
		SELECT * FROM member
		WHERE member_id = #{memberId}
		AND status
		= 'ACTIVE'
	</select>

	<!-- 이름과 휴대폰으로 이메일 찾기 (아이디 찾기) -->
	<select id="selectEmailByNameAndPhone" parameterType="map"
		resultType="string">
		SELECT email FROM member
		WHERE name = #{name}
		AND phone =
		#{phone}
		AND status = 'ACTIVE'
	</select>

	<!-- 이메일과 휴대폰으로 회원 ID 찾기 (비밀번호 재설정용) -->
	<select id="selectIdByEmailAndPhone" parameterType="map"
		resultType="Long">
		SELECT member_id FROM member
		WHERE email = #{email}
		AND phone
		= #{phone}
		AND status = 'ACTIVE'
	</select>
	
	<!-- findAccount 비밀번호 재설정 -->
	<update id="updatePassword" parameterType="map">
		UPDATE member SET
		password = #{newPassword}
		WHERE member_id = #{memberId}
	</update>

	<!-- 체크아웃 페이지용 회원 정보 조회 -->
	<!-- 이름, 전화번호, 주소, 포인트 정보만 조회 -->
	<select id="getMemberInfoForCheckout" parameterType="Long"
		resultType="dto.Member">
		SELECT
		member_id as memberId,
		name,
		phone,
		postcode,
		line1,
		line2,
		point_balance as pointBalance
		FROM member
		WHERE member_id = #{memberId}
		AND status = 'ACTIVE'
	</select>

	<!-- 회원 포인트 잔액 조회 -->
	<select id="getMemberPointBalance" parameterType="Long"
		resultType="Integer">
		SELECT point_balance
		FROM member
		WHERE member_id = #{memberId}
		AND status = 'ACTIVE'
	</select>

	<!-- 회원 포인트 차감 -->
	<!-- 주문 시 포인트 사용할 때 -->
	<update id="useMemberPoint" parameterType="map">
		UPDATE member
		SET point_balance = point_balance - #{usingPoint}
		WHERE member_id = #{memberId}
		AND point_balance >= #{usingPoint}
		AND status = 'ACTIVE'
	</update>

	<!-- 포인트 사용 가능 여부 확인 -->
	<!-- 차감 전에 포인트가 충분한지 확인 -->
	<select id="checkPointAvailable" parameterType="map"
		resultType="Boolean">
		SELECT
		CASE
		WHEN point_balance >= #{usingPoint} THEN true
		ELSE false
		END
		FROM member
		WHERE member_id = #{memberId}
		AND status = 'ACTIVE'
	</select>


    <!-- ========소비자 마이페이지용 ======= -->
	<!-- 회원 정보 수정 -->
	<update id="updateMember" parameterType="dto.Member">
		UPDATE member SET
		name =
		#{name},
		nickname = #{nickname},
		phone = #{phone},
		postcode =
		#{postcode},
		line1 = #{line1},
		line2 = #{line2},
		birth_date =
		#{birthDate},
		gender = #{gender},
		skin_type_id = #{skinTypeId},
		personal_color_id = #{personalColorId},
		marketing_opt = #{marketingOpt}
		WHERE member_id = #{memberId}
	</update>

	<!-- 포인트 업데이트 (적립, 사용) -->
	<update id="updatePoints" parameterType="map">
		UPDATE member SET
		point_balance = point_balance + #{pointChange}
		WHERE member_id =
		#{memberId}
	</update>

	<!-- 회원 등급 업데이트 -->
	<update id="updateGrade" parameterType="map">
		UPDATE member SET
		grade =
		#{grade}
		WHERE member_id = #{memberId}
	</update>

	<!-- 회원 탈퇴 (실제 삭제가 아닌 상태 변경) -->
	<update id="deleteMember" parameterType="Long">
		UPDATE member SET
		status
		= 'DELETED'
		WHERE member_id = #{memberId}
	</update>

	<!-- 카카오 ID로 회원 조회 (카카오 로그인용) -->
	<select id="selectByKakaoId" parameterType="Long"
		resultType="dto.Member">
		SELECT * FROM member
		WHERE kakao_id = #{kakaoId}
		AND status =
		'ACTIVE'
	</select>

	<!-- 마이페이지용 - 회원의 기본 정보만 조회 -->
	<select id="selectMemberInfo" parameterType="Long"
		resultType="map">
		SELECT
		member_id as memberId,
		email,
		name,
		nickname,
		phone,
		point_balance as pointBalance,
		grade,
		created_at as joinDate
		FROM member
		WHERE member_id = #{memberId}
		AND status = 'ACTIVE'
	</select>

</mapper>