<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.memberCoupon">
	<!-- ======================소비자용===============\ -->
	<!-- 사용 가능한 쿠폰 개수 조회 -->
	<select id="getAvailableCouponCount" parameterType="Long"
		resultType="Integer">
		SELECT COUNT(*)
		FROM member_coupon
		WHERE member_id =
		#{memberId}
		AND status = 'AVAILABLE'
	</select>

	<!-- 회원의 쿠폰 목록 개수 조회 (페이지네이션용) -->
	<select id="countMemberCouponList" parameterType="Long"
		resultType="int">
		SELECT COUNT(*)
		FROM member_coupon mc
		JOIN coupon c ON
		mc.coupon_id = c.coupon_id
		WHERE mc.member_id = #{memberId}
		AND
		mc.status = 'AVAILABLE'
	</select>

	<!-- 회원의 쿠폰 목록 조회 (쿠폰 상세정보 포함) -->
	<select id="selectMemberCouponList" parameterType="map"
		resultType="map">
		SELECT
		mc.member_coupon_id AS memberCouponId,
		c.writer_id AS writerId,
		c.cname,
		c.amount,
		c.amount_condition AS amountCondition,
		c.start_date AS
		startDate,
		c.end_date AS endDate,
		mc.status,
		mc.created_at AS createdAt
		FROM member_coupon mc
		JOIN coupon c ON mc.coupon_id = c.coupon_id
		WHERE
		mc.member_id = #{memberId}
		AND mc.status = 'AVAILABLE'
		AND ( c.writer_type = 'ADMIN'  
    	<if test="brands != null and brands.size() > 0">
    		OR
        	c.writer_id IN
        	<foreach item="brand" index="index" collection="brands" open="(" separator="," close=")">
            	#{brand}
        	</foreach>
    	</if>
    	)
		ORDER BY
		mc.created_at DESC
		LIMIT #{limit} OFFSET #{offset}
	</select>

	<!-- [소비자용] 사용한 쿠폰 정보 조회 [orderDetail 용도] -->
	<select id="getCouponInfoByMemberCouponId" parameterType="Long"
		resultType="map">
		SELECT
		c.cname,
		c.amount
		FROM member_coupon mc
		JOIN coupon c ON
		mc.coupon_id = c.coupon_id
		WHERE mc.member_coupon_id =
		#{memberCouponId}
	</select>

	<!-- [소비자용] 쿠폰 사용 가능 여부 체크 (조건 포함) -->
	<select id="checkCouponAvailable" parameterType="map"
		resultType="map">
		SELECT
		c.coupon_id AS couponId,
		c.cname,
		c.amount,
		c.amount_condition AS amountCondition,
		c.start_date AS startDate,
		c.end_date AS endDate,
		mc.status,
		mc.member_coupon_id AS memberCouponId
		FROM member_coupon mc
		JOIN coupon c ON mc.coupon_id = c.coupon_id
		WHERE mc.member_coupon_id = #{memberCouponId}
		AND mc.member_id = #{memberId}
		AND mc.status = 'AVAILABLE'
		AND NOW() BETWEEN c.start_date AND c.end_date
	</select>

	<!-- [소비자용] 쿠폰 사용 처리 -->
	<update id="useCoupon" parameterType="map">
		UPDATE member_coupon
		SET status = 'USED',
		used_date = NOW(),
		order_id = #{orderId}
		WHERE member_coupon_id = #{memberCouponId}
		AND member_id = #{memberId}
		AND status = 'AVAILABLE'
	</update>

	<!-- ============= [소비자] 회원가입시 쿠폰 넣어주기 ================== -->
	<!-- [소비자용] 회원가입 축하 쿠폰 ID 조회 -->
	<select id="getWelcomeCouponId" resultType="Long">
		SELECT coupon_id
		FROM
		coupon
		WHERE reason = 'Sign up Welcome'
		AND provision = 'ALL'
		LIMIT 1
	</select>

	<!-- [소비자용] 쿠폰 발급 -->
	<insert id="issueCoupon" parameterType="map">
		INSERT INTO member_coupon
		(
		coupon_id, member_id, status, created_at
		) VALUES (
		#{couponId},
		#{memberId}, 'AVAILABLE', NOW()
		)
	</insert>

</mapper>