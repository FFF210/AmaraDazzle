<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.orders">
	<!-- ======================= [브랜드 어드민] 주문 목록 조회 ======================= -->
	<select id="selectOrdersListForBrand" resultType="map">
		SELECT DISTINCT
		o.orders_id,
		o.member_id,
		m.name AS member_name,
		o.total_amount,
		o.created_at,
		(SELECT p.name
		FROM order_item oi2
		JOIN product p ON
		oi2.product_id = p.product_id
		WHERE oi2.order_id = o.orders_id
		AND
		oi2.brand_id = #{brandId}
		LIMIT 1) AS product_name,
		(SELECT
		GROUP_CONCAT(DISTINCT p.name SEPARATOR ', ')
		FROM order_item oi2
		JOIN
		product p ON oi2.product_id = p.product_id
		WHERE oi2.order_id =
		o.orders_id
		AND oi2.brand_id = #{brandId}
		) AS product_names,
		COALESCE(
		(SELECT oi2.status
		FROM order_item oi2
		WHERE oi2.order_id = o.orders_id
		AND oi2.brand_id = #{brandId}
		AND oi2.status IN
		('PAID','PREPARING','SHIPPING','DELIVERED','CONFIRMED')
		ORDER BY
		CASE
		oi2.status
		WHEN 'PAID' THEN 1
		WHEN 'PREPARING' THEN 2
		WHEN 'SHIPPING'
		THEN 3
		WHEN 'DELIVERED' THEN 4
		WHEN 'CONFIRMED' THEN 5
		END
		LIMIT 1),
		(SELECT oi3.status
		FROM order_item oi3
		WHERE oi3.order_id = o.orders_id
		AND oi3.brand_id = #{brandId}
		LIMIT 1)
		) AS orderStatus,
		CASE
		WHEN EXISTS
		(
		SELECT 1
		FROM order_item oi2
		WHERE oi2.order_id = o.orders_id
		AND
		oi2.brand_id = #{brandId}
		AND oi2.status = 'CANCELLED'
		) THEN 1 ELSE 0
		END AS has_cancelled_item,
		CASE
		WHEN EXISTS (
		SELECT 1
		FROM order_item oi3
		WHERE oi3.order_id = o.orders_id
		AND oi3.brand_id = #{brandId}
		AND
		oi3.status LIKE 'RETURN%'
		) THEN 1 ELSE 0
		END AS has_return_item,
		CASE
		WHEN EXISTS (
		SELECT 1
		FROM order_item oi4
		WHERE oi4.order_id =
		o.orders_id
		AND oi4.brand_id = #{brandId}
		AND oi4.status LIKE
		'EXCHANGE%'
		) THEN 1 ELSE 0
		END AS has_exchange_item

		FROM orders o
		JOIN
		order_item oi ON o.orders_id = oi.order_id
		JOIN member m ON o.member_id
		= m.member_id
		WHERE oi.brand_id = #{brandId}
		ORDER BY o.created_at DESC
	</select>


	<!-- ======================= [브랜드 어드민] 주문 요약 조회 ======================= -->
	<select id="selectOrderSummaryForBrand"
		resultType="ordersSummary">
		SELECT
		o.orders_id,
		o.created_at,
		COALESCE(
		(SELECT oi2.status
		FROM order_item oi2
		WHERE oi2.order_id = o.orders_id
		AND oi2.brand_id = #{brandId}
		AND oi2.status IN ('PAID','PREPARING','SHIPPING','DELIVERED','CONFIRMED')
		ORDER BY CASE oi2.status
		WHEN 'PAID' THEN 1
		WHEN 'PREPARING' THEN 2
		WHEN 'SHIPPING' THEN 3
		WHEN 'DELIVERED' THEN 4
		WHEN 'CONFIRMED' THEN 5
		END
		LIMIT 1),
		(SELECT oi3.status
		FROM order_item oi3
		WHERE oi3.order_id = o.orders_id
		AND oi3.brand_id = #{brandId}
		LIMIT 1)
		) AS orderStatus,
		oi.tracking_no,
		oi.carrier_name,
		o.subtotal_amount,
		o.discount_amount,
		o.shipping_amount,
		o.total_amount,
		o.ship_recipient,
		o.ship_phone,
		o.ship_postcode,
		o.ship_line1,
		o.ship_line2,
		o.note,
		m.email AS member_email,
		m.name AS member_name,
		m.phone AS member_phone
		FROM orders o
		JOIN order_item oi ON o.orders_id = oi.order_id
		JOIN member m ON o.member_id = m.member_id
		WHERE oi.brand_id = #{brandId}
		AND o.orders_id = #{orderId}
		LIMIT 1
	</select>

	<!-- ======================= [브랜드 어드민] 주문 상품 상세 조회 ======================= -->
	<select id="selectOrderItemsForBrand"
		resultType="ordersItemDetail">
		SELECT
		oi.order_item_id,
		oi.product_id,
		oi.option_id,
		oi.status AS item_status,
		p.name AS product_name,
		po.option_value AS option_name,
		CASE
		WHEN po.product_option_id IS NOT NULL
		THEN (po.price * oi.quantity)
		ELSE (p.price * oi.quantity)
		END AS productPrice
		FROM order_item oi
		JOIN product p ON oi.product_id = p.product_id
		LEFT JOIN product_option po ON oi.option_id = po.product_option_id
		WHERE oi.brand_id = #{brandId}
		AND oi.order_id = #{orderId}
		ORDER BY oi.order_item_id ASC
	</select>



</mapper>