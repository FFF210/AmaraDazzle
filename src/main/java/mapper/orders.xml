<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.orders">

	<!-- ===========================[소비자용]======================= -->
	<!-- 상품 정보 조회 (상품상세에서 바로 주문하는 경우) -->
	<!-- 옵션이 없는 상품: product 테이블의 기본 정보만 -->
	<select id="getProductForDirectOrder" parameterType="Long"
		resultType="map">
		SELECT
		p.product_id as productId,
		p.brand_id as brandId,
		p.name as productName,
		p.price as originalPrice,
		p.discount_type as
		discountType,
		p.discount_value as discountValue,
		p.start_date as
		startDate,
		p.end_date as endDate,
		p.has_option as hasOption,
		p.stock_qty
		as stockQty,
		b.brand_name as brandName
		FROM product p
		LEFT JOIN brand b
		ON p.brand_id = b.brand_id
		WHERE p.product_id = #{productId}
		AND
		p.is_visible = 1
	</select>

	<!-- 상품 옵션 정보 조회 (옵션이 있는 상품의 경우) -->
	<select id="getProductOptionInfo" parameterType="Long"
		resultType="map">
		SELECT
		po.product_option_id as optionId,
		po.product_id as
		productId,
		po.option_value as optionValue,
		po.price as optionPrice,
		po.stock_qty as stockQty
		FROM product_option po
		WHERE
		po.product_option_id = #{optionId}
	</select>

	<!-- 주문 코드 생성 (YYYYMMDD-01XXXX 형태) -->
	<select id="generateOrderCode" resultType="String">
		SELECT CONCAT(
		DATE_FORMAT(NOW(), '%Y%m%d'),
		'-',
		LPAD((
		SELECT
		COALESCE(MAX(CAST(SUBSTRING(order_code, 10) AS UNSIGNED)), 0) + 1
		FROM
		orders
		WHERE order_code LIKE CONCAT(DATE_FORMAT(NOW(), '%Y%m%d'), '-%')
		), 6, '0')
		) as orderCode
	</select>

	<!-- [소비자용] 새 주문 생성 -->
	<insert id="createOrder" parameterType="dto.Orders"
		useGeneratedKeys="true" keyProperty="ordersId">
		INSERT INTO orders (
		order_code,
		member_id,
		phone,
		subtotal_amount,
		discount_amount,
		shipping_amount,
		total_amount,
		ship_recipient,
		ship_phone,
		ship_postcode,
		ship_line1,
		ship_line2,
		note,
		using_coupon,
		using_point,
		created_at
		) VALUES (
		#{orderCode},
		#{memberId},
		#{phone},
		#{subtotalAmount},
		#{discountAmount},
		#{shippingAmount},
		#{totalAmount},
		#{shipRecipient},
		#{shipPhone},
		#{shipPostcode},
		#{shipLine1},
		#{shipLine2},
		#{note},
		#{usingCoupon},
		#{usingPoint},
		NOW()
		)
	</insert>

	<!-- [소비자용] 주문 상품 추가 -->
	<insert id="createOrderItem" parameterType="dto.OrderItem"
		useGeneratedKeys="true" keyProperty="orderItemId">
		INSERT INTO order_item (
		order_id,
		brand_id,
		product_id,
		option_id,
		unit_price,
		quantity,
		line_subtotal,
		discount,
		total,
		status
		) VALUES (
		#{orderId},
		#{brandId},
		#{productId},
		#{optionId},
		#{unitPrice},
		#{quantity},
		#{lineSubtotal},
		#{discount},
		#{total},
		'PAID'
		)
	</insert>

	<!-- [소비자용] 주문 조회 (주문 완료 후 확인용...현재로선 필요없지만 남겨둠) -->
	<select id="getOrderById" parameterType="Long"
		resultType="dto.Orders">
		SELECT
		orders_id as ordersId,
		order_code as orderCode,
		member_id as memberId,
		phone,
		subtotal_amount as subtotalAmount,
		discount_amount as discountAmount,
		shipping_amount as shippingAmount,
		total_amount as totalAmount,
		ship_recipient as shipRecipient,
		ship_phone as shipPhone,
		ship_postcode as shipPostcode,
		ship_line1 as
		shipLine1,
		ship_line2 as shipLine2,
		note,
		using_coupon as usingCoupon,
		using_point as usingPoint,
		created_at as createdAt
		FROM orders
		WHERE
		orders_id = #{ordersId}
	</select>

	<!-- [소비자용] 주문 상품 목록 조회 (join with 주문아이템) (기간 필터, 페이징) [orderList용] -->
	<select id="getOrderItemsByMemberWithPeriod" parameterType="map"
		resultType="map">
		SELECT
		o.orders_id as ordersId,
		o.order_code as orderCode,
		o.created_at
		as orderDate,
		oi.order_item_id as orderItemId,
		oi.product_id as
		productId,
		oi.quantity,
		oi.total,
		oi.status,
		oi.tracking_no as trackingNo,
		oi.carrier_name as carrierName,
		oi.updated_at as updatedAt,
		p.name as
		productName,
		b.brand_name as
		brandName,
		po.option_value as optionValue
		FROM orders o
		JOIN order_item
		oi ON o.orders_id = oi.order_id
		JOIN
		product p ON oi.product_id =
		p.product_id
		JOIN brand b ON oi.brand_id =
		b.brand_id
		LEFT JOIN
		product_option po ON oi.option_id =
		po.product_option_id
		WHERE
		o.member_id = #{memberId}
		<if test="startDate != null">
			AND o.created_at &gt;= #{startDate}
		</if>
		<if test="endDate != null">
			AND o.created_at &lt;= #{endDate}
		</if>
		ORDER BY o.created_at DESC, oi.order_item_id ASC
		LIMIT #{limit} OFFSET
		#{offset}
	</select>

	<!-- ======== [소비자용] 회원별 주문 상태 통계 조회 orderStatusCard용 =========== -->
	<select id="getOrderStatusCountByMember" parameterType="Long"
		resultType="map">
		SELECT
		COUNT(*) as orderCount,
		COUNT(CASE WHEN oi.status =
		'PAID' THEN 1 END) as paymentCount,
		COUNT(CASE WHEN oi.status =
		'PREPARING' THEN 1 END) as shippingCount,
		COUNT(CASE WHEN oi.status =
		'SHIPPING' THEN 1 END) as deliveredCount,
		COUNT(CASE WHEN oi.status =
		'DELIVERED' THEN 1 END) as confirmedCount
		FROM orders o
		JOIN order_item
		oi ON o.orders_id = oi.order_id
		WHERE o.member_id = #{memberId}
	</select>

	<!-- =====[소비자] 주문 상품 상세 정보 조회 (상품명, 브랜드명, 옵션명 포함) [orderDetail용]===== -->
	<select id="getOrderItemsWithProductInfo" parameterType="Long"
		resultType="map">
		SELECT
		oi.order_item_id as orderItemId,
		oi.order_id as
		orderId,
		oi.brand_id as brandId,
		oi.product_id as productId,
		oi.option_id as optionId,
		oi.unit_price as unitPrice,
		oi.quantity,
		oi.line_subtotal as lineSubtotal,
		oi.discount,
		oi.total,
		oi.status,
		p.name as productName,
		b.brand_name as brandName,
		po.option_value as
		optionValue
		FROM order_item oi
		LEFT JOIN product p ON oi.product_id =
		p.product_id
		LEFT JOIN brand b ON oi.brand_id = b.brand_id
		LEFT JOIN
		product_option po ON oi.option_id = po.product_option_id
		WHERE
		oi.order_id = #{orderId}
	</select>

	<!-- =====[소비자용] 고객의 주문 상품 총 개수 조회 (페이징용)===== -->
	<select id="getOrderItemCountByMember" parameterType="map"
		resultType="int">
		SELECT COUNT(*)
		FROM orders o
		JOIN order_item oi ON o.orders_id =
		oi.order_id
		WHERE o.member_id = #{memberId}
		<if test="startDate != null">
			AND o.created_at &gt;= #{startDate}
		</if>
		<if test="endDate != null">
			AND o.created_at &lt;= #{endDate}
		</if>
	</select>

	<!-- ========= [소비자용] 취소/교환/반품 통합 목록 조회 ================= -->
	<select id="selectCancelExchangeReturnList" parameterType="map"
		resultType="map">
		SELECT
		oi.order_item_id,
		oi.order_id,
		oi.brand_id,
		oi.product_id,
		oi.option_id,
		oi.unit_price,
		oi.quantity,
		oi.line_subtotal,
		oi.discount,
		oi.total,
		oi.tracking_no,
		oi.carrier_name,
		oi.status,
		oi.created_at,
		oi.updated_at,
		o.orders_id,
		o.order_code,
		b.brand_name,
		p.name,
		po.option_value,

		e.exchange_id,
		e.return_carrier_name AS
		exchange_return_carrier_name,
		e.return_tracking_no AS
		exchange_return_tracking_no,
		e.shipping_carrier_name AS
		exchange_shipping_carrier_name,
		e.shipping_tracking_no AS
		exchange_shipping_tracking_no,
		e.shipping_cost_payer AS
		exchange_cost_payer,

		r.returns_id,
		r.return_carrier_name AS
		return_carrier_name,
		r.return_tracking_no AS return_tracking_no,
		r.shipping_cost_payer AS return_cost_payer

		FROM order_item oi
		INNER JOIN
		orders o ON oi.order_id = o.orders_id
		LEFT
		JOIN brand b ON oi.brand_id =
		b.brand_id
		LEFT JOIN product p ON oi.product_id = p.product_id
		LEFT JOIN
		product_option po ON oi.option_id = po.product_option_id
		LEFT
		JOIN
		exchange e ON oi.order_item_id = e.order_item_id
		LEFT JOIN returns
		r ON
		oi.order_item_id = r.order_item_id
		WHERE o.member_id = #{memberId}
		AND
		oi.status IN (
		'CANCELLED',
		'RETURN_REQUESTED', 'RETURN_APPROVED',
		'COLLECTING', 'RETURN_REFUNDING',
		'RETURN_REJECTED',
		'RETURN_COMPLETED',
		'EXCHANGE_REQUESTED', 'EXCHANGE_APPROVED',
		'EXCHANGE_SHIPPING', 'EXCHANGE_REJECTED',
		'EXCHANGE_COMPLETED'
		)
		<if test="startDate != null and endDate != null">
			AND DATE(oi.updated_at) BETWEEN #{startDate} AND
			#{endDate}
		</if>

		ORDER BY oi.updated_at DESC
	</select>

	<!-- ==== [소비자] 교환/반품 신청용: 주문 상품 단건 조회 === -->
	<select id="getOrderItemForApply" parameterType="Long"
		resultType="map">
		SELECT
		oi.order_item_id as orderItemId,
		oi.order_id as
		orderId,
		oi.brand_id as brandId,
		oi.product_id as productId,
		oi.option_id as optionId,
		oi.unit_price as unitPrice,
		oi.quantity,
		oi.line_subtotal as lineSubtotal,
		oi.discount,
		oi.total,
		oi.status,
		o.order_code as orderCode,
		p.name as productName,
		p.thumbnail_file_id as
		thumbnailFileId,
		p.image1_file_id as image1FileId,
		b.brand_name as
		brandName,
		po.option_value as
		optionValue
		FROM order_item oi
		INNER JOIN
		orders o ON oi.order_id =
		o.orders_id
		LEFT JOIN product p ON
		oi.product_id = p.product_id
		LEFT
		JOIN brand b ON oi.brand_id =
		b.brand_id
		LEFT JOIN product_option po ON
		oi.option_id =
		po.product_option_id
		WHERE oi.order_item_id =
		#{orderItemId}
	</select>

	<!-- ========== [소비자] 주문 상품 상태 업데이트 (orderList의 status부분) ============== -->
	<update id="updateOrderItemStatus" parameterType="map">
		UPDATE
		order_item
		SET status = #{status},
		updated_at = CURRENT_TIMESTAMP
		WHERE
		order_item_id = #{orderItemId}
	</update>

	<!-- ========== [소비자] 주문 아이템의 현재 상태 조회 (취소 가능 여부 확인용) -->
	<select id="getOrderItemStatus" parameterType="long"
		resultType="string">
		SELECT status
		FROM order_item
		WHERE order_item_id =
		#{orderItemId}
	</select>

	<!-- ========== [소비자] 주문 취소 시 order_item 상태만 CANCELLED로 변경 -->
	<update id="cancelOrderItem" parameterType="long">
		UPDATE order_item
		SET
		status = 'CANCELLED',
		updated_at = NOW()
		WHERE order_item_id =
		#{orderItemId}
		AND status IN ('PAID', 'PREPARING')
	</update>


	<!-- ======================= [브랜드 어드민] 교환 목록 조회 ======================= -->
	<select id="selectExchangeOrdersList" parameterType="map"
		resultType="exchangeOrderList">
		SELECT
		MAX(oi.updated_at) AS updated_at,
		o.orders_id,
		o.order_code,
		o.member_id,
		e.exchange_id,
		m.name AS member_name,
		(SELECT p.name
		FROM
		order_item oi2
		JOIN product p ON oi2.product_id = p.product_id
		WHERE
		oi2.order_id =
		o.orders_id
		AND oi2.status LIKE 'EXCHANGE%'
		LIMIT 1) AS
		product_name,
		(SELECT GROUP_CONCAT(DISTINCT p.name SEPARATOR ', ')
		FROM
		order_item
		oi3
		JOIN product p ON oi3.product_id = p.product_id
		WHERE
		oi3.order_id =
		o.orders_id
		AND oi3.status LIKE 'EXCHANGE%') AS
		product_names,
		SUM(oi.total) AS total,
		oi.status AS orderStatus,
		e.return_tracking_no
		AS return_tracking_no,
		e.shipping_tracking_no AS
		shipping_tracking_no
		FROM orders o
		JOIN order_item oi ON o.orders_id =
		oi.order_id
		JOIN
		member m ON o.member_id = m.member_id
		LEFT JOIN exchange
		e ON
		e.order_item_id = oi.order_item_id
		WHERE oi.status LIKE 'EXCHANGE%'
		AND
		oi.brand_id = #{brandId}

		<if
			test="searchType != null and searchKeyword != null and searchKeyword != ''">
			<choose>
				<when test="searchType == 'ORDER'">
					AND o.order_code LIKE CONCAT('%', #{searchKeyword},
					'%')
				</when>
				<when test="searchType == 'MEMBER'">
					AND m.name LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<when test="searchType == 'PRODUCT'">
					AND EXISTS (
					SELECT 1
					FROM order_item oi4
					JOIN product
					p2 ON oi4.product_id = p2.product_id
					WHERE oi4.order_id =
					o.orders_id
					AND oi4.status LIKE 'EXCHANGE%'
					AND p2.name LIKE
					CONCAT('%', #{searchKeyword}, '%')
					)
				</when>
				<when test="searchType == 'TRACKINGNO'">
					AND (e.return_tracking_no LIKE CONCAT('%',
					#{searchKeyword}, '%')
					OR e.shipping_tracking_no LIKE CONCAT('%',
					#{searchKeyword}, '%'))
				</when>
			</choose>
		</if>

		<if test="status != null and status != '' and status != 'ALL'">
			<choose>
				<when test="status == 'REQUESTED'">
					AND oi.status = 'EXCHANGE_REQUESTED'
				</when>
				<when test="status == 'APPROVED'">
					AND oi.status = 'EXCHANGE_APPROVED'
				</when>
				<when test="status == 'SHIPPING'">
					AND oi.status = 'EXCHANGE_SHIPPING'
				</when>
				<when test="status == 'REJECTED'">
					AND oi.status = 'EXCHANGE_REJECTED'
				</when>
				<when test="status == 'COMPLETED'">
					AND oi.status = 'EXCHANGE_COMPLETED'
				</when>
			</choose>
		</if>

		<if test="startDate != null and startDate != ''">
			AND oi.updated_at &gt;= #{startDate}
		</if>
		<if test="endDate != null and endDate != ''">
			AND oi.updated_at &lt;= #{endDate}
		</if>

		GROUP BY o.orders_id, o.order_code, o.member_id, m.name,
		e.return_tracking_no, e.shipping_tracking_no

		<if test="sortField != null and sortField != ''">
			ORDER BY ${sortField}
			<if test="sortOrder == 'desc'">DESC</if>
			<if test="sortOrder == 'asc'">ASC</if>
		</if>

		LIMIT #{limit} OFFSET #{offset}
	</select>


	<!-- ======================= [브랜드 어드민] 교환 개수 조회 ======================= -->
	<select id="selectExchangeOrdersCount" parameterType="map"
		resultType="int">
		SELECT COUNT(DISTINCT o.orders_id)
		FROM orders o
		JOIN order_item oi ON
		o.orders_id = oi.order_id
		JOIN member m ON o.member_id = m.member_id
		LEFT JOIN exchange e ON e.order_item_id = oi.order_item_id
		WHERE
		oi.status LIKE 'EXCHANGE%'
		AND oi.brand_id = #{brandId}

		<if
			test="searchType != null and searchKeyword != null and searchKeyword != ''">
			<choose>
				<when test="searchType == 'ORDER'">
					AND o.order_code LIKE CONCAT('%', #{searchKeyword},
					'%')
				</when>
				<when test="searchType == 'MEMBER'">
					AND m.name LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<when test="searchType == 'PRODUCT'">
					AND EXISTS (
					SELECT 1
					FROM order_item oi4
					JOIN product
					p2 ON oi4.product_id = p2.product_id
					WHERE oi4.order_id =
					o.orders_id
					AND oi4.status LIKE 'EXCHANGE%'
					AND p2.name LIKE
					CONCAT('%', #{searchKeyword}, '%')
					)
				</when>
				<when test="searchType == 'TRACKINGNO'">
					AND (e.return_tracking_no LIKE CONCAT('%',
					#{searchKeyword}, '%')
					OR e.shipping_tracking_no LIKE CONCAT('%',
					#{searchKeyword}, '%'))
				</when>
			</choose>
		</if>

		<if test="status != null and status != '' and status != 'ALL'">
			<choose>
				<when test="status == 'REQUESTED'">
					AND oi.status = 'EXCHANGE_REQUESTED'
				</when>
				<when test="status == 'APPROVED'">
					AND oi.status = 'EXCHANGE_APPROVED'
				</when>
				<when test="status == 'SHIPPING'">
					AND oi.status = 'EXCHANGE_SHIPPING'
				</when>
				<when test="status == 'REJECTED'">
					AND oi.status = 'EXCHANGE_REJECTED'
				</when>
				<when test="status == 'COMPLETED'">
					AND oi.status = 'EXCHANGE_COMPLETED'
				</when>
			</choose>
		</if>

		<if test="startDate != null and startDate != ''">
			AND oi.updated_at &gt;= #{startDate}
		</if>
		<if test="endDate != null and endDate != ''">
			AND oi.updated_at &lt;= #{endDate}
		</if>
	</select>

	<!-- ======================= [브랜드 어드민] 교환 상세 조회 ======================= -->
	<select id="selectExchangeDetailForBrand" parameterType="map"
		resultType="exchangeDetail">
		SELECT
		o.orders_id AS orderId,
		o.order_code,
		e.updated_at AS
		exchange_request_date,
		oi.status AS exchange_status,
		e.shipping_cost_payer,
		e.shipping_cost,
		CONCAT(e.return_carrier_name, '
		', e.return_tracking_no) AS return_invoice,
		CONCAT(e.shipping_carrier_name, ' ', e.shipping_tracking_no) AS
		exchange_invoice,

		p.name AS product_name,
		po.option_value AS
		original_option_name,
		oi.quantity,
		e.reason,

		po2.option_value AS
		desired_option_name,

		e.image1_file_id,
		e.image2_file_id,
		e.image3_file_id,
		e.exchange_id,

		CASE
		WHEN po2.stock_qty &gt;= 0 THEN
		'재고없음'
		ELSE '재고있음'
		END AS stock_status,

		e.rejection_reason

		FROM exchange e
		JOIN orders o ON
		e.order_id = o.orders_id
		JOIN order_item oi ON
		e.order_item_id =
		oi.order_item_id
		JOIN product p ON oi.product_id =
		p.product_id
		LEFT
		JOIN product_option po ON oi.option_id =
		po.product_option_id
		LEFT JOIN
		product_option po2 ON e.product_option_id
		=
		po2.product_option_id
		WHERE
		e.exchange_id = #{exchangeId}
		LIMIT 1
	</select>

	<!-- ======================= [브랜드 어드민] 교환 거절 처리 ======================= -->
	<update id="updateExchangeRejection" parameterType="map">
		UPDATE
		exchange e
		JOIN order_item oi ON
		e.order_item_id = oi.order_item_id
		SET
		e.rejection_reason =
		#{rejectionReason},
		oi.status =
		'EXCHANGE_REJECTED',
		e.updated_at =
		NOW(),
		oi.updated_at =
		NOW()
		WHERE
		e.exchange_id = #{exchangeId}
	</update>

	<!-- ======================= [브랜드 어드민] 교환 승인 처리 ======================= -->
	<update id="updateExchangeApprove" parameterType="map">
		UPDATE exchange
		e
		JOIN order_item oi ON
		e.order_item_id = oi.order_item_id
		SET
		e.return_carrier_name = 'CJ대한통운',
		e.return_tracking_no =
		LPAD(FLOOR(RAND() * 1000000000), 10, '0'),
		oi.status =
		'EXCHANGE_APPROVED',
		e.updated_at = NOW()
		WHERE e.exchange_id =
		#{exchangeId}
	</update>

	<!-- ======================= [브랜드 어드민] 교환 배송 처리 ======================= -->
	<update id="updateExchangeShipping" parameterType="map">
		UPDATE
		exchange e
		JOIN order_item oi ON
		e.order_item_id = oi.order_item_id
		SET
		e.shipping_carrier_name =
		'CJ대한통운',
		e.shipping_tracking_no =
		#{shippingTrackingNo},
		oi.status =
		'EXCHANGE_SHIPPING',
		e.updated_at =
		NOW()
		WHERE e.exchange_id =
		#{exchangeId}
	</update>

	<!-- ======================= [브랜드 어드민] 교환 자동 완료 ======================= -->
	<update id="updateExchangeCompleted" parameterType="map">
		UPDATE
		exchange e
		JOIN order_item oi ON
		e.order_item_id = oi.order_item_id
		SET
		oi.status =
		'EXCHANGE_COMPLETED',
		e.updated_at = NOW()
		WHERE
		e.exchange_id =
		#{exchangeId}
		AND oi.status = 'EXCHANGE_SHIPPING'
	</update>




	<!-- ======================= [브랜드 어드민] 반품 목록 조회 ======================= -->
	<select id="selectReturnedOrdersList" parameterType="map"
		resultType="returnOrderList">
		SELECT
		MAX(oi.updated_at) AS updated_at,
		o.orders_id,
		o.order_code,
		o.member_id,
		r.returns_id AS returnId,
		m.name AS member_name,
		(SELECT
		p.name
		FROM order_item oi2
		JOIN product p ON oi2.product_id =
		p.product_id
		WHERE oi2.order_id =
		o.orders_id
		AND oi2.status LIKE
		'RETURN%'
		LIMIT 1) AS product_name,
		(SELECT GROUP_CONCAT(DISTINCT p.name
		SEPARATOR ',
		')
		FROM order_item oi3
		JOIN product p ON oi3.product_id =
		p.product_id
		WHERE oi3.order_id =
		o.orders_id
		AND oi3.status LIKE
		'RETURN%') AS product_names,
		SUM(oi.total) AS total,
		oi.status AS
		orderStatus,
		r.return_tracking_no
		AS
		return_tracking_no
		FROM orders o
		JOIN
		order_item oi ON o.orders_id =
		oi.order_id
		JOIN member m ON o.member_id
		= m.member_id
		LEFT JOIN returns
		r ON r.order_item_id = oi.order_item_id
		WHERE oi.status LIKE 'RETURN%'
		AND oi.brand_id = #{brandId}

		<if
			test="searchType != null and searchKeyword != null and searchKeyword != ''">
			<choose>
				<when test="searchType == 'MEMBER'">
					AND m.name LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<when test="searchType == 'PRODUCT'">
					AND EXISTS (
					SELECT 1
					FROM order_item oi4
					JOIN product
					p2 ON
					oi4.product_id = p2.product_id
					WHERE oi4.order_id = o.orders_id
					AND
					oi4.status LIKE 'RETURN%'
					AND p2.name LIKE CONCAT('%',
					#{searchKeyword}, '%')
					)
				</when>
				<when test="searchType == 'ORDER'">
					AND o.order_code LIKE CONCAT('%', #{searchKeyword},
					'%')
				</when>
				<when test="searchType == 'TRACKINGNO'">
					AND r.return_tracking_no LIKE CONCAT('%',
					#{searchKeyword}, '%')
				</when>
			</choose>
		</if>

		<if test="status != null and status != '' and status != 'ALL'">
			<choose>
				<when test="status == 'REQUESTED'">
					AND oi.status = 'RETURN_REQUESTED'
				</when>
				<when test="status == 'APPROVED'">
					AND oi.status = 'RETURN_APPROVED'
				</when>
				<when test="status == 'REFUNDING'">
					AND oi.status = 'RETURN_REFUNDING'
				</when>
				<when test="status == 'REJECTED'">
					AND oi.status = 'RETURN_REJECTED'
				</when>
				<when test="status == 'COMPLETED'">
					AND oi.status = 'RETURN_COMPLETED'
				</when>
			</choose>
		</if>

		<if test="startDate != null and startDate != ''">
			AND oi.updated_at &gt;= #{startDate}
		</if>
		<if test="endDate != null and endDate != ''">
			AND oi.updated_at &lt;= #{endDate}
		</if>

		GROUP BY o.orders_id, o.order_code, o.member_id, m.name,
		r.return_tracking_no

		<if test="sortField != null and sortField != ''">
			ORDER BY ${sortField}
			<if test="sortOrder == 'desc'">DESC</if>
			<if test="sortOrder == 'asc'">ASC</if>
		</if>

		LIMIT #{limit} OFFSET #{offset}
	</select>

	<!-- ======================= [브랜드 어드민] 반품 개수 조회 ======================= -->
	<select id="selectReturnedOrdersCount" parameterType="map"
		resultType="Integer">
		SELECT COUNT(DISTINCT o.orders_id)
		FROM orders o
		JOIN order_item oi ON
		o.orders_id = oi.order_id
		JOIN member m ON o.member_id = m.member_id
		LEFT JOIN returns r ON r.order_item_id = oi.order_item_id
		WHERE
		oi.status LIKE 'RETURN%'
		AND oi.brand_id = #{brandId}

		<if
			test="searchType != null and searchKeyword != null and searchKeyword != ''">
			<choose>
				<when test="searchType == 'MEMBER'">
					AND m.name LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<when test="searchType == 'PRODUCT'">
					AND EXISTS (
					SELECT 1
					FROM order_item oi4
					JOIN product
					p2 ON
					oi4.product_id = p2.product_id
					WHERE oi4.order_id = o.orders_id
					AND
					oi4.status LIKE 'RETURN%'
					AND p2.name LIKE CONCAT('%',
					#{searchKeyword}, '%')
					)
				</when>
				<when test="searchType == 'ORDER'">
					AND o.order_code LIKE CONCAT('%', #{searchKeyword},
					'%')
				</when>
				<when test="searchType == 'TRACKINGNO'">
					AND r.return_tracking_no LIKE CONCAT('%',
					#{searchKeyword}, '%')
				</when>
			</choose>
		</if>

		<if test="status != null and status != '' and status != 'ALL'">
			<choose>
				<when test="status == 'REQUESTED'">
					AND oi.status = 'RETURN_REQUESTED'
				</when>
				<when test="status == 'APPROVED'">
					AND oi.status = 'RETURN_APPROVED'
				</when>
				<when test="status == 'REFUNDING'">
					AND oi.status = 'RETURN_REFUNDING'
				</when>
				<when test="status == 'REJECTED'">
					AND oi.status = 'RETURN_REJECTED'
				</when>
				<when test="status == 'COMPLETED'">
					AND oi.status = 'RETURN_COMPLETED'
				</when>
			</choose>
		</if>

		<if test="startDate != null and startDate != ''">
			AND oi.updated_at &gt;= #{startDate}
		</if>
		<if test="endDate != null and endDate != ''">
			AND oi.updated_at &lt;= #{endDate}
		</if>
	</select>

	<!-- ======================= [브랜드 어드민] 반품 요약 조회 ======================= -->
	<select id="selectReturnSummaryForBrand" parameterType="long"
		resultType="returnSummary">
		SELECT
		r.returns_id AS returnId,
		r.member_id AS memberId,
		m.name AS memberName,
		o.orders_id AS orderId,
		o.order_code AS orderCode,
		o.total_amount AS
		totalAmount,
		o.using_point AS usingPoint,
		c.amount AS
		couponAmount,
		CONCAT(
		FORMAT(c.amount_condition, 0), '원 이상 구매 시 ',
		FORMAT(c.amount,
		0), '원 할인'
		) AS couponName,
		COALESCE(SUM(oi.total), 0)
		AS
		cancelledTotal,

		CASE
		WHEN (o.total_amount - COALESCE(SUM(oi.total),
		0))
		> c.amount_condition
		THEN COALESCE(SUM(oi.total), 0) - c.amount
		ELSE
		COALESCE(SUM(oi.total), 0)
		END AS actualCancelAmount,

		r.reason AS
		reason,
		r.shipping_cost AS shippingCost,
		r.shipping_cost_payer AS
		shippingCostPayer,
		CONCAT(r.return_carrier_name, ' ',
		r.return_tracking_no)
		AS returnInvoice,
		r.rejection_reason AS
		rejectionReason,
		r.image1_file_id AS
		image1FileId,
		r.image2_file_id AS
		image2FileId,
		r.image3_file_id AS
		image3FileId,
		r.updated_at AS
		updatedAt,
		r.updated_at AS
		returnRequestDate,
		oi.status AS returnStatus,
		r.rejection_reason AS
		rejectionReason
		FROM returns r
		JOIN order_item oi
		ON r.order_item_id =
		oi.order_item_id
		JOIN orders o ON oi.order_id =
		o.orders_id
		JOIN member
		m ON r.member_id = m.member_id
		LEFT JOIN
		member_coupon mc ON
		o.using_coupon = mc.member_coupon_id
		LEFT JOIN
		coupon c ON mc.coupon_id
		= c.coupon_id
		WHERE r.returns_id = #{value}
		GROUP BY
		r.returns_id,
		r.member_id, m.name, o.order_code,
		o.total_amount, o.using_point,
		c.amount, c.amount_condition,
		r.reason,
		r.shipping_cost,
		r.shipping_cost_payer,
		r.return_carrier_name,
		r.return_tracking_no,
		r.image1_file_id, r.image2_file_id,
		r.image3_file_id,
		oi.status,
		r.rejection_reason, r.updated_at
	</select>

	<!-- ======================= [브랜드 어드민] 반품 상품 상세 조회 ======================= -->
	<select id="selectReturnItemsForBrand" parameterType="long"
		resultType="returnItemDetail">
		SELECT
		oi.order_item_id AS orderItemId,
		p.product_id AS
		productId,
		p.name AS productName,
		po.option_value AS optionName,
		oi.quantity AS quantity,
		oi.total AS total
		FROM returns r
		JOIN
		order_item
		oi ON r.order_item_id = oi.order_item_id
		JOIN product p ON
		oi.product_id = p.product_id
		LEFT JOIN product_option po ON
		oi.option_id = po.product_option_id
		WHERE r.returns_id = #{value}
		ORDER
		BY oi.updated_at DESC
	</select>

	<!-- ======================= [브랜드 어드민] 반품 상태 변경 ======================= -->
	<update id="updateReturnStatus" parameterType="map">
		UPDATE returns r
		JOIN order_item oi ON r.order_item_id = oi.order_item_id
		SET
		oi.status=#{status},
		r.updated_at = NOW(),
		oi.updated_at = NOW()
		WHERE
		r.returns_id =
		#{returnId}
	</update>

	<!-- ======================= [브랜드 어드민] 반품 거절 처리 ======================= -->
	<update id="updateReturnRejection" parameterType="map">
		UPDATE returns
		r
		JOIN order_item oi ON r.order_item_id = oi.order_item_id
		SET
		r.rejection_reason = #{reason},
		oi.status = 'RETURN_REJECTED',
		r.updated_at = NOW(),
		oi.updated_at = NOW()
		WHERE r.returns_id =
		#{returnId}
	</update>

	<!-- ======================= [브랜드 어드민] 반품 송장 업데이트 ======================= -->
	<update id="updateReturnTrackingNo">
		UPDATE returns
		SET
		return_carrier_name = 'CJ대한통운',
		return_tracking_no =
		LPAD(FLOOR(RAND() * 1000000000), 10,
		'0'),
		updated_at = NOW()
		WHERE returns_id = #{returnId}
	</update>

	<!-- ======================= [브랜드 어드민] 자동 반품 완료 ======================= -->
	<update id="autoCompleteReturn" parameterType="map">
		UPDATE returns r
		JOIN order_item oi ON r.order_item_id = oi.order_item_id
		SET
		oi.status='RETURN_COMPLETED',
		r.updated_at = NOW(),
		oi.updated_at =
		NOW()
		WHERE r.returns_id=#{returnId}
		AND oi.status = 'RETURN_REFUNDING'
	</update>




	<!-- ======================= [브랜드 어드민] 주문 취소 목록 조회 ======================= -->
	<select id="selectCancelledOrdersList" parameterType="map"
		resultType="cancelOrderList">
		SELECT
		MAX(oi.updated_at) AS updated_at,
		o.orders_id,
		o.order_code,
		o.member_id,
		m.name AS
		member_name,
		(SELECT p.name
		FROM order_item oi2
		JOIN product p ON oi2.product_id = p.product_id
		WHERE oi2.order_id =
		o.orders_id
		AND oi2.status = 'CANCELLED'
		LIMIT 1) AS product_name,
		(SELECT GROUP_CONCAT(DISTINCT p.name SEPARATOR ',
		')
		FROM order_item oi3
		JOIN product p ON oi3.product_id = p.product_id
		WHERE oi3.order_id =
		o.orders_id
		AND oi3.status = 'CANCELLED') AS product_names,
		SUM(oi.total) AS total,
		'CANCELLED' AS status
		FROM orders o
		JOIN
		order_item oi ON o.orders_id = oi.order_id
		JOIN member m ON o.member_id
		= m.member_id
		WHERE oi.status = 'CANCELLED'
		AND oi.brand_id = #{brandId}

		<!-- 검색 조건 -->
		<if
			test="searchType != null and searchKeyword != null and searchKeyword != ''">
			<choose>
				<when test="searchType == 'MEMBER'">
					AND m.name LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<when test="searchType == 'PRODUCT'">
					AND EXISTS (
					SELECT 1
					FROM order_item oi4
					JOIN product
					p2 ON
					oi4.product_id = p2.product_id
					WHERE oi4.order_id = o.orders_id
					AND
					oi4.status = 'CANCELLED'
					AND p2.name LIKE CONCAT('%',
					#{searchKeyword}, '%')
					)
				</when>
				<when test="searchType == 'ORDER'">
					AND o.order_code LIKE CONCAT('%', #{searchKeyword},
					'%')
				</when>
			</choose>
		</if>

		<!-- 기간 필터 -->
		<if test="startDate != null and startDate != ''">
			AND oi.updated_at &gt;= #{startDate}
		</if>
		<if test="endDate != null and endDate != ''">
			AND oi.updated_at &lt;= #{endDate}
		</if>

		GROUP BY o.orders_id, o.order_code, o.member_id, m.name

		<if test="sortField != null and sortField != ''">
			ORDER BY ${sortField}
			<if test="sortOrder == 'desc'">DESC</if>
			<if test="sortOrder == 'asc'">ASC</if>
		</if>

		LIMIT #{limit} OFFSET #{offset}
	</select>

	<!-- ======================= [브랜드 어드민] 주문 취소 개수 조회 ======================= -->
	<select id="selectCancelledOrdersCount" parameterType="map"
		resultType="Integer">
		SELECT COUNT(DISTINCT o.orders_id)
		FROM orders o
		JOIN order_item oi ON
		o.orders_id = oi.order_id
		JOIN member m ON o.member_id = m.member_id
		WHERE oi.status = 'CANCELLED'
		AND oi.brand_id = #{brandId}

		<if
			test="searchType != null and searchKeyword != null and searchKeyword != ''">
			<choose>
				<when test="searchType == 'MEMBER'">
					AND m.name LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<when test="searchType == 'PRODUCT'">
					AND EXISTS (
					SELECT 1
					FROM order_item oi4
					JOIN product
					p2 ON
					oi4.product_id = p2.product_id
					WHERE oi4.order_id = o.orders_id
					AND
					oi4.status = 'CANCELLED'
					AND p2.name LIKE CONCAT('%',
					#{searchKeyword}, '%')
					)
				</when>
				<when test="searchType == 'ORDER'">
					AND o.order_code LIKE CONCAT('%', #{searchKeyword},
					'%')
				</when>
			</choose>
		</if>

		<if test="startDate != null and startDate != ''">
			AND oi.updated_at &gt;= #{startDate}
		</if>
		<if test="endDate != null and endDate != ''">
			AND oi.updated_at &lt;= #{endDate}
		</if>
	</select>

	<!-- ======================= [브랜드 어드민] 주문 취소 요약 조회 ======================= -->
	<select id="selectCancelledOrderSummaryForBrand"
		parameterType="map" resultType="cancelOrderSummary">
		SELECT
		o.order_code,
		o.orders_id AS
		orderId,
		o.total_amount AS
		total_amount,
		o.using_point AS using_point,
		c.amount AS coupon_amount,
		CONCAT(
		FORMAT(c.amount_condition, 0), '원 이상
		구매 시 ',
		FORMAT(c.amount, 0), '원 할인'
		) AS coupon_name,
		COALESCE(SUM(oi.total), 0) AS cancelled_total,

		CASE
		WHEN
		(o.total_amount
		- COALESCE(SUM(oi.total), 0)) &gt;
		c.amount_condition
		THEN
		COALESCE(SUM(oi.total), 0) - c.amount
		ELSE
		COALESCE(SUM(oi.total),
		0)
		END
		AS actual_cancel_amount

		FROM orders o
		JOIN
		order_item oi ON
		o.orders_id =
		oi.order_id
		LEFT JOIN member_coupon mc ON
		o.using_coupon
		=
		mc.member_coupon_id
		LEFT JOIN coupon c ON mc.coupon_id
		= c.coupon_id
		WHERE oi.order_id = #{orderId}
		AND oi.status = 'CANCELLED'
		GROUP BY
		o.orders_id, o.order_code, o.total_amount, o.using_point,
		c.amount,
		c.amount_condition
	</select>

	<!-- ======================= [브랜드 어드민] 주문 취소 상품 상세 조회 ======================= -->
	<select id="selectCancelledOrderItemsForBrand"
		parameterType="map" resultType="cancelOrderItemDetail">
		SELECT
		o.order_code,
		oi.updated_at AS
		cancelled_date,
		'CANCELLED' AS status,
		p.name AS product_name,
		po.option_value AS option_name,
		oi.quantity,
		oi.total AS
		cancelled_amount
		FROM order_item oi
		JOIN orders o ON oi.order_id =
		o.orders_id
		JOIN product p ON oi.product_id = p.product_id
		LEFT JOIN
		product_option po ON oi.option_id = po.product_option_id
		WHERE
		oi.order_id = #{orderId}
		AND oi.status = 'CANCELLED'
		ORDER BY
		oi.updated_at DESC
	</select>





	<!-- ======================= [브랜드 어드민] 주문 목록 조회 ======================= -->
	<select id="selectOrdersListForBrand" parameterType="map"
		resultType="ordersList">
		SELECT DISTINCT
		o.orders_id,
		o.order_code,
		o.member_id,
		m.name AS
		member_name,
		o.total_amount,
		o.created_at,
		(SELECT p.name
		FROM order_item
		oi2
		JOIN
		product p ON oi2.product_id = p.product_id
		WHERE oi2.order_id =
		o.orders_id
		AND oi2.brand_id = #{brandId}
		LIMIT 1) AS product_name,
		(SELECT GROUP_CONCAT(DISTINCT p.name SEPARATOR ', ')
		FROM order_item
		oi2
		JOIN product p ON oi2.product_id = p.product_id
		WHERE oi2.order_id =
		o.orders_id
		AND oi2.brand_id = #{brandId}
		) AS product_names,
		COALESCE(
		(SELECT oi2.status
		FROM order_item oi2
		WHERE oi2.order_id = o.orders_id
		AND oi2.brand_id = #{brandId}
		AND oi2.status IN
		('PAID','PREPARING','SHIPPING','DELIVERED','CONFIRMED')
		ORDER BY CASE
		oi2.status
		WHEN 'PAID' THEN 1
		WHEN 'PREPARING' THEN 2
		WHEN 'SHIPPING'
		THEN 3
		WHEN 'DELIVERED' THEN 4
		WHEN 'CONFIRMED' THEN 5
		END
		LIMIT 1),
		(SELECT oi3.status
		FROM order_item oi3
		WHERE oi3.order_id = o.orders_id
		AND oi3.brand_id = #{brandId}
		LIMIT 1)
		) AS orderStatus,
		CASE
		WHEN EXISTS
		(SELECT 1 FROM order_item oi2
		WHERE oi2.order_id = o.orders_id
		AND
		oi2.brand_id = #{brandId}
		AND oi2.status = 'CANCELLED')
		THEN 1 ELSE 0
		END AS has_cancelled_item,
		CASE
		WHEN EXISTS (SELECT 1 FROM order_item
		oi3
		WHERE oi3.order_id = o.orders_id
		AND oi3.brand_id = #{brandId}
		AND
		oi3.status LIKE 'RETURN%')
		THEN 1 ELSE 0 END AS has_return_item,
		CASE
		WHEN EXISTS (SELECT 1 FROM order_item oi4
		WHERE oi4.order_id =
		o.orders_id
		AND oi4.brand_id = #{brandId}
		AND oi4.status LIKE
		'EXCHANGE%')
		THEN 1 ELSE 0 END AS has_exchange_item
		FROM orders o
		JOIN
		order_item oi ON o.orders_id = oi.order_id
		JOIN member m ON o.member_id
		= m.member_id
		<where>
			oi.brand_id = #{brandId}

			<!-- 검색 필터 -->
			<if
				test="searchType != null and searchKeyword != null and searchKeyword != ''">
				<choose>
					<when test="searchType == 'MEMBER'">
						AND m.name LIKE CONCAT('%', #{searchKeyword}, '%')
					</when>
					<when test="searchType == 'PRODUCT'">
						AND EXISTS (
						SELECT 1
						FROM order_item oi5
						JOIN product
						p2 ON oi5.product_id = p2.product_id
						WHERE oi5.order_id =
						o.orders_id
						AND oi5.brand_id = #{brandId}
						AND p2.name LIKE
						CONCAT('%', #{searchKeyword}, '%')
						)
					</when>
				</choose>
			</if>

			<!-- 주문 상태 필터 -->
			<if test="status != null and status != '' and status != 'ALL'">
				<choose>
					<when test="status == 'EXCHANGE'">
						AND EXISTS (
						SELECT 1 FROM order_item oi6
						WHERE
						oi6.order_id = o.orders_id
						AND oi6.brand_id = #{brandId}
						AND
						oi6.status LIKE 'EXCHANGE%'
						)
					</when>
					<when test="status == 'RETURN'">
						AND EXISTS (
						SELECT 1 FROM order_item oi7
						WHERE
						oi7.order_id = o.orders_id
						AND oi7.brand_id = #{brandId}
						AND
						oi7.status LIKE 'RETURN%'
						)
					</when>
					<otherwise>
						AND EXISTS (
						SELECT 1 FROM order_item oi8
						WHERE
						oi8.order_id = o.orders_id
						AND oi8.brand_id = #{brandId}
						AND
						oi8.status = #{status}
						)
					</otherwise>
				</choose>
			</if>

			<!-- 기간 필터 -->
			<if test="startDate != null and startDate != ''">
				AND o.created_at &gt;= #{startDate}
			</if>
			<if test="endDate != null and endDate != ''">
				AND o.created_at &lt;= #{endDate}
			</if>
		</where>

		<if test="sortField != null and sortField != ''">
			ORDER BY ${sortField}
			<if test="sortOrder == 'desc'">DESC</if>
			<if test="sortOrder == 'asc'">ASC</if>
		</if>

		LIMIT #{limit} OFFSET #{offset}
	</select>

	<!-- ======================= [브랜드 어드민] 주문 개수 조회 ======================= -->
	<select id="selectOrdersCountForBrand" parameterType="map"
		resultType="Integer">
		SELECT COUNT(DISTINCT o.orders_id)
		FROM orders o
		JOIN order_item oi ON
		o.orders_id = oi.order_id
		JOIN member m ON o.member_id = m.member_id
		<where>
			oi.brand_id = #{brandId}

			<!-- 검색 필터 -->
			<if
				test="searchType != null and searchKeyword != null and searchKeyword != ''">
				<choose>
					<when test="searchType == 'MEMBER'">
						AND m.name LIKE CONCAT('%', #{searchKeyword}, '%')
					</when>
					<when test="searchType == 'PRODUCT'">
						AND EXISTS (
						SELECT 1
						FROM order_item oi5
						JOIN product
						p2 ON oi5.product_id = p2.product_id
						WHERE oi5.order_id =
						o.orders_id
						AND oi5.brand_id = #{brandId}
						AND p2.name LIKE
						CONCAT('%', #{searchKeyword}, '%')
						)
					</when>
				</choose>
			</if>

			<!-- 주문 상태 필터 -->
			<if test="status != null and status != '' and status != 'ALL'">
				<choose>
					<when test="status == 'EXCHANGE'">
						AND EXISTS (
						SELECT 1 FROM order_item oi6
						WHERE
						oi6.order_id = o.orders_id
						AND oi6.brand_id = #{brandId}
						AND
						oi6.status LIKE 'EXCHANGE%'
						)
					</when>
					<when test="status == 'RETURN'">
						AND EXISTS (
						SELECT 1 FROM order_item oi7
						WHERE
						oi7.order_id = o.orders_id
						AND oi7.brand_id = #{brandId}
						AND
						oi7.status LIKE 'RETURN%'
						)
					</when>
					<otherwise>
						AND EXISTS (
						SELECT 1 FROM order_item oi8
						WHERE
						oi8.order_id = o.orders_id
						AND oi8.brand_id = #{brandId}
						AND
						oi8.status = #{status}
						)
					</otherwise>
				</choose>
			</if>

			<!-- 기간 필터 -->
			<if test="startDate != null and startDate != ''">
				AND o.created_at &gt;= #{startDate}
			</if>
			<if test="endDate != null and endDate != ''">
				AND o.created_at &lt;= #{endDate}
			</if>
		</where>
	</select>

	<!-- ======================= [브랜드 어드민] 주문 요약 조회 ======================= -->
	<select id="selectOrderSummaryForBrand"
		resultType="ordersSummary">
		SELECT
		o.orders_id,
		o.order_code,
		o.created_at,
		o.using_point,
		COALESCE(
		(SELECT oi2.status
		FROM order_item oi2
		WHERE oi2.order_id =
		o.orders_id
		AND oi2.brand_id =
		#{brandId}
		AND oi2.status IN
		('PAID','PREPARING','SHIPPING','DELIVERED','CONFIRMED')
		ORDER BY CASE
		oi2.status
		WHEN 'PAID' THEN 1
		WHEN 'PREPARING' THEN 2
		WHEN 'SHIPPING'
		THEN 3
		WHEN 'DELIVERED' THEN 4
		WHEN 'CONFIRMED' THEN 5
		END
		LIMIT 1),
		(SELECT oi3.status
		FROM order_item oi3
		WHERE oi3.order_id = o.orders_id
		AND oi3.brand_id = #{brandId}
		LIMIT 1)
		) AS orderStatus,
		oi.tracking_no,
		oi.carrier_name,
		o.subtotal_amount,
		o.discount_amount,
		o.shipping_amount,
		o.total_amount,
		o.ship_recipient,
		o.ship_phone,
		o.ship_postcode,
		o.ship_line1,
		o.ship_line2,
		o.note,
		m.email AS
		member_email,
		m.name AS member_name,
		m.phone AS member_phone
		FROM orders
		o
		JOIN order_item oi ON o.orders_id = oi.order_id
		JOIN member m ON
		o.member_id = m.member_id
		WHERE oi.brand_id = #{brandId}
		AND o.orders_id
		= #{orderId}
		LIMIT 1
	</select>

	<!-- ======================= [브랜드 어드민] 주문 상품 상세 조회 ======================= -->
	<select id="selectOrderItemsForBrand"
		resultType="ordersItemDetail">
		SELECT
		oi.order_item_id,
		oi.product_id,
		oi.option_id,
		oi.quantity,
		oi.total,
		oi.status AS item_status,
		p.name AS product_name,
		po.option_value AS
		option_name,
		ex.exchange_id AS exchangeId,
		rt.returns_id AS returnId

		FROM order_item oi
		JOIN product p
		ON oi.product_id = p.product_id
		LEFT JOIN product_option po
		ON oi.option_id = po.product_option_id
		LEFT JOIN exchange ex
		ON oi.order_item_id = ex.order_item_id
		LEFT JOIN returns rt
		ON oi.order_item_id = rt.order_item_id

		WHERE oi.brand_id = #{brandId}
		AND oi.order_id = #{orderId}

		ORDER BY oi.order_item_id ASC
	</select>

	<!-- ======================= [brand2] 대시보드 ======================= -->
	<!-- 오늘 매출 & 판매 수량 -->
	<select id="selectSalesToday"
		resultType="dto.brand2.OrdersDashboard">
		SELECT
		(
		SELECT COALESCE(SUM(o.total_amount), 0)
		FROM orders o
		WHERE DATE(o.created_at) = CURDATE()
		AND EXISTS (
		SELECT 1 FROM
		order_item oi
		WHERE oi.order_id = o.orders_id
		AND oi.status = 'PAID'
		AND
		oi.brand_id = #{brandId}
		)
		) AS salesToday,
		(
		SELECT
		COALESCE(SUM(oi.quantity), 0)
		FROM order_item oi
		JOIN orders o2 ON
		o2.orders_id = oi.order_id
		WHERE DATE(o2.created_at) = CURDATE()
		AND
		oi.status = 'PAID'
		AND oi.brand_id = #{brandId}
		) AS productCountToday
	</select>

	<!-- 어제 매출 & 판매 수량 -->
	<select id="selectSalesYesterday"
		resultType="dto.brand2.OrdersDashboard">
		SELECT
		(
		SELECT COALESCE(SUM(o.total_amount), 0)
		FROM orders o
		WHERE DATE(o.created_at) = CURDATE() - INTERVAL 1 DAY
		AND EXISTS (
		SELECT 1 FROM order_item oi
		WHERE oi.order_id = o.orders_id
		AND
		oi.status = 'PAID'
		AND oi.brand_id = #{brandId}
		)
		) AS salesYesterday,
		(
		SELECT COALESCE(SUM(oi.quantity), 0)
		FROM order_item oi
		JOIN orders o2
		ON o2.orders_id = oi.order_id
		WHERE DATE(o2.created_at) = CURDATE() -
		INTERVAL 1 DAY
		AND oi.status = 'PAID'
		AND oi.brand_id = #{brandId}
		) AS
		productCountYesterday
	</select>

	<!-- 이번 주 매출 & 판매 수량 -->
	<select id="selectSalesWeek"
		resultType="dto.brand2.OrdersDashboard">
		SELECT
		(
		SELECT COALESCE(SUM(o.total_amount), 0)
		FROM orders o
		WHERE YEARWEEK(o.created_at, 1) = YEARWEEK(CURDATE(), 1)
		AND EXISTS (
		SELECT 1 FROM order_item oi
		WHERE oi.order_id = o.orders_id
		AND
		oi.status = 'PAID'
		AND oi.brand_id = #{brandId}
		)
		) AS salesWeek,
		(
		SELECT
		COALESCE(SUM(oi.quantity), 0)
		FROM order_item oi
		JOIN orders o2 ON
		o2.orders_id = oi.order_id
		WHERE YEARWEEK(o2.created_at, 1) =
		YEARWEEK(CURDATE(), 1)
		AND oi.status = 'PAID'
		AND oi.brand_id =
		#{brandId}
		) AS productCountWeek
	</select>

	<!-- 최근 30일 매출 (일자별 합계) -->
	<select id="selectSalesLast30Days"
		resultType="dto.brand2.OrdersDashboard">
		SELECT
		DATE(o.created_at) AS orderDate,
		COALESCE(SUM(o.total_amount), 0) AS dailySales
		FROM orders o
		WHERE
		o.created_at >= CURDATE() - INTERVAL 30 DAY
		AND EXISTS (
		SELECT 1 FROM
		order_item oi
		WHERE oi.order_id = o.orders_id
		AND oi.status = 'PAID'
		AND
		oi.brand_id = #{brandId}
		)
		GROUP BY DATE(o.created_at)
		ORDER BY orderDate
		ASC
	</select>

	<!-- 올해 vs 전년도 월별 매출 비교 (1월~12월) -->
	<select id="selectMonthlySalesCompare"
		resultType="dto.brand2.OrdersDashboard">
		SELECT
		m.m AS month,
		COALESCE(SUM(CASE WHEN
		YEAR(o.created_at) = YEAR(CURDATE()) THEN o.total_amount END),
		0) AS
		thisYear,
		COALESCE(SUM(CASE WHEN YEAR(o.created_at) = YEAR(CURDATE()) -
		1 THEN o.total_amount
		END), 0) AS lastYear
		FROM (
		SELECT 1 m UNION ALL
		SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION
		ALL
		SELECT 5 UNION
		ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL
		SELECT 9
		UNION ALL SELECT 10 UNION ALL SELECT 11 UNION ALL SELECT 12
		) m
		LEFT
		JOIN orders o
		ON MONTH(o.created_at) = m.m
		AND YEAR(o.created_at) IN
		(YEAR(CURDATE()), YEAR(CURDATE())-1)
		LEFT JOIN order_item oi
		ON
		oi.order_id = o.orders_id
		AND oi.status = 'PAID'
		AND oi.brand_id =
		#{brandId}
		GROUP BY m.m
		ORDER BY m.m;
	</select>
</mapper>