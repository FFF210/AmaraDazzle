<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.orders">

	<!-- ===========================[소비자용]======================= -->
	<!-- 상품 정보 조회 (상품상세에서 바로 주문하는 경우) -->
	<!-- 옵션이 없는 상품: product 테이블의 기본 정보만 -->
	<select id="getProductForDirectOrder" parameterType="Long"
		resultType="map">
		SELECT
		p.product_id as productId,
		p.brand_id as brandId,
		p.name as productName,
		p.price as originalPrice,
		p.discount_type as
		discountType,
		p.discount_value as discountValue,
		p.start_date as
		startDate,
		p.end_date as endDate,
		p.has_option as hasOption,
		p.stock_qty
		as stockQty,
		b.brand_name as brandName
		FROM product p
		LEFT JOIN brand b
		ON p.brand_id = b.brand_id
		WHERE p.product_id = #{productId}
		AND
		p.is_visible = 1
	</select>

	<!-- 상품 옵션 정보 조회 (옵션이 있는 상품의 경우) -->
	<select id="getProductOptionInfo" parameterType="Long"
		resultType="map">
		SELECT
		po.product_option_id as optionId,
		po.product_id as
		productId,
		po.option_value as optionValue,
		po.price as optionPrice,
		po.stock_qty as stockQty
		FROM product_option po
		WHERE
		po.product_option_id = #{optionId}
	</select>

	<!-- 주문 코드 생성 (YYYYMMDD-01XXXX 형태) -->
	<select id="generateOrderCode" resultType="String">
		SELECT CONCAT(
		DATE_FORMAT(NOW(), '%Y%m%d'),
		'-',
		LPAD((
		SELECT
		COALESCE(MAX(CAST(SUBSTRING(order_code, 10) AS UNSIGNED)), 0) + 1
		FROM
		orders
		WHERE order_code LIKE CONCAT(DATE_FORMAT(NOW(), '%Y%m%d'), '-%')
		), 6, '0')
		) as orderCode
	</select>

	<!-- [소비자용] 새 주문 생성 -->
	<insert id="createOrder" parameterType="dto.Orders"
		useGeneratedKeys="true" keyProperty="ordersId">
		INSERT INTO orders (
		order_code,
		member_id,
		phone,
		subtotal_amount,
		discount_amount,
		shipping_amount,
		total_amount,
		ship_recipient,
		ship_phone,
		ship_postcode,
		ship_line1,
		ship_line2,
		note,
		using_coupon,
		using_point,
		created_at
		) VALUES (
		#{orderCode},
		#{memberId},
		#{phone},
		#{subtotalAmount},
		#{discountAmount},
		#{shippingAmount},
		#{totalAmount},
		#{shipRecipient},
		#{shipPhone},
		#{shipPostcode},
		#{shipLine1},
		#{shipLine2},
		#{note},
		#{usingCoupon},
		#{usingPoint},
		NOW()
		)
	</insert>

	<!-- [소비자용] 주문 상품 추가 -->
	<insert id="createOrderItem" parameterType="dto.OrderItem"
		useGeneratedKeys="true" keyProperty="orderItemId">
		INSERT INTO order_item (
		order_id,
		brand_id,
		product_id,
		option_id,
		unit_price,
		quantity,
		line_subtotal,
		discount,
		total,
		status
		) VALUES (
		#{orderId},
		#{brandId},
		#{productId},
		#{optionId},
		#{unitPrice},
		#{quantity},
		#{lineSubtotal},
		#{discount},
		#{total},
		'PAID'
		)
	</insert>

	<!-- [소비자용] 주문 조회 (주문 완료 후 확인용...현재로선 필요없지만 남겨둠) -->
	<select id="getOrderById" parameterType="Long"
		resultType="dto.Orders">
		SELECT
		orders_id as ordersId,
		order_code as orderCode,
		member_id as memberId,
		phone,
		subtotal_amount as subtotalAmount,
		discount_amount as discountAmount,
		shipping_amount as shippingAmount,
		total_amount as totalAmount,
		ship_recipient as shipRecipient,
		ship_phone as shipPhone,
		ship_postcode as shipPostcode,
		ship_line1 as
		shipLine1,
		ship_line2 as shipLine2,
		note,
		using_coupon as usingCoupon,
		using_point as usingPoint,
		created_at as createdAt
		FROM orders
		WHERE
		orders_id = #{ordersId}
	</select>

	<!-- [소비자용] 주문 상품 목록 조회 (join with 주문아이템) (기간 필터, 페이징) [orderList용] -->
	<select id="getOrderItemsByMemberWithPeriod" parameterType="map"
		resultType="map">
		SELECT
		o.orders_id as ordersId,
		o.order_code as orderCode,
		o.created_at as orderDate,
		oi.order_item_id as orderItemId,
		oi.product_id as productId,
		oi.quantity,
		oi.total,
		oi.status,
		oi.tracking_no as trackingNo,
		oi.carrier_name as carrierName,
		p.name as
		productName,
		b.brand_name as brandName,
		po.option_value as optionValue
		FROM orders o
		JOIN order_item oi ON o.orders_id = oi.order_id
		JOIN
		product p ON oi.product_id = p.product_id
		JOIN brand b ON oi.brand_id =
		b.brand_id
		LEFT JOIN product_option po ON oi.option_id =
		po.product_option_id
		WHERE o.member_id = #{memberId}
		<if test="startDate != null">
			AND o.created_at &gt;= #{startDate}
		</if>
		<if test="endDate != null">
			AND o.created_at &lt;= #{endDate}
		</if>
		ORDER BY o.created_at DESC, oi.order_item_id ASC
		LIMIT #{limit} OFFSET
		#{offset}
	</select>
	
	<!-- ===== [소비자용] 회원별 주문 상태 통계 조회 orderStatusCard용 =========== -->
<select id="getOrderStatusCountByMember" parameterType="Long" resultType="map">
    SELECT 
        COUNT(*) as orderCount,
        COUNT(CASE WHEN oi.status = 'PAID' THEN 1 END) as paymentCount,
        COUNT(CASE WHEN oi.status = 'PREPARING' THEN 1 END) as shippingCount,
        COUNT(CASE WHEN oi.status = 'SHIPPING' THEN 1 END) as deliveredCount,
        COUNT(CASE WHEN oi.status = 'DELIVERED' THEN 1 END) as confirmedCount
    FROM orders o
    JOIN order_item oi ON o.orders_id = oi.order_id
    WHERE o.member_id = #{memberId}
</select>

	<!-- [소비자] 주문 상품 상세 정보 조회 (상품명, 브랜드명, 옵션명 포함) [orderDetail용] -->
	<select id="getOrderItemsWithProductInfo" parameterType="Long"
		resultType="map">
		SELECT
		oi.order_item_id as orderItemId,
		oi.order_id as
		orderId,
		oi.brand_id as brandId,
		oi.product_id as productId,
		oi.option_id as optionId,
		oi.unit_price as unitPrice,
		oi.quantity,
		oi.line_subtotal as lineSubtotal,
		oi.discount,
		oi.total,
		oi.status,
		p.name as productName,
		b.brand_name as brandName,
		po.option_value as
		optionValue
		FROM order_item oi
		LEFT JOIN product p ON oi.product_id =
		p.product_id
		LEFT JOIN brand b ON oi.brand_id = b.brand_id
		LEFT JOIN
		product_option po ON oi.option_id = po.product_option_id
		WHERE
		oi.order_id = #{orderId}
	</select>

	<!-- [소비자용] 고객의 주문 상품 총 개수 조회 (페이징용) -->
	<select id="getOrderItemCountByMember" parameterType="map"
		resultType="int">
		SELECT COUNT(*)
		FROM orders o
		JOIN order_item oi ON o.orders_id = oi.order_id
		WHERE o.member_id = #{memberId}
		<if test="startDate != null">
			AND o.created_at &gt;= #{startDate}
		</if>
		<if test="endDate != null">
			AND o.created_at &lt;= #{endDate}
		</if>
	</select>

	<!-- ======================= [브랜드 어드민] 주문 목록 조회 ======================= -->
	<select id="selectOrdersListForBrand" parameterType="map"
		resultType="ordersList">
		SELECT DISTINCT
		o.orders_id,
		o.order_code,
		o.member_id,
		m.name AS member_name,
		o.total_amount,
		o.created_at,
		(SELECT p.name
		FROM order_item oi2
		JOIN
		product p ON oi2.product_id = p.product_id
		WHERE oi2.order_id =
		o.orders_id
		AND oi2.brand_id = #{brandId}
		LIMIT 1) AS product_name,
		(SELECT GROUP_CONCAT(DISTINCT p.name SEPARATOR ', ')
		FROM order_item
		oi2
		JOIN product p ON oi2.product_id = p.product_id
		WHERE oi2.order_id =
		o.orders_id
		AND oi2.brand_id = #{brandId}
		) AS product_names,
		COALESCE(
		(SELECT oi2.status
		FROM order_item oi2
		WHERE oi2.order_id = o.orders_id
		AND oi2.brand_id = #{brandId}
		AND oi2.status IN
		('PAID','PREPARING','SHIPPING','DELIVERED','CONFIRMED')
		ORDER BY CASE
		oi2.status
		WHEN 'PAID' THEN 1
		WHEN 'PREPARING' THEN 2
		WHEN 'SHIPPING'
		THEN 3
		WHEN 'DELIVERED' THEN 4
		WHEN 'CONFIRMED' THEN 5
		END
		LIMIT 1),
		(SELECT oi3.status
		FROM order_item oi3
		WHERE oi3.order_id = o.orders_id
		AND oi3.brand_id = #{brandId}
		LIMIT 1)
		) AS orderStatus,
		CASE
		WHEN EXISTS
		(SELECT 1 FROM order_item oi2
		WHERE oi2.order_id = o.orders_id
		AND
		oi2.brand_id = #{brandId}
		AND oi2.status = 'CANCELLED')
		THEN 1 ELSE 0
		END AS has_cancelled_item,
		CASE
		WHEN EXISTS (SELECT 1 FROM order_item
		oi3
		WHERE oi3.order_id = o.orders_id
		AND oi3.brand_id = #{brandId}
		AND
		oi3.status LIKE 'RETURN%')
		THEN 1 ELSE 0 END AS has_return_item,
		CASE
		WHEN EXISTS (SELECT 1 FROM order_item oi4
		WHERE oi4.order_id =
		o.orders_id
		AND oi4.brand_id = #{brandId}
		AND oi4.status LIKE
		'EXCHANGE%')
		THEN 1 ELSE 0 END AS has_exchange_item
		FROM orders o
		JOIN
		order_item oi ON o.orders_id = oi.order_id
		JOIN member m ON o.member_id
		= m.member_id
		<where>
			oi.brand_id = #{brandId}

			<!-- 검색 필터 -->
			<if
				test="searchType != null and searchKeyword != null and searchKeyword != ''">
				<choose>
					<when test="searchType == 'MEMBER'">
						AND m.name LIKE CONCAT('%', #{searchKeyword}, '%')
					</when>
					<when test="searchType == 'PRODUCT'">
						AND EXISTS (
						SELECT 1
						FROM order_item oi5
						JOIN product
						p2 ON oi5.product_id = p2.product_id
						WHERE oi5.order_id =
						o.orders_id
						AND oi5.brand_id = #{brandId}
						AND p2.name LIKE
						CONCAT('%', #{searchKeyword}, '%')
						)
					</when>
				</choose>
			</if>

			<!-- 주문 상태 필터 -->
			<if test="status != null and status != '' and status != 'ALL'">
				<choose>
					<when test="status == 'EXCHANGE'">
						AND EXISTS (
						SELECT 1 FROM order_item oi6
						WHERE
						oi6.order_id = o.orders_id
						AND oi6.brand_id = #{brandId}
						AND
						oi6.status LIKE 'EXCHANGE%'
						)
					</when>
					<when test="status == 'RETURN'">
						AND EXISTS (
						SELECT 1 FROM order_item oi7
						WHERE
						oi7.order_id = o.orders_id
						AND oi7.brand_id = #{brandId}
						AND
						oi7.status LIKE 'RETURN%'
						)
					</when>
					<otherwise>
						AND EXISTS (
						SELECT 1 FROM order_item oi8
						WHERE
						oi8.order_id = o.orders_id
						AND oi8.brand_id = #{brandId}
						AND
						oi8.status = #{status}
						)
					</otherwise>
				</choose>
			</if>

			<!-- 기간 필터 -->
			<if test="startDate != null and startDate != ''">
				AND o.created_at &gt;= #{startDate}
			</if>
			<if test="endDate != null and endDate != ''">
				AND o.created_at &lt;= #{endDate}
			</if>
		</where>
		ORDER BY o.created_at DESC
		LIMIT #{limit} OFFSET #{offset}
	</select>

	<!-- ======================= [브랜드 어드민] 주문 개수 조회 ======================= -->
	<select id="selectOrdersCountForBrand" parameterType="map"
		resultType="Integer">
		SELECT COUNT(DISTINCT o.orders_id)
		FROM orders o
		JOIN order_item oi ON
		o.orders_id = oi.order_id
		JOIN member m ON o.member_id = m.member_id
		<where>
			oi.brand_id = #{brandId}

			<!-- 검색 필터 -->
			<if
				test="searchType != null and searchKeyword != null and searchKeyword != ''">
				<choose>
					<when test="searchType == 'MEMBER'">
						AND m.name LIKE CONCAT('%', #{searchKeyword}, '%')
					</when>
					<when test="searchType == 'PRODUCT'">
						AND EXISTS (
						SELECT 1
						FROM order_item oi5
						JOIN product
						p2 ON oi5.product_id = p2.product_id
						WHERE oi5.order_id =
						o.orders_id
						AND oi5.brand_id = #{brandId}
						AND p2.name LIKE
						CONCAT('%', #{searchKeyword}, '%')
						)
					</when>
				</choose>
			</if>

			<!-- 주문 상태 필터 -->
			<if test="status != null and status != '' and status != 'ALL'">
				<choose>
					<when test="status == 'EXCHANGE'">
						AND EXISTS (
						SELECT 1 FROM order_item oi6
						WHERE
						oi6.order_id = o.orders_id
						AND oi6.brand_id = #{brandId}
						AND
						oi6.status LIKE 'EXCHANGE%'
						)
					</when>
					<when test="status == 'RETURN'">
						AND EXISTS (
						SELECT 1 FROM order_item oi7
						WHERE
						oi7.order_id = o.orders_id
						AND oi7.brand_id = #{brandId}
						AND
						oi7.status LIKE 'RETURN%'
						)
					</when>
					<otherwise>
						AND EXISTS (
						SELECT 1 FROM order_item oi8
						WHERE
						oi8.order_id = o.orders_id
						AND oi8.brand_id = #{brandId}
						AND
						oi8.status = #{status}
						)
					</otherwise>
				</choose>
			</if>

			<!-- 기간 필터 -->
			<if test="startDate != null and startDate != ''">
				AND o.created_at &gt;= #{startDate}
			</if>
			<if test="endDate != null and endDate != ''">
				AND o.created_at &lt;= #{endDate}
			</if>
		</where>
	</select>

	<!-- ======================= [브랜드 어드민] 주문 요약 조회 ======================= -->
	<select id="selectOrderSummaryForBrand"
		resultType="ordersSummary">
		SELECT
		o.orders_id,
		o.order_code,
		o.created_at,
		o.using_point,
		COALESCE(
		(SELECT oi2.status
		FROM order_item oi2
		WHERE oi2.order_id = o.orders_id
		AND oi2.brand_id =
		#{brandId}
		AND oi2.status IN
		('PAID','PREPARING','SHIPPING','DELIVERED','CONFIRMED')
		ORDER BY CASE
		oi2.status
		WHEN 'PAID' THEN 1
		WHEN 'PREPARING' THEN 2
		WHEN 'SHIPPING'
		THEN 3
		WHEN 'DELIVERED' THEN 4
		WHEN 'CONFIRMED' THEN 5
		END
		LIMIT 1),
		(SELECT oi3.status
		FROM order_item oi3
		WHERE oi3.order_id = o.orders_id
		AND oi3.brand_id = #{brandId}
		LIMIT 1)
		) AS orderStatus,
		oi.tracking_no,
		oi.carrier_name,
		o.subtotal_amount,
		o.discount_amount,
		o.shipping_amount,
		o.total_amount,
		o.ship_recipient,
		o.ship_phone,
		o.ship_postcode,
		o.ship_line1,
		o.ship_line2,
		o.note,
		m.email AS
		member_email,
		m.name AS member_name,
		m.phone AS member_phone
		FROM orders
		o
		JOIN order_item oi ON o.orders_id = oi.order_id
		JOIN member m ON
		o.member_id = m.member_id
		WHERE oi.brand_id = #{brandId}
		AND o.orders_id
		= #{orderId}
		LIMIT 1
	</select>

	<!-- ======================= [브랜드 어드민] 주문 상품 상세 조회 ======================= -->
	<select id="selectOrderItemsForBrand"
		resultType="ordersItemDetail">
		SELECT
		oi.order_item_id,
		oi.product_id,
		oi.option_id,
		oi.quantity,
		oi.total,
		oi.status AS item_status,
		p.name AS product_name,
		po.option_value AS option_name
		FROM order_item oi
		JOIN product p ON
		oi.product_id = p.product_id
		LEFT JOIN product_option po ON
		oi.option_id = po.product_option_id
		WHERE oi.brand_id = #{brandId}
		AND
		oi.order_id = #{orderId}
		ORDER BY oi.order_item_id ASC
	</select>
</mapper>