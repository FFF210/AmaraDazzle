<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.category">

    <!-- Category 객체와 DB 컬럼 매핑 -->
    <resultMap id="categoryResultMap" type="dto.Category">
        <id property="categoryId" column="category_id"/>
        <result property="parentId" column="parent_id"/>
        <result property="name" column="name"/>
        <result property="description" column="description"/>
        <result property="sortOrder" column="sort_order"/>
        <result property="isVisible" column="is_visible"/>
        <result property="level" column="level"/>
        <result property="categoryPath" column="category_path"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!--  헤더 메뉴용 - 최상위 카테고리 목록 조회 -->
    <select id="selectMainCategories" resultMap="categoryResultMap">
        SELECT * FROM category 
        WHERE parent_id IS NULL 
        AND is_visible = 1 
        ORDER BY sort_order ASC
    </select>

    <!-- 특정 카테고리의 하위 카테고리 조회 -->
    <select id="selectSubCategories" parameterType="long" resultMap="categoryResultMap">
        SELECT * FROM category 
        WHERE parent_id = #{parentId} 
        AND is_visible = 1 
        ORDER BY sort_order ASC
    </select>

    <!--  카테고리 ID로 단일 카테고리 조회 -->
    <select id="selectById" parameterType="long" resultMap="categoryResultMap">
        SELECT * FROM category 
        WHERE category_id = #{categoryId}
    </select>

    <!-- 카테고리 이름으로 조회 -->
    <select id="selectByName" parameterType="string" resultMap="categoryResultMap">
        SELECT * FROM category 
        WHERE name = #{name} 
        AND is_visible = 1
    </select>

    <!-- 전체 카테고리 계층구조 조회 (사이드바나 전체 카테고리 페이지용) -->
    <select id="selectAllCategories" resultMap="categoryResultMap">
        SELECT * FROM category 
        WHERE is_visible = 1 
        ORDER BY category_path ASC, sort_order ASC
    </select>

    <!-- 특정 레벨의 카테고리들 조회 -->
    <select id="selectByLevel" parameterType="int" resultMap="categoryResultMap">
        SELECT * FROM category 
        WHERE level = #{level} 
        AND is_visible = 1 
        ORDER BY sort_order ASC
    </select>

    <!-- 카테고리 경로로 조회 (브레드크럼용) -->
    <select id="selectBreadcrumb" parameterType="long" resultType="map">
        WITH RECURSIVE category_path AS (
            -- 현재 카테고리
            SELECT category_id, parent_id, name, level
            FROM category 
            WHERE category_id = #{categoryId}
            
            UNION ALL
            
            -- 부모 카테고리들을 재귀적으로 찾기
            SELECT c.category_id, c.parent_id, c.name, c.level
            FROM category c
            JOIN category_path cp ON c.category_id = cp.parent_id
        )
        SELECT 
            category_id as categoryId,
            name,
            level
        FROM category_path
        ORDER BY level ASC
    </select>

    <!-- 헤더 드롭다운용 - 메인카테고리와 서브카테고리를 한번에 조회 -->
    <select id="selectCategoriesWithSub" resultType="map">
        SELECT 
            p.category_id as parentId,
            p.name as parentName,
            p.sort_order as parentSort,
            c.category_id as childId,
            c.name as childName,
            c.sort_order as childSort
        FROM category p
        LEFT JOIN category c ON p.category_id = c.parent_id AND c.is_visible = 1
        WHERE p.parent_id IS NULL 
        AND p.is_visible = 1
        ORDER BY p.sort_order ASC, c.sort_order ASC
    </select>


    <!-- 카테고리별 인기 상품과 함께 조회 (메인페이지용) -->
    <select id="selectCategoriesWithPopularProducts" resultType="map">
        SELECT 
            c.category_id as categoryId,
            c.name as categoryName,
            p.product_id as productId,
            p.name as productName,
            p.price,
            p.thumbnail_file_id as thumbnailFileId
        FROM category c
        LEFT JOIN (
            SELECT product_id, category_id, name, price, thumbnail_file_id,
                   ROW_NUMBER() OVER (PARTITION BY category_id ORDER BY created_at DESC) as rn
            FROM product 
            WHERE is_visible = 1
        ) p ON c.category_id = p.category_id AND p.rn &lt;= 4
        WHERE c.parent_id IS NULL 
        AND c.is_visible = 1
        ORDER BY c.sort_order ASC, p.rn ASC
    </select>

    <!-- 검색 자동완성용 - 카테고리 이름 검색 -->
    <select id="searchCategoryNames" parameterType="string" resultType="map">
        SELECT 
            category_id as categoryId,
            name,
            level
        FROM category 
        WHERE name LIKE CONCAT('%', #{keyword}, '%') 
        AND is_visible = 1 
        ORDER BY level ASC, sort_order ASC
        LIMIT 10
    </select>
</mapper>