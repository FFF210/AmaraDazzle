<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.coupon">
	<!-- ======================= [브랜드 어드민] 주문 사용 쿠폰 조회 ======================= -->
	<select id="selectOrdersCouponForBrand"
		resultType="ordersCoupon">
		SELECT
		mc.member_coupon_id,
		mc.used_date,
		c.coupon_id,
		c.cname
		FROM member_coupon mc
		JOIN coupon c ON mc.coupon_id = c.coupon_id
		WHERE
		mc.order_id = #{orderId}
	</select>

	<!-- ======================= [소비자] 다운 가능한 쿠폰 목록 조회 ======================= -->
	<select id="selectAvailableCoupons" parameterType="map"
		resultType="couponList">
		SELECT
		c.coupon_id,
		c.cname,
		c.start_date,
		c.end_date,
		c.amount,
		c.amount_condition,
		c.reason,
		c.provision,
		c.coupon_limit,
		c.writer_type,
		c.writer_id,
		c.created_at,
		b.brand_name,
		b.logo_file_id,
		cat.name AS category_name,
		CASE
		WHEN EXISTS (
		SELECT 1
		FROM member_coupon mc
		WHERE mc.coupon_id = c.coupon_id
		AND mc.member_id = #{memberId}
		)
		THEN 1 ELSE 0
		END AS downloaded
		FROM coupon c
		LEFT JOIN brand b
		ON c.writer_type = 'BRAND_ADMIN'
		AND c.writer_id = b.brand_id
		LEFT JOIN category cat
		ON c.category_id = cat.category_id
		WHERE c.provision = 'ALL'
		AND NOW() BETWEEN c.start_date AND c.end_date
		ORDER BY b.brand_name ASC, c.created_at DESC
	</select>

	<!-- ======================= [소비자] 쿠폰 다운로드 ======================= -->
	<insert id="insertMemberCoupon" parameterType="map"
		useGeneratedKeys="true" keyProperty="memberCouponId">
		INSERT INTO member_coupon (
		coupon_id,
		member_id,
		status,
		created_at
		)
		VALUES (
		#{couponId},
		#{memberId},
		'AVAILABLE',
		NOW()
		)
	</insert>

	<!-- ======================= [소비자] 쿠폰 제한 수량 감소 ======================= -->
	<update id="decreaseCouponLimit" parameterType="long">
		UPDATE coupon
		SET
		coupon_limit = CAST(coupon_limit AS SIGNED) - 1
		WHERE coupon_id =
		#{value}
		AND CAST(coupon_limit AS SIGNED) > 0
	</update>

</mapper>