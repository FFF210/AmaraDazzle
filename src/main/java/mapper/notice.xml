<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.notice">

	<!-- 공지(seller) 글쓰기 저장 -->
	<insert id="insertSellerNotice" parameterType="notice" useGeneratedKeys="true" keyProperty="noticeId">
		insert into notice 
			(notice_id, type_id, title, content, 
			image1_file_id, image2_file_id, image3_file_id, doc_file_id, 
			writer, view_cnt, target_type_id, is_exposed, created_at, updated_at)
		values 
			(0, #{typeId}, #{title}, #{content},
			#{image1FileId},#{image2FileId}, #{image3FileId},#{docFileId}, 
			#{writer}, 0, #{targetTypeId}, 1, now(), null)
	</insert>

	<!-- 공지(seller) 상세보기 -->
	<select id="selectSellerNoticeOne" resultType="notice" parameterType="int">
		select n.*, c.name, a.aname,
		f1.file_name AS image1FileName,
		f1.file_rename AS image1FileRename,
		f1.storage_path AS image1StoragePath,
		f2.file_name AS image2FileName,
		f2.file_rename AS image2FileRename,
		f2.storage_path AS image2StoragePath,
		f3.file_name AS image3FileName,
		f3.file_rename AS image3FileRename,
		f3.storage_path AS image3StoragePath
		from notice n
		join admin_info a on (n.writer = a.admin_info_id)
		join code_detail c on (n.type_id = c.code_detail_id)
		LEFT JOIN upload_file f1 ON (n.image1_file_id = f1.upload_file_id)
		LEFT JOIN upload_file f2 ON (n.image2_file_id = f2.upload_file_id)
		LEFT JOIN upload_file f3 ON (n.image3_file_id = f3.upload_file_id)
		where n.notice_id = #{num}
	</select>


	<!-- 공지(seller) 게시글 수 -->
	<select id="SellerNoticeCnt" resultType="Integer" parameterType="searchCondition">
		select count(*) from notice
		where target_type_id = 5
		<if test="startDateTime != null and endDateTime != null">
		    and (created_at &gt;= #{startDateTime} 
		    		and created_at &lt; #{endDateTime})
		</if>
		<if test="q_select != null and q_select != ''">
			<choose>
				<when test="q_select == '시스템'">
					and type_id = 28
				</when>
				<when test="q_select == '이벤트'">
					and type_id = 29
				</when>
				<when test="q_select == '기타'">
					and type_id = 30
				</when>
			</choose>
		</if>
		<if test="totalSearch != null and totalSearch != '' and keyword != null and keyword != ''">
			<choose>
				<when test="totalSearch == '제목'">
					and title like concat('%',#{keyword},'%')
				</when>
				<when test="totalSearch == '내용'">
					and content like concat('%',#{keyword},'%')
				</when>
			</choose>
		</if>
	</select>


	<!-- 공지(seller) 리스트 -->
	<select id="selectAllSellerNotice" resultType="notice"
		parameterType="Map">
		select n.*, c.name
		from notice n
		join code_detail c on
		(n.type_id = c.code_detail_id)
		where target_type_id = 5
		order by
		notice_id desc limit #{start_p},#{post_ea}
	</select>


	<!-- 공지(seller) 게시글 검색 리스트 -->
	<select id="selectSearchSellerNotice" resultType="notice"
		parameterType="searchCondition">
		select n.*, c.name
		from notice n
		join code_detail c on (n.type_id =
		c.code_detail_id)
		where n.target_type_id = 5
		<if test="startDateTime != null and endDateTime != null">
			and (n.created_at &gt;= #{startDateTime}
			and n.created_at
			&lt; #{endDateTime})
		</if>
		<if test="q_select != null and q_select != ''">
			<choose>
				<when test="q_select == '시스템'">
					and n.type_id = 28
				</when>
				<when test="q_select == '이벤트'">
					and n.type_id = 29
				</when>
				<when test="q_select == '기타'">
					and n.type_id = 30
				</when>
			</choose>
		</if>
		<if test="totalSearch != null and totalSearch != ''">
			<choose>
				<when test="totalSearch == '제목'">
					and n.title like concat('%',#{keyword},'%')
				</when>
				<when test="totalSearch == '내용'">
					and n.content like concat('%',#{keyword},'%')
				</when>
			</choose>
		</if>
		order by n.notice_id desc limit #{start_p},#{post_ea}
	</select>


	<!-- 공지 게시글 조회수 -->
	<update id="notice_viewcnt" parameterType="Integer">
		update notice set
		view_cnt = view_cnt+1 where notice_id=#{num}
	</update>

	<!-- 공지(seller) 수정  -->
	<update id="updateSellerNotice" parameterType="notice">
		update notice set type_id = #{typeId}, title = #{title}, content=#{content}, writer=#{writer},
		<if test="image1FileId != null">
		image1_file_id = #{image1FileId}, image2_file_id=#{image2FileId}, image3_file_id=#{image3FileId}, doc_file_id = #{docFileId},
		</if>
		updated_at = now() where notice_id=#{noticeId}
	</update>
	
	<!-- 공지(seller) 삭제  -->
	<delete id="noticeSellerDelete" parameterType="Long">
		delete from notice where notice_id = #{num}
	</delete>
	
	<!-- 공지 게사상태 변경  -->
	<update id="noticeExposeChange" parameterType="Long">
		update notice 
		set is_exposed = NOT is_exposed 
		where notice_id = #{noticeId}
	</update>




	<!-- [브랜드 어드민] 공지사항 전체 조회 -->
	<select id="selectNoticeList" parameterType="map"
		resultType="noticeList">
		SELECT
		n.notice_id,
		n.type_id,
		cd.name AS type_name,
		n.title,
		n.content,
		n.image1_file_id,
		n.image2_file_id,
		n.image3_file_id,
		n.doc_file_id,
		n.writer,
		n.target_type_id,
		n.view_cnt,
		n.is_exposed,
		n.created_at,
		n.updated_at
		FROM notice n
		LEFT JOIN code_detail cd
		ON
		n.type_id = cd.code_detail_id
		WHERE n.target_type_id = 5
		ORDER BY
		n.created_at DESC
		LIMIT #{limit} OFFSET #{offset}
	</select>

	<!-- [브랜드 어드민] 공지사항 전체 개수 -->
	<select id="selectNoticeCount" resultType="int">
		SELECT COUNT(*)
		FROM
		notice
		WHERE target_type_id = 5
	</select>

	<!-- [브랜드 어드민] 공지사항 단일 조회 -->
	<select id="selectNoticeById" parameterType="long"
		resultType="noticeList">
		SELECT
		n.notice_id,
		n.type_id,
		cd.name AS type_name,
		n.title,
		n.content,
		n.image1_file_id,
		n.image2_file_id,
		n.image3_file_id,
		n.doc_file_id,
		n.writer,
		n.view_cnt,
		n.is_exposed,
		n.created_at,
		n.updated_at
		FROM notice n
		LEFT JOIN code_detail cd ON n.type_id = cd.code_detail_id
		WHERE n.notice_id = #{value}
	</select>



</mapper>