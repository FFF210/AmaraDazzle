<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.membership">

	<!-- [brand2] 멤버십 결제 목록 조회 -->
	<select id="selectMembershipList" parameterType="map"
		resultType="membershipList">
		SELECT
		m.membership_id AS membershipId,
		m.brand_id AS
		brandId,
		m.plan_id AS planId,
		m.start_date AS startDate,
		m.end_date AS
		endDate,
		m.status AS status,
		m.created_at AS createdAt,
		m.updated_at AS
		updatedAt,
		m.remain_quota AS remainQuota,
		mp.membership_explain AS
		planName,
		p.payment_type AS paymentMethod
		FROM membership m
		LEFT JOIN
		membership_plan mp
		ON m.plan_id = mp.membership_plan_id
		LEFT JOIN
		admin_payment p
		ON m.plan_id = p.plan_id
		AND m.brand_id = p.brand_id
		WHERE m.brand_id = #{brandId}
		ORDER BY
		m.membership_id DESC
		LIMIT
		#{limit} OFFSET #{offset}
	</select>

	<!-- [brand2] 멤버십 결제 개수 조회 -->
	<select id="selectMembershipCount" parameterType="map"
		resultType="int">
		SELECT COUNT(*)
		FROM membership m
	</select>

	<!-- [brand2] 멤버십 신규 가입 -->
	<insert id="insertMembership" parameterType="membership">
		INSERT INTO
		membership
		(brand_id, plan_id, start_date, end_date, status,
		remain_quota)
		VALUES
		(#{brandId}, #{planId}, #{startDate}, #{endDate},
		#{status}, #{remainQuota})
	</insert>

	<!-- [brand2] 멤버십 취소 버튼 -->
	<update id="cancelReservedMembership" parameterType="long">
		UPDATE
		membership
		SET status = 'CANCELLED',
		updated_at = NOW()
		WHERE
		membership_id = #{membershipId}
		AND start_date &gt; NOW()
		AND status =
		'ACTIVE'
	</update>

	<!-- [brand2] 브랜드별 현재 이용중 멤버십 조회 (오늘 날짜가 start~end 사이) -->
	<select id="selectCurrentMembership" parameterType="long"
		resultType="membership">
		SELECT *
		FROM membership
		WHERE brand_id = #{brandId}
		AND
		status = 'ACTIVE'
		AND start_date &lt;= NOW()
		AND end_date &gt;= NOW()
		ORDER BY
		created_at DESC
		LIMIT 1
	</select>


	<!-- [brand2] 브랜드별 예약된 멤버십 조회 (start_date > NOW()) -->
	<select id="selectReservedMembership" parameterType="long"
		resultType="membership">
		SELECT *
		FROM membership
		WHERE brand_id = #{brandId}
		AND status = 'ACTIVE'
		AND start_date &gt; NOW()
		ORDER BY start_date ASC
		LIMIT 1
	</select>
	

</mapper>