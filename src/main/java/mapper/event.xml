<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.event">

	<!-- ====== [brand2] 이벤트 목록 조회 (브랜드 참여여부 포함) ====== -->
	<select id="selectEventList" parameterType="map"
		resultType="dto.brand2.EventList">
		SELECT DISTINCT
		e.event_id AS eventId,
		e.start_date AS startDate,
		e.end_date AS endDate,
		e.event_name AS eventName,
		e.status AS status,
		a.brand_id AS brandId,
		a.event_application_id AS eventApplicationId,
		a.apply_date AS	applyDate,
		a.manager_name AS managerName,
		CASE
		WHEN
		a.event_application_id IS NOT NULL THEN '참여'
		ELSE '미참여'
		END AS
		participateYn,
		CASE
		WHEN e.status = 'RECRUIT'
		AND CURRENT_DATE &lt;=
		DATE_SUB(e.start_date, INTERVAL 1 DAY)
		THEN 'Y'
		ELSE 'N'
		END AS canApply
		FROM event e
		LEFT JOIN event_application a
		ON e.event_id =
		a.event_id
		AND
		a.brand_id = #{brandId}
		<where>
			<if test="status != null and status != '' and status != '전체'">
				AND e.status = #{status}
			</if>
			<!-- 검색 유형 : 광고명, 광고담당자 -->
			<if
				test="searchType != null and searchKeyword != null and searchKeyword != ''">
				<choose>
					<when test="searchType eq 'EVENTNAME'">
						AND e.event_name LIKE CONCAT('%',
						#{searchKeyword},
						'%')
					</when>
					<when test="searchType eq 'EVENTMANAGERNAME'">
						AND a.manager_name LIKE CONCAT('%',
						#{searchKeyword}, '%')
					</when>
				</choose>
			</if>
		</where>
		ORDER BY e.event_id DESC
		<!-- 페이지네이션 -->
		LIMIT #{limit} OFFSET #{offset}
	</select>

	<!-- ====== [brand2] 이벤트 개수 조회 ====== -->
	<select id="selectEventCount" parameterType="map"
		resultType="int">
		SELECT COUNT(DISTINCT e.event_id)
		FROM event e
		LEFT JOIN event_application a
		ON e.event_id = a.event_id
		AND a.brand_id = #{brandId}
		<where>
			<!-- 상태 필터 -->
			<if test="status != null and status != '' and status != '전체'">
				AND e.status = #{status}
			</if>

			<!-- 검색 (이벤트명 / 담당자) -->
			<if
				test="searchType != null and searchKeyword != null and searchKeyword != ''">
				<choose>
					<when test="searchType eq 'EVENTNAME'">
						AND e.event_name LIKE CONCAT('%', #{searchKeyword}, '%')
					</when>
					<when test="searchType eq 'EVENTMANAGERNAME'">
						AND a.manager_name LIKE CONCAT('%', #{searchKeyword}, '%')
					</when>
				</choose>
			</if>
		</where>
	</select>


	<!-- ====== [brand2] 이벤트 신청하기 버튼 ====== -->
	<select id="selectEventById" parameterType="long" resultType="event">
		SELECT
			e.event_id AS eventId,
			e.event_type AS eventType,
			e.event_name AS eventName,
			e.start_date AS startDate,
			e.end_date AS endDate,
			e.status AS status,
			e.category_id AS categoryId,
			e.thumbnail_file_id AS thumbnailFileId,
			e.detail_file_id AS detailFileId,
			e.content AS content,
			e.writer AS writer,
			e.expose_YN AS exposeYn,
			e.created_at AS createdAt,
			e.updated_at AS updatedAt
		FROM event e
		WHERE e.event_id = #{eventId}
	</select>

	<!-- ====== [brand2] 이벤트 신청 상세보기 버튼 ====== -->
	<select id="selectEventDetailById" parameterType="long"
		resultType="dto.brand2.EventDetail">
		SELECT
		e.event_id AS eventId,
		e.event_type AS eventType,
		e.event_name AS eventName,
		e.status AS status,
		e.start_date AS
		startDate,
		e.end_date AS endDate,

		a.event_application_id AS eventApplicationId,
		a.manager_name AS managerName,
		a.manager_tel AS managerTel,
		a.note AS note,
		a.apply_date AS applyDate,

		c.coupon_id AS couponId,
		c.cname AS cname,
		c.start_date AS couponStartDate,
		c.end_date AS couponEndDate,
		c.amount AS amount,
		c.amount_condition AS amountCondition,

		GROUP_CONCAT(p.product_id) AS productIds

		FROM event e
		LEFT JOIN
		event_application a ON e.event_id = a.event_id
		LEFT JOIN coupon c ON
		c.reason = CONCAT('event_application:',
		a.event_application_id)
		LEFT JOIN product p ON e.event_id = p.event_id
		WHERE e.event_id = #{eventId}
		GROUP BY e.event_id, e.event_type, e.event_name, e.status,
		e.start_date, e.end_date, e.category_id, e.thumbnail_file_id, e.detail_file_id, e.content,
		a.event_application_id, a.manager_name, a.manager_tel, a.note, a.apply_date,
		c.coupon_id, c.cname, c.start_date, c.end_date, c.amount, c.amount_condition
	</select>

	<!-- ====== [brand2] 이벤트 종료 시 상품 event_id 해제 ====== -->
	<update id="resetProductsForEvent" parameterType="long">
		UPDATE product
		SET event_id = NULL
		WHERE event_id = #{eventId}
	</update>


	<!-- ================[소비자] 이벤트 목록 조회 =================== -->
	<select id="selectEventListForConsumer" parameterType="map"
		resultType="event">
		SELECT
		e.event_id AS eventId,
		e.event_type AS eventType,
		e.start_date AS
		startDate,
		e.end_date AS endDate,
		e.event_name AS
		eventName,
		e.status AS
		status,
		e.thumbnail_file_id AS thumbnailFileId,
		e.detail_file_id AS
		detailFileId,
		e.category_id AS categoryId,
		e.content
		AS content,
		e.writer AS writer,
		e.expose_YN AS exposeYn,
		e.created_at AS
		createdAt,
		e.updated_at AS updatedAt
		FROM event e
		WHERE e.expose_YN = 1
		AND e.status IN ('ONGOING', 'FINISHED')
		ORDER BY
		CASE e.status
		WHEN
		'ONGOING' THEN 1
		WHEN
		'FINISHED' THEN 2
		ELSE 3
		END,
		e.start_date ASC
		LIMIT
		#{offset}, #{limit}
	</select>

	<!-- ================[소비자] 이벤트 개수 조회 =================== -->
	<select id="selectEventCountForConsumer" parameterType="map"
		resultType="Integer">
		SELECT COUNT(*)
		FROM event e
		WHERE e.expose_YN = 1
		AND
		e.status IN ('ONGOING', 'FINISHED')
	</select>

	<!-- ================[소비자] 이벤트 상세 조회 =================== -->
	<select id="selectEventDetail" parameterType="Long"
		resultType="eventDetail">
		SELECT
		e.event_id AS eventId,
		e.event_type AS eventType,
		e.start_date AS startDate,
		e.end_date AS endDate,
		e.event_name AS
		eventName,
		e.status AS status,
		e.thumbnail_file_id AS thumbnailFileId,
		e.detail_file_id AS detailFileId,
		e.category_id AS categoryId,
		e.content AS content,
		e.writer AS writer,
		e.expose_YN AS exposeYn,
		e.created_at AS createdAt,
		e.updated_at AS updatedAt
		FROM event e
		WHERE
		e.event_id = #{value}
	</select>

	<!-- ================[소비자] 이벤트 참여 상품 조회 =================== -->
	<select id="selectEventDetailProducts" parameterType="map"
		resultType="eventDetailProduct">
		SELECT
		p.product_id AS productId,
		p.brand_id AS brandId,
		b.brand_name AS brandName,
		p.name AS name,
		p.is_exclusive AS
		isExclusive,
		p.is_visible AS isVisible,
		p.is_planned AS isPlanned,
		p.category1_id AS category1Id,
		p.category2_id AS category2Id,
		p.category3_id AS category3Id,
		p.thumbnail_file_id AS thumbnailFileId,
		p.image1_file_id AS image1FileId,
		p.image2_file_id AS image2FileId,
		p.image3_file_id AS image3FileId,
		p.image4_file_id AS image4FileId,
		p.image5_file_id AS image5FileId,
		p.ingredients AS ingredients,
		p.price
		AS price,
		p.order_limit AS orderLimit,
		p.has_option AS hasOption,
		p.stock_qty AS stockQty,
		p.shipping_method AS shippingMethod,
		p.discount_type AS discountType,
		p.discount_value AS discountValue,
		p.start_date AS startDate,
		p.end_date AS endDate,
		p.event_id AS eventId,
		p.created_at AS createdAt,
		p.updated_at AS updatedAt,

		CASE
		WHEN
		p.discount_type = 'RATE'
		THEN p.price - (p.price * p.discount_value /
		100)
		WHEN p.discount_type = 'AMOUNT'
		THEN p.price - p.discount_value
		ELSE p.price
		END AS finalPrice,

		CASE
		WHEN uw.wishlist_id IS NOT NULL THEN
		1
		ELSE 0
		END AS isWished

		FROM product p
		JOIN brand b ON p.brand_id =
		b.brand_id

		LEFT JOIN (
		SELECT wishlist_id, product_id
		FROM wishlist
		WHERE
		member_id = #{memberId}
		) uw ON p.product_id = uw.product_id

		WHERE
		p.event_id = #{eventId}
		AND p.is_visible = 1
	</select>

	<!-- ================ ADMIN =================== -->
	<!-- event 게시글 총 개수 -->
	<select id="eventCount" resultType="Integer"
		parameterType="searchCondition">
		select count(*) from event e
		left join event_application ea on
		(e.event_id = ea.event_id)
		left join brand b on (ea.brand_id =
		b.brand_id)
		<where>
			<if test="startDateTime != null and endDateTime != null">
				and (e.created_at &gt;= #{startDateTime}
				and e.created_at
				&lt; #{endDateTime})
			</if>
			<if test="startDateTime2 != null and endDateTime2 != null">
				and (e.start_date &gt;= #{startDateTime2}
				and e.end_date
				&lt; #{endDateTime2})
			</if>
			<if
				test="totalSearch != null and totalSearch != '' and keyword != null and keyword != ''">
				<choose>
					<when test="totalSearch == '이벤트명'">
						and e.event_name like concat('%',#{keyword},'%')
					</when>
					<when test="totalSearch == '브랜드명'">
						and b.brand_name like concat('%',#{keyword},'%')
					</when>
				</choose>
			</if>
		</where>
	</select>

	<!-- event 리스트 보기 -->
	<select id="allEventList" resultType="event" parameterType="Map">
		select e.*, b.brand_name from event e
		left join event_application ea on
		(e.event_id = ea.event_id)
		left join brand b on (ea.brand_id =
		b.brand_id)
		order by e.event_id desc limit #{start_p},#{post_ea}
	</select>

	<!-- 검색된 event 리스트 -->
	<select id="searchEventList" resultType="event"
		parameterType="searchCondition">
		select e.*, b.brand_name from event e
		left join event_application ea on
		(e.event_id = ea.event_id)
		left join brand b on (ea.brand_id =
		b.brand_id)
		<where>
			<if test="startDateTime != null and endDateTime != null">
				and (e.created_at &gt;= #{startDateTime}
				and e.created_at
				&lt; #{endDateTime})
			</if>
			<if test="startDateTime2 != null and endDateTime2 != null">
				and (e.start_date &gt;= #{startDateTime2}
				and e.end_date
				&lt; #{endDateTime2})
			</if>
			<if
				test="totalSearch != null and totalSearch != '' and keyword != null and keyword != ''">
				<choose>
					<when test="totalSearch == '이벤트명'">
						and e.event_name like concat('%',#{keyword},'%')
					</when>
					<when test="totalSearch == '브랜드명'">
						and b.brand_name like concat('%',#{keyword},'%')
					</when>
				</choose>
			</if>
		</where>
		order by e.event_id desc limit #{start_p},#{post_ea}
	</select>


	<!-- event 게시글 조회수 -->
	<update id="eventViewCnt" parameterType="Integer">
		update event set
		view_cnt = view_cnt+1 where event_id=#{num}
	</update>

	<!-- 어드민 이벤트 등록 -->
	<insert id="adminEventWrite" parameterType="event">
		insert into event
		(event_id, event_type, start_date, end_date,
		event_name,
		thumbnail_file_id, detail_file_id, category_id,
		content, writer,
		created_at)
		values
		(0, #{eventType}, #{startDate}, #{endDate},
		#{eventName},#{thumbnailFileId}, #{detailFileId}, #{categoryId},
		#{content}, #{writer}, now())
	</insert>

</mapper>