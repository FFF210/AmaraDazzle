<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.event">

	<!-- ====== [brand2] 이벤트 목록 조회 (브랜드 참여여부 포함) ====== -->
	<select id="selectEventList" parameterType="map"
		resultType="dto.brand2.EventList">
		SELECT
		e.event_id AS eventId,
		e.start_date AS startDate,
		e.end_date AS
		endDate,
		e.event_name AS eventName,
		e.status AS status,
		MAX(a.brand_id)
		AS brandId,
		MAX(a.event_application_id) AS eventApplicationId,
		MAX(a.apply_date) AS applyDate,
		MAX(a.manager_name) AS managerName,
		CASE
		WHEN MAX(a.event_application_id) IS NOT NULL THEN '참여'
		ELSE '미참여'
		END AS participateYn,
		CASE
		WHEN e.status = 'RECRUIT'
		AND CURRENT_DATE
		&lt;= DATE_SUB(e.start_date, INTERVAL 1 DAY)
		THEN 'Y'
		ELSE 'N'
		END AS
		canApply
		FROM event e
		LEFT JOIN event_application a
		ON e.event_id =
		a.event_id
		AND a.brand_id = #{brandId}
		<where>
			<if test="status != null and status != '' and status != '전체'">
				AND e.status = #{status}
			</if>
			<if
				test="searchType != null and searchKeyword != null and searchKeyword != ''">
				<choose>
					<when test="searchType eq 'EVENTNAME'">
						AND e.event_name LIKE CONCAT('%', #{searchKeyword},
						'%')
					</when>
					<when test="searchType eq 'EVENTMANAGERNAME'">
						AND a.manager_name LIKE CONCAT('%',
						#{searchKeyword}, '%')
					</when>
				</choose>
			</if>
		</where>
		GROUP BY e.event_id, e.start_date, e.end_date, e.event_name, e.status
		ORDER BY e.event_id DESC
		LIMIT #{limit} OFFSET #{offset}
	</select>


	<!-- ====== [brand2] 이벤트 개수 조회 ====== -->
	<select id="selectEventCount" parameterType="map"
		resultType="int">
		SELECT COUNT(DISTINCT e.event_id)
		FROM event e
		LEFT JOIN
		event_application a
		ON e.event_id = a.event_id
		AND a.brand_id =
		#{brandId}
		<where>
			<!-- 상태 필터 -->
			<if test="status != null and status != '' and status != '전체'">
				AND e.status = #{status}
			</if>

			<!-- 검색 (이벤트명 / 담당자) -->
			<if
				test="searchType != null and searchKeyword != null and searchKeyword != ''">
				<choose>
					<when test="searchType eq 'EVENTNAME'">
						AND e.event_name LIKE CONCAT('%', #{searchKeyword},
						'%')
					</when>
					<when test="searchType eq 'EVENTMANAGERNAME'">
						AND a.manager_name LIKE CONCAT('%',
						#{searchKeyword}, '%')
					</when>
				</choose>
			</if>
		</where>
	</select>


	<!-- ====== [brand2] 이벤트 신청하기 버튼 ====== -->
	<select id="selectEventById" parameterType="long"
		resultType="dto.brand2.EventDetail">
		SELECT
		e.event_id AS eventId,
		e.event_type AS eventType,
		e.event_name AS eventName,
		e.start_date AS startDate,
		e.end_date AS
		endDate,
		e.status AS status,

		CASE
		WHEN c.depth = 1 THEN c.category_id
		WHEN c.depth = 2 THEN p1.category_id
		WHEN c.depth = 3 THEN
		p2.category_id
		END AS category1Id,
		CASE
		WHEN c.depth = 1 THEN NULL
		WHEN
		c.depth = 2 THEN c.category_id
		WHEN c.depth = 3 THEN p1.category_id
		END
		AS category2Id,
		CASE
		WHEN c.depth = 3 THEN c.category_id
		ELSE NULL
		END AS
		category3Id,

		CASE
		WHEN c.depth = 1 THEN c.name
		WHEN c.depth = 2 THEN
		p1.name
		WHEN c.depth = 3 THEN p2.name
		END AS largeCategoryName,
		CASE
		WHEN
		c.depth = 2 THEN c.name
		WHEN c.depth = 3 THEN p1.name
		ELSE NULL
		END AS
		middleCategoryName,
		CASE
		WHEN c.depth = 3 THEN c.name
		ELSE NULL
		END AS
		smallCategoryName,
		
		f1.file_rename AS thumbFileName,
		f2.file_rename AS detailFileName,

		e.thumbnail_file_id AS thumbnailFileId,
		e.detail_file_id AS detailFileId,
		e.content AS content,
		e.writer AS
		writer,
		e.expose_YN AS exposeYn,
		e.created_at AS createdAt,
		e.updated_at
		AS updatedAt,

		GROUP_CONCAT(p.product_id) AS productIds,
		MAX(p.discount_type) AS discountType,
		MAX(p.discount_value) AS
		discountValue

		FROM event e
		LEFT JOIN category c ON e.category_id = c.category_id
		LEFT JOIN category p1 ON c.parent_id = p1.category_id
		LEFT JOIN category p2 ON p1.parent_id = p2.category_id
		LEFT JOIN product p ON (p.event_id = e.event_id OR p.event_id IS NULL)
		JOIN upload_file f1 ON f1.upload_file_id = e.thumbnail_file_id
		JOIN upload_file f2 ON f2.upload_file_id = e.detail_file_id
		WHERE
		e.event_id = #{eventId}
	</select>

	<!-- ====== [brand2] 이벤트 신청 상세보기 버튼 ====== -->
	<select id="selectEventDetailById" parameterType="map"
		resultType="dto.brand2.EventDetail">
		SELECT
		e.event_id AS eventId,
		e.event_type AS eventType,
		e.event_name AS eventName,
		e.status AS status,
		e.start_date AS
		startDate,
		e.end_date AS endDate,

		a.event_application_id AS
		eventApplicationId,
		a.manager_name AS managerName,
		a.manager_tel AS
		managerTel,
		a.note AS note,
		a.apply_date AS applyDate,

		GROUP_CONCAT(p.product_id) AS productIds,
		MAX(p.discount_type) AS
		discountType,
		MAX(p.discount_value) AS discountValue,

		e.thumbnail_file_id AS thumbnailFileId,
		e.detail_file_id AS
		detailFileId,
		e.content AS
		content,
		e.writer AS writer,
		e.expose_YN AS
		exposeYn,
		e.created_at AS
		createdAt,
		e.updated_at AS updatedAt,

		c3.category_id AS category3Id,
		c3.name AS smallCategoryName,
		c2.category_id AS category2Id,
		c2.name AS
		middleCategoryName,
		c1.category_id AS category1Id,
		c1.name AS
		largeCategoryName

		FROM event e
		LEFT JOIN event_application a
		ON
		e.event_id = a.event_id AND a.brand_id
		= #{brandId}
		LEFT JOIN product p
		ON (p.event_id = e.event_id OR
		p.event_id IS NULL)
		LEFT JOIN category
		c3 ON e.category_id =
		c3.category_id
		LEFT JOIN category c2 ON
		c3.parent_id = c2.category_id
		LEFT JOIN category c1 ON c2.parent_id =
		c1.category_id
		WHERE e.event_id
		= #{eventId}
		AND a.brand_id = #{brandId}
		GROUP BY e.event_id,
		e.event_type, e.event_name, e.status,
		e.start_date, e.end_date,
		e.thumbnail_file_id, e.detail_file_id,
		e.content, e.writer,
		e.expose_YN, e.created_at, e.updated_at,
		a.event_application_id,
		a.manager_name, a.manager_tel, a.note,
		a.apply_date,
		c3.category_id,
		c3.name, c2.category_id, c2.name,
		c1.category_id, c1.name
	</select>


	<!-- ====== [brand2] 이벤트 종료 시 상품 event_id 해제 ====== -->
	<update id="resetProductsForEvent" parameterType="long">
		UPDATE product
		SET event_id = NULL
		WHERE event_id = #{eventId}
	</update>


	<!-- ================[소비자] 이벤트 목록 조회 =================== -->
	<select id="selectEventListForConsumer" parameterType="map"
		resultType="event">
		SELECT
		e.event_id AS eventId,
		e.event_type AS eventType,
		e.start_date AS startDate,
		e.end_date AS endDate,
		e.event_name AS eventName,
		e.status AS status,
		e.thumbnail_file_id AS thumbnailFileId,
		e.detail_file_id AS detailFileId,
		e.category_id AS categoryId,
		e.content AS content,
		e.writer AS writer,
		e.expose_YN AS exposeYn,
		e.created_at AS createdAt,
		e.updated_at AS updatedAt,
		f1.file_rename AS thumbFileName,
		f2.file_rename AS detailFileName
		FROM event e
		JOIN upload_file f1 ON f1.upload_file_id = e.thumbnail_file_id
		JOIN upload_file f2 ON f2.upload_file_id = e.detail_file_id
		WHERE e.expose_YN = 1
		AND e.status IN ('ONGOING', 'FINISHED')
		ORDER BY
		CASE e.status
		WHEN
		'ONGOING' THEN 1
		WHEN
		'FINISHED' THEN 2
		ELSE 3
		END,
		e.start_date DESC
		LIMIT
		#{offset}, #{limit}
	</select>

	<!-- ================[소비자] 이벤트 개수 조회 =================== -->
	<select id="selectEventCountForConsumer" parameterType="map"
		resultType="Integer">
		SELECT COUNT(*)
		FROM event e
		WHERE e.expose_YN = 1
		AND
		e.status IN ('ONGOING', 'FINISHED')
	</select>

	<!-- ================[소비자] 이벤트 상세 조회 =================== -->
	<select id="selectEventDetail" parameterType="Long"
		resultType="eventDetail">
		SELECT
		e.event_id AS eventId,
		e.event_type AS eventType,
		e.start_date AS startDate,
		e.end_date AS endDate,
		e.event_name AS eventName,
		e.status AS status,
		e.thumbnail_file_id AS thumbnailFileId,
		e.detail_file_id AS detailFileId,
		e.category_id AS categoryId,
		e.content AS content,
		e.writer AS writer,
		e.expose_YN AS exposeYn,
		e.created_at AS createdAt,
		e.updated_at AS updatedAt,
		f1.file_rename AS thumbFileName,
		f2.file_rename AS detailFileName
		FROM event e
		JOIN upload_file f1 ON f1.upload_file_id = e.thumbnail_file_id
		JOIN upload_file f2 ON f2.upload_file_id = e.detail_file_id
		WHERE
		e.event_id = #{value}
	</select>

	<!-- ================[소비자] 이벤트 참여 상품 조회 =================== -->
	<select id="selectEventDetailProducts" parameterType="map"
		resultType="eventDetailProduct">
		SELECT
		p.product_id AS productId,
		p.brand_id AS brandId,
		b.brand_name AS brandName,
		p.name AS name,
		p.is_exclusive AS isExclusive,
		p.is_visible AS isVisible,
		p.is_planned AS isPlanned,
		p.category1_id AS category1Id,
		p.category2_id AS category2Id,
		p.category3_id AS category3Id,
		p.thumbnail_file_id AS thumbnailFileId,
		p.image1_file_id AS image1FileId,
		p.image2_file_id AS image2FileId,
		p.image3_file_id AS image3FileId,
		p.image4_file_id AS image4FileId,
		p.image5_file_id AS image5FileId,
		p.ingredients AS ingredients,
		p.price AS price,
		p.order_limit AS orderLimit,
		p.has_option AS hasOption,
		p.stock_qty AS stockQty,
		p.shipping_method AS shippingMethod,
		p.discount_type AS discountType,
		p.discount_value AS discountValue,
		p.start_date AS startDate,
		p.end_date AS endDate,
		p.event_id AS eventId,
		p.created_at AS createdAt,
		p.updated_at AS updatedAt,

		CASE
		WHEN
		p.discount_type = 'RATE'
		THEN p.price - (p.price * p.discount_value /
		100)
		WHEN p.discount_type = 'AMOUNT'
		THEN p.price - p.discount_value
		ELSE p.price
		END AS finalPrice,

		CASE
		WHEN uw.wishlist_id IS NOT NULL THEN
		1
		ELSE 0
		END AS isWished

		FROM product p
		JOIN brand b ON p.brand_id = b.brand_id
		LEFT JOIN (SELECT wishlist_id, product_id
					FROM wishlist
					WHERE member_id = #{memberId}) uw ON p.product_id = uw.product_id

		WHERE
		p.event_id = #{eventId}
		AND p.is_visible = 1
	</select>

	<!-- ================ ADMIN =================== -->
	<!-- event 게시글 총 개수 -->
	<select id="eventCount" resultType="Integer" parameterType="searchCondition">
		SELECT COUNT(DISTINCT e.event_id)
		FROM event e
		LEFT JOIN event_application ea ON e.event_id = ea.event_id
		<where>
			<if test="startDateTime != null and endDateTime != null">
				and (e.created_at &gt;= #{startDateTime}
				and e.created_at
				&lt; #{endDateTime})
			</if>
			<if test="startDateTime2 != null and endDateTime2 != null">
				and (e.start_date &gt;= #{startDateTime2}
				and e.end_date
				&lt; #{endDateTime2})
			</if>
			<if
				test="totalSearch != null and totalSearch != '' and keyword != null and keyword != ''">
				<choose>
					<when test="totalSearch == '이벤트명'">
						and e.event_name like concat('%',#{keyword},'%')
					</when>
					<when test="totalSearch == '브랜드명'">
						and b.brand_name like concat('%',#{keyword},'%')
					</when>
				</choose>
			</if>
		</where>
	</select>

	<!-- event 리스트 보기 -->
	<select id="allEventList" resultType="event" parameterType="Map">
		SELECT 
		    e.event_id,
		    e.event_type,
		    e.event_name,
		    e.start_date,
		    e.end_date,
		    e.status,
		    e.thumbnail_file_id,
		    e.expose_YN,
		    e.created_at,
		    COUNT(DISTINCT ea.brand_id) AS brand_count,
		    (
		        SELECT b2.brand_name
		        FROM event_application ea2
		        JOIN brand b2 ON ea2.brand_id = b2.brand_id
		        WHERE ea2.event_id = e.event_id
		        ORDER BY ea2.event_application_id ASC
		        LIMIT 1
		    ) AS brand_name,
		    GROUP_CONCAT(DISTINCT b.brand_name ORDER BY b.brand_name SEPARATOR ', ') AS brand_list
		FROM event e
		LEFT JOIN event_application ea ON e.event_id = ea.event_id
		LEFT JOIN brand b ON ea.brand_id = b.brand_id
		GROUP BY 
		    e.event_id,
		    e.event_name,
		    e.start_date,
		    e.end_date,
		    e.expose_YN
		ORDER BY e.event_id desc LIMIT #{start_p},#{post_ea}
	</select>

	<!-- 검색된 event 리스트 -->
	<select id="searchEventList" resultType="event" parameterType="searchCondition">
		SELECT 
		    e.event_id,
		    e.event_type,
		    e.event_name,
		    e.start_date,
		    e.end_date,
		    e.status,
		    e.thumbnail_file_id,
		    e.expose_YN,
		    e.created_at,
		    COUNT(DISTINCT ea.brand_id) AS brand_count,
		    (
		        SELECT b2.brand_name
		        FROM event_application ea2
		        JOIN brand b2 ON ea2.brand_id = b2.brand_id
		        WHERE ea2.event_id = e.event_id
		        ORDER BY ea2.event_application_id ASC
		        LIMIT 1
		    ) AS brand_name,
		     GROUP_CONCAT(DISTINCT b.brand_name ORDER BY b.brand_name SEPARATOR ', ') AS brand_list
		FROM event e
		LEFT JOIN event_application ea ON e.event_id = ea.event_id
		LEFT JOIN brand b ON ea.brand_id = b.brand_id
		<where>
			<if test="startDateTime != null and endDateTime != null">
				and (e.created_at &gt;= #{startDateTime}
				and e.created_at
				&lt; #{endDateTime})
			</if>
			<if test="startDateTime2 != null and endDateTime2 != null">
				and (e.start_date &gt;= #{startDateTime2}
				and e.end_date
				&lt; #{endDateTime2})
			</if>
			<if
				test="totalSearch != null and totalSearch != '' and keyword != null and keyword != ''">
				<choose>
					<when test="totalSearch == '이벤트명'">
						and e.event_name like concat('%',#{keyword},'%')
					</when>
					<when test="totalSearch == '브랜드명'">
						and b.brand_name like concat('%',#{keyword},'%')
					</when>
				</choose>
			</if>
		</where>
		GROUP BY 
		    e.event_id,
		    e.event_title,
		    e.start_date,
		    e.end_date,
		    e.expose_YN
		ORDER BY e.event_id DESC LIMIT #{start_p},#{post_ea}
	</select>
	
	<!-- event 게시글 조회수 -->
	<update id="eventViewCnt" parameterType="Integer">
		update event set
		view_cnt = view_cnt+1 where event_id=#{num}
	</update>

	<!-- 어드민 이벤트 등록 -->
	<insert id="adminEventWrite" parameterType="event">
		insert into event
		(event_id, event_type, start_date, end_date,
		event_name,
		thumbnail_file_id, detail_file_id, category_id,
		 writer,
		created_at)
		values
		(0, #{eventType}, #{startDate}, #{endDate},
		#{eventName},#{thumbnailFileId}, #{detailFileId}, #{categoryId},
		#{writer}, now())
	</insert>
	
	
	<!-- 이벤트 노출상태 변경  -->
	<update id="eventExposeChange" parameterType="Long">
		UPDATE event 
		SET 
		expose_YN = NOT expose_YN, 
		status = CASE 
                    WHEN expose_YN = 1 THEN 'ONGOING' 
                    ELSE 'FINISHED' 
                 END,
		start_date = CASE 
                        WHEN expose_YN = 1 THEN NOW() 
                        ELSE start_date 
                     END
		WHERE event_id = #{event_id}
	</update>

	<!-- ======================= [소비자] 브랜드의 진행 중인 이벤트 조회 ======================= -->
	<select id="selectEventsByBrandId" parameterType="Long"
		resultType="map">
		SELECT
		e.event_id AS eventId,
		e.event_name AS eventName,
		e.event_type AS eventType,
		e.thumbnail_file_id AS thumbnailFileId,
		e.start_date AS startDate,
		e.end_date AS endDate,
		e.status AS status
		FROM event e
		INNER JOIN event_application ea
		ON e.event_id = ea.event_id
		WHERE ea.brand_id = #{brandId}
		AND e.status = 'ONGOING'
		AND e.expose_YN = 1
		AND NOW() BETWEEN e.start_date AND e.end_date
		ORDER BY e.created_at DESC
	</select>

</mapper>