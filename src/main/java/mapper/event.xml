<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.event">
	<!-- 이벤트 목록 조회 -->
	<select id="selectEventList" parameterType="map"
		resultType="eventList">
		SELECT
		e.event_id AS eventId,
		e.event_type AS eventType,
		e.start_date AS
		startDate,
		e.end_date AS endDate,
		e.event_name AS eventName,
		e.status AS
		status,
		e.writer AS writer,
		e.created_at AS applyDate,
		CASE
		WHEN
		a.event_application_id IS NOT NULL THEN '참여'
		ELSE '미참여'
		END AS
		participateYn
		FROM event e
		LEFT JOIN event_application a
		ON e.event_id =
		a.event_id
		AND a.brand_id = #{brandId}
		<where>
			<if test="status != null and status != '' and status != '전체'">
				AND e.status = #{status}
			</if>
		</where>
		ORDER BY e.created_at DESC
	</select>


	<!-- ================[소비자] 이벤트 목록 조회 =================== -->
	<select id="selectEventListForConsumer" parameterType="map"
		resultType="event">
		SELECT
		e.event_id AS eventId,
		e.event_type AS eventType,
		e.start_date AS
		startDate,
		e.end_date AS endDate,
		e.event_name AS
		eventName,
		e.status AS
		status,
		e.thumbnail_file_id AS thumbnailFileId,
		e.detail_file_id AS
		detailFileId,
		e.category_id AS categoryId,
		e.content
		AS content,
		e.writer AS writer,
		e.expose_YN AS exposeYn,
		e.created_at AS
		createdAt,
		e.updated_at AS updatedAt
		FROM event e
		WHERE e.expose_YN = 1
		AND e.status IN ('ONGOING', 'FINISHED')
		ORDER BY
		CASE e.status
		WHEN
		'ONGOING' THEN 1
		WHEN
		'FINISHED' THEN 2
		ELSE 3
		END,
		e.start_date ASC
		LIMIT
		#{offset}, #{limit}
	</select>

	<!-- ================[소비자] 이벤트 개수 조회 =================== -->
	<select id="selectEventCountForConsumer" parameterType="map"
		resultType="Integer">
		SELECT COUNT(*)
		FROM event e
		WHERE e.expose_YN = 1
		AND
		e.status IN ('ONGOING', 'FINISHED')
	</select>

	<!-- ================[소비자] 이벤트 상세 조회 =================== -->
	<select id="selectEventDetail" parameterType="Long"
		resultType="eventDetail">
		SELECT
		e.event_id AS eventId,
		e.event_type AS eventType,
		e.start_date AS startDate,
		e.end_date AS endDate,
		e.event_name AS
		eventName,
		e.status AS status,
		e.thumbnail_file_id AS thumbnailFileId,
		e.detail_file_id AS detailFileId,
		e.category_id AS categoryId,
		e.content AS content,
		e.writer AS writer,
		e.expose_YN AS exposeYn,
		e.created_at AS createdAt,
		e.updated_at AS updatedAt
		FROM event e
		WHERE
		e.event_id = #{value}
	</select>

	<!-- ================[소비자] 이벤트 참여 상품 조회 =================== -->
	<select id="selectEventDetailProducts" parameterType="map"
		resultType="eventDetailProduct">
		SELECT
		p.product_id AS productId,
		p.brand_id AS brandId,
		b.brand_name AS brandName,
		p.name AS name,
		p.is_exclusive AS isExclusive,
		p.is_visible AS isVisible,
		p.is_planned AS isPlanned,
		p.category1_id AS category1Id,
		p.category2_id AS category2Id,
		p.category3_id AS category3Id,
		p.thumbnail_file_id AS thumbnailFileId,
		p.image1_file_id AS image1FileId,
		p.image2_file_id AS image2FileId,
		p.image3_file_id AS image3FileId,
		p.image4_file_id AS image4FileId,
		p.image5_file_id AS image5FileId,
		p.ingredients AS ingredients,
		p.price AS price,
		p.order_limit AS orderLimit,
		p.has_option AS hasOption,
		p.stock_qty AS stockQty,
		p.shipping_method AS shippingMethod,
		p.discount_type AS discountType,
		p.discount_value AS discountValue,
		p.start_date AS startDate,
		p.end_date AS endDate,
		p.event_id AS eventId,
		p.created_at AS createdAt,
		p.updated_at AS updatedAt,

		CASE
		WHEN p.discount_type = 'RATE'
		THEN p.price - (p.price * p.discount_value / 100)
		WHEN p.discount_type = 'AMOUNT'
		THEN p.price - p.discount_value
		ELSE p.price
		END AS finalPrice,

		CASE
		WHEN uw.wishlist_id IS NOT NULL THEN 1
		ELSE 0
		END AS isWished

		FROM product p
		JOIN brand b ON p.brand_id = b.brand_id

		LEFT JOIN (
		SELECT wishlist_id, product_id
		FROM wishlist
		WHERE member_id = #{memberId}
		) uw ON p.product_id = uw.product_id

		WHERE p.event_id = #{eventId}
		AND p.is_visible = 1
	</select>
	<!-- event 게시글 총 개수 -->
	<select id="eventCount" resultType="Integer" parameterType="searchCondition">
		select count(*) from event e
		join event_application ea on (e.event_id = ea.event_id)
		join brand b on (ea.brand_id = b.brand_id)
		<where>
			<if test="startDateTime != null and endDateTime != null">
			    and (e.created_at &gt;= #{startDateTime} 
			    		and e.created_at &lt; #{endDateTime})
			</if>
			<if test="startDateTime2 != null and endDateTime2 != null">
			    and (e.start_date &gt;= #{startDateTime2} 
			    		and e.end_date &lt; #{endDateTime2})
			</if>
			<if test="totalSearch != null and totalSearch != '' and keyword != null and keyword != ''">
				<choose>
					<when test="totalSearch == '이벤트명'">
						and e.event_name like concat('%',#{keyword},'%')
					</when>
					<when test="totalSearch == '브랜드명'">
						and b.brand_name like concat('%',#{keyword},'%')
					</when>
				</choose>
			</if>
		</where>
	</select>
	
	<!-- event 리스트 보기 -->
	<select id="allEventList" resultType="banner" parameterType="Map">
		select e.*, b.brand_name from event e
		join event_application ea on (e.event_id = ea.event_id)
		join brand b on (ea.brand_id = b.brand_id)
		order by e.event_id desc limit #{start_p},#{post_ea}
	</select>
	
	<!-- 검색된 event 리스트 -->
	<select id="searchEventList" resultType="banner" parameterType="searchCondition">
		select e.*, b.brand_name from event e
		join event_application ea on (e.event_id = ea.event_id)
		join brand b on (ea.brand_id = b.brand_id)
		<where>
			<if test="startDateTime != null and endDateTime != null">
			    and (e.created_at &gt;= #{startDateTime} 
			    		and e.created_at &lt; #{endDateTime})
			</if>
			<if test="startDateTime2 != null and endDateTime2 != null">
			    and (e.start_date &gt;= #{startDateTime2} 
			    		and e.end_date &lt; #{endDateTime2})
			</if>
			<if test="totalSearch != null and totalSearch != '' and keyword != null and keyword != ''">
				<choose>
					<when test="totalSearch == '이벤트명'">
						and e.event_name like concat('%',#{keyword},'%')
					</when>
					<when test="totalSearch == '브랜드명'">
						and b.brand_name like concat('%',#{keyword},'%')
					</when>
				</choose>
			</if>
		</where>
		order by e.event_id desc limit #{start_p},#{post_ea}
	</select>


	<!-- event 게시글 조회수 -->
	<update id="eventViewCnt" parameterType="Integer">
		update event set view_cnt = view_cnt+1 where event_id=#{num}
	</update>
	
</mapper>