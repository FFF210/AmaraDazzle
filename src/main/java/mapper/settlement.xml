<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.settlement">
	<!--======================= [브랜드 어드민] 정산 목록 조회 ======================= -->
	<select id="selectSettlementListForBrand" parameterType="map"
		resultType="settlement">
		SELECT
		settlement_id,
		brand_id,
		start_date,
		end_date,
		total_sales,
		shipping_charge,
		p_coupon,
		b_coupon,
		point,
		fee,
		pure_profit,
		final_amount,
		calced_YN,
		created_at,
		deposited_date,
		writer
		FROM settlement
		WHERE
		brand_id = #{brandId}

		<if test="sortField != null and sortField != ''">
			ORDER BY ${sortField}
			<if test="sortOrder == 'desc'">DESC</if>
			<if test="sortOrder == 'asc'">ASC</if>
		</if>

		LIMIT #{limit}
		OFFSET #{offset}
	</select>

	<!--======================= [브랜드 어드민] 정산 목록 개수 ======================= -->
	<select id="selectSettlementCountForBrand" parameterType="long"
		resultType="Integer">
		SELECT COUNT(*)
		FROM settlement
		WHERE brand_id = #{value}
	</select>

	<!--======================= [브랜드 어드민] 정산 대시보드 - 요약 조회 ======================= -->
	<select id="getSettlementSummary" parameterType="long"
		resultType="settlementSummary">
		SELECT
		b.brand_name AS brandName,

		COALESCE(SUM(CASE WHEN
		MONTH(s.start_date) = MONTH(CURRENT_DATE())
		AND YEAR(s.start_date) =
		YEAR(CURRENT_DATE())
		THEN s.final_amount END), 0) AS
		currentFinalAmount,
		COALESCE(SUM(CASE WHEN MONTH(s.start_date) =
		MONTH(CURRENT_DATE())
		AND YEAR(s.start_date) = YEAR(CURRENT_DATE())
		THEN s.fee END), 0) AS currentFee,
		COALESCE(SUM(CASE WHEN
		MONTH(s.start_date) = MONTH(CURRENT_DATE())
		AND YEAR(s.start_date) =
		YEAR(CURRENT_DATE())
		THEN s.total_sales END), 0) AS currentTotalSales,
		COALESCE(SUM(CASE WHEN MONTH(s.start_date) = MONTH(CURRENT_DATE())
		AND
		YEAR(s.start_date) = YEAR(CURRENT_DATE())
		THEN s.pure_profit END), 0)
		AS currentPureProfit,

		COALESCE(SUM(CASE WHEN MONTH(s.start_date) =
		MONTH(DATE_SUB(CURRENT_DATE(), INTERVAL 1
		MONTH))
		AND YEAR(s.start_date)
		= YEAR(DATE_SUB(CURRENT_DATE(), INTERVAL 1 MONTH))
		THEN s.final_amount
		END), 0) AS previousFinalAmount,
		COALESCE(SUM(CASE WHEN
		MONTH(s.start_date) = MONTH(DATE_SUB(CURRENT_DATE(), INTERVAL 1
		MONTH))
		AND YEAR(s.start_date) = YEAR(DATE_SUB(CURRENT_DATE(), INTERVAL
		1 MONTH))
		THEN s.pure_profit END), 0) AS previousPureProfit,

		CASE
		WHEN
		CAST(b.settlement_date AS UNSIGNED) >= DAY(CURRENT_DATE())
		THEN
		CAST(b.settlement_date AS UNSIGNED) - DAY(CURRENT_DATE())
		ELSE
		DAY(LAST_DAY(CURRENT_DATE())) - DAY(CURRENT_DATE())
		+
		CAST(b.settlement_date AS UNSIGNED)
		END AS daysUntilSettlement

		FROM
		brand b
		LEFT JOIN settlement s ON b.brand_id = s.brand_id
		WHERE
		b.brand_id = #{brandId}
		GROUP BY b.brand_id, b.brand_name,
		b.settlement_date;
	</select>

	<!--======================= [브랜드 어드민] 정산 대시보드 - 매출 도넛 차트 ======================= -->
	<select id="getDonutChartData" parameterType="long"
		resultType="settlementDonut">
		SELECT
		COALESCE(SUM(s.p_coupon + s.b_coupon + s.point), 0)
		AS discountAmount,
		COALESCE(SUM(s.pure_profit), 0) AS pureProfit,
		COALESCE(SUM(s.fee), 0) AS fee,
		COALESCE(SUM(s.total_sales), 0) AS
		totalSales

		FROM settlement s
		WHERE s.brand_id = #{brandId}
		AND
		MONTH(s.start_date) = MONTH(CURRENT_DATE())
		AND YEAR(s.start_date) =
		YEAR(CURRENT_DATE());
	</select>


	<!--======================= [브랜드 어드민] 정산 대시보드 - 월 단위 정산 금액 추이 ======================= -->
	<select id="getMonthlyTrend" parameterType="long"
		resultType="settlementTrend">
		SELECT
		DATE_FORMAT(s.start_date, '%Y-%m') AS monthLabel,
		COALESCE(SUM(s.total_sales), 0) AS totalSales,
		COALESCE(SUM(s.fee), 0)
		AS fee,
		COALESCE(SUM(s.pure_profit), 0) AS pureProfit
		FROM settlement s
		WHERE s.brand_id = #{brandId}
		GROUP BY YEAR(s.start_date),
		MONTH(s.start_date)
		ORDER BY YEAR(s.start_date), MONTH(s.start_date);
	</select>



	<!--======================= [ADMIN] ======================= -->
	<!-- 전월 정산자료 settlement테이블에 저장 -->
	<insert id="monthlyInsertSettle" parameterType="Map">
		INSERT INTO settlement (
			brand_id, start_date, end_date,
			total_sales, shipping_charge, p_coupon, b_coupon, point,
			pure_profit, fee, final_amount, calced_YN, writer
			)
			SELECT
				t.brand_id,
				t.start_date,
				t.end_date,
				t.total_sales,
				t.shipping_charge,
				t.p_coupon,
				t.b_coupon,
				t.point,
				t.pure_profit,
				FLOOR(t.pure_profit * 0.07) AS fee,
				FLOOR(t.pure_profit - (t.pure_profit * 0.07)) AS final_amount,
				'Waiting' AS calced_YN,
				'-' AS writer
			FROM (
				SELECT
					b.brand_id,
					#{startDate} AS start_date,
					#{endDate} AS end_date,
					COALESCE(SUM(pay.amount), 0) AS total_sales,
					COALESCE(SUM(o.shipping_amount), 0) AS shipping_charge,
					COALESCE(SUM(CASE WHEN c.writer_type = 'ADMIN' THEN o.discount_amount ELSE 0 END), 0) AS p_coupon,
					COALESCE(SUM(CASE WHEN c.writer_type = 'BRAND_ADMIN' THEN o.discount_amount ELSE 0 END), 0) AS b_coupon,
					COALESCE(SUM(o.using_point), 0) AS point,
					FLOOR((SUM(pay.amount)
							+ SUM(CASE WHEN c.writer_type = 'ADMIN' THEN o.discount_amount ELSE 0 END)
							+ SUM(o.using_point)
							+ SUM(o.shipping_amount))
							- SUM(CASE WHEN c.writer_type = 'BRAND_ADMIN' THEN o.discount_amount ELSE 0 END)) AS pure_profit
				FROM payment pay
				JOIN orders o ON pay.order_id = o.orders_id
				JOIN order_item oi ON o.orders_id = oi.order_id
				JOIN brand b ON oi.brand_id = b.brand_id
				LEFT JOIN coupon c ON o.using_coupon = c.coupon_id
				WHERE oi.status = 'CONFIRMED'
				AND o.created_at BETWEEN #{startDate} AND #{endDate}
				GROUP BY b.brand_id) t;
	</insert>

	<!-- 미정산 리스트 조회 -->
	<select id="selectWaitingSettle" resultType="settlement">
		SELECT * FROM
		settlement
		WHERE calced_YN = 'Waiting'
	</select>

	<!-- 일괄 정산 처리 -->
	<update id="settleAllCompleted">
		<!-- 환불 반영 -->
	    UPDATE settlement s
	    JOIN (
	        SELECT
	            oi.brand_id,
	            COALESCE(SUM(pay.amount), 0) AS refund_amount
	        FROM returns r
	        JOIN orders o ON r.order_id = o.orders_id
	        JOIN order_item oi ON r.order_item_id = oi.order_item_id
	        JOIN payment pay ON pay.order_id = o.orders_id
	        WHERE r.updated_at BETWEEN #{startDate} AND #{endDate}
	        GROUP BY oi.brand_id ) refund ON s.brand_id = refund.brand_id
	    SET
	        s.total_sales = s.total_sales - refund.refund_amount,
	        s.pure_profit = s.pure_profit - refund.refund_amount,
	        s.final_amount = s.final_amount - refund.refund_amount
	    WHERE s.start_date = #{startDate} AND s.end_date = #{endDate} AND calced_YN = 'Waiting';
	
	    <!-- 상태 갱신 -->
	    UPDATE settlement
	    SET calced_YN = 'Completed',
	        deposited_date = NOW()
	    WHERE start_date = #{startDate} AND end_date = #{endDate}
      		AND calced_YN = 'InProgress';
	</update>
	
	<!-- 정산할 건 수 -->
	<select id="settlementCnt" resultType="Integer" parameterType="searchCondition">
		select count(*) from settlement
		where 1=1
		<if test="middleFilter != null and middleFilter != ''">
			<choose>
				<when test="middleFilter == 'Waiting'">
					and calced_YN = 'Waiting'
				</when>
				<when test="middleFilter == 'InProgress'">
					and calced_YN = 'InProgress'
				</when>
				<when test="middleFilter == 'Completed'">
					and calced_YN = 'Completed'
				</when>
				<when test="middleFilter == 'Error'">
					and calced_YN = 'Error'
				</when>
			</choose>
		</if>
		<if test="totalSearch != null and totalSearch != '' and keyword != null and keyword != ''">
			<choose>
				<when test="totalSearch == '브랜드'">
					and title like concat('%',#{keyword},'%')
				</when>
				<when test="totalSearch == '내용'">
					and content like concat('%',#{keyword},'%')
				</when>
			</choose>
		</if>
	</select>
	
	<!-- 정산 리스트 -->
	<select id="settlementAllList" resultType="settlement" parameterType="Map">
		select *
		from settlement s
		order by settlement_id desc limit #{start_p},#{post_ea}
	</select>


	<!-- 정산리스트 (검색) -->
	<select id="settlementSearchList" resultType="settlement" parameterType="searchCondition">
		select *
		from settlement s
		where 1=1
		<if test="middleFilter != null and middleFilter != ''">
			<choose>
				<when test="middleFilter == 'Waiting'">
					and calced_YN = 'Waiting'
				</when>
				<when test="middleFilter == 'InProgress'">
					and calced_YN = 'InProgress'
				</when>
				<when test="middleFilter == 'Completed'">
					and calced_YN = 'Completed'
				</when>
				<when test="middleFilter == 'Error'">
					and calced_YN = 'Error'
				</when>
			</choose>
		</if>
		<if test="totalSearch != null and totalSearch != '' and keyword != null and keyword != ''">
			<choose>
				<when test="totalSearch == '브랜드명'">
					and title like concat('%',#{keyword},'%')
				</when>
				<when test="totalSearch == '내용'">
					and content like concat('%',#{keyword},'%')
				</when>
			</choose>
		</if>
		order by settlement_id desc limit #{start_p},#{post_ea}
	</select>
	
</mapper>