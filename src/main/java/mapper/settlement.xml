<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.settlement">
	<!--======================= [브랜드 어드민] 정산 목록 조회 ======================= -->
	<select id="selectSettlementListForBrand" parameterType="map"
		resultType="settlement">
		SELECT
		settlement_id,
		brand_id,
		start_date,
		end_date,
		total_sales,
		shipping_charge,
		p_coupon,
		b_coupon,
		point,
		fee,
		pure_profit,
		final_amount,
		calced_YN,
		created_at,
		deposited_date,
		writer
		FROM settlement
		WHERE
		brand_id = #{brandId}

		<if test="sortField != null and sortField != ''">
			ORDER BY ${sortField}
			<if test="sortOrder == 'desc'">DESC</if>
			<if test="sortOrder == 'asc'">ASC</if>
		</if>

		LIMIT #{limit}
		OFFSET #{offset}
	</select>

	<!--======================= [브랜드 어드민] 정산 목록 개수 ======================= -->
	<select id="selectSettlementCountForBrand" parameterType="long"
		resultType="Integer">
		SELECT COUNT(*)
		FROM settlement
		WHERE brand_id = #{value}
	</select>

	<!--======================= [브랜드 어드민] 정산 대시보드 - 요약 조회 ======================= -->
	<select id="getSettlementSummary" parameterType="long"
		resultType="settlementSummary">
		SELECT
		b.brand_name AS brandName,

		COALESCE(SUM(CASE WHEN
		MONTH(s.start_date) = MONTH(CURRENT_DATE())
		AND YEAR(s.start_date) =
		YEAR(CURRENT_DATE())
		THEN s.final_amount END), 0) AS
		currentFinalAmount,
		COALESCE(SUM(CASE WHEN MONTH(s.start_date) =
		MONTH(CURRENT_DATE())
		AND YEAR(s.start_date) = YEAR(CURRENT_DATE())
		THEN s.fee END), 0) AS currentFee,
		COALESCE(SUM(CASE WHEN
		MONTH(s.start_date) = MONTH(CURRENT_DATE())
		AND YEAR(s.start_date) =
		YEAR(CURRENT_DATE())
		THEN s.total_sales END), 0) AS currentTotalSales,
		COALESCE(SUM(CASE WHEN MONTH(s.start_date) = MONTH(CURRENT_DATE())
		AND
		YEAR(s.start_date) = YEAR(CURRENT_DATE())
		THEN s.pure_profit END), 0)
		AS currentPureProfit,

		COALESCE(SUM(CASE WHEN MONTH(s.start_date) =
		MONTH(DATE_SUB(CURRENT_DATE(), INTERVAL 1
		MONTH))
		AND YEAR(s.start_date)
		= YEAR(DATE_SUB(CURRENT_DATE(), INTERVAL 1 MONTH))
		THEN s.final_amount
		END), 0) AS previousFinalAmount,
		COALESCE(SUM(CASE WHEN
		MONTH(s.start_date) = MONTH(DATE_SUB(CURRENT_DATE(), INTERVAL 1
		MONTH))
		AND YEAR(s.start_date) = YEAR(DATE_SUB(CURRENT_DATE(), INTERVAL
		1 MONTH))
		THEN s.pure_profit END), 0) AS previousPureProfit,

		CASE
		WHEN
		CAST(b.settlement_date AS UNSIGNED) >= DAY(CURRENT_DATE())
		THEN
		CAST(b.settlement_date AS UNSIGNED) - DAY(CURRENT_DATE())
		ELSE
		DAY(LAST_DAY(CURRENT_DATE())) - DAY(CURRENT_DATE())
		+
		CAST(b.settlement_date AS UNSIGNED)
		END AS daysUntilSettlement

		FROM
		brand b
		LEFT JOIN settlement s ON b.brand_id = s.brand_id
		WHERE
		b.brand_id = #{brandId}
		GROUP BY b.brand_id, b.brand_name,
		b.settlement_date;
	</select>

	<!--======================= [브랜드 어드민] 정산 대시보드 - 매출 도넛 차트 ======================= -->
	<select id="getDonutChartData" parameterType="long"
		resultType="settlementDonut">
		SELECT
		COALESCE(SUM(s.p_coupon + s.b_coupon + s.point), 0)
		AS discountAmount,
		COALESCE(SUM(s.pure_profit), 0) AS pureProfit,
		COALESCE(SUM(s.fee), 0) AS fee,
		COALESCE(SUM(s.total_sales), 0) AS
		totalSales

		FROM settlement s
		WHERE s.brand_id = #{brandId}
		AND
		MONTH(s.start_date) = MONTH(CURRENT_DATE())
		AND YEAR(s.start_date) =
		YEAR(CURRENT_DATE());
	</select>


	<!--======================= [브랜드 어드민] 정산 대시보드 - 월 단위 정산 금액 추이 ======================= -->
	<select id="getMonthlyTrend" parameterType="long"
		resultType="settlementTrend">
		SELECT
		DATE_FORMAT(s.start_date, '%Y-%m') AS monthLabel,
		COALESCE(SUM(s.total_sales), 0) AS totalSales,
		COALESCE(SUM(s.fee), 0)
		AS fee,
		COALESCE(SUM(s.pure_profit), 0) AS pureProfit
		FROM settlement s
		WHERE s.brand_id = #{brandId}
		GROUP BY YEAR(s.start_date),
		MONTH(s.start_date)
		ORDER BY YEAR(s.start_date), MONTH(s.start_date);
	</select>



	<!--======================= [ADMIN] ======================= -->
	<!-- 전월 정산자료 settlement테이블에 저장 -->
	<insert id="monthlyInsertSettle" parameterType="Map">
		INSERT INTO settlement (
		    brand_id, start_date, end_date,
		    total_sales, shipping_charge, p_coupon, b_coupon, point,
		    pure_profit, fee, final_amount, calced_YN, writer
		)
		SELECT
		    t.brand_id,
		    t.start_date,
		    t.end_date,
		    t.total_sales,
		    t.shipping_charge,
		    t.p_coupon,
		    t.b_coupon,
		    t.point,
		    t.pure_profit,
		    FLOOR(t.pure_profit * 0.07) AS fee,  
		    FLOOR(t.pure_profit - (t.pure_profit * 0.07)) AS final_amount,	 
		    'Waiting' AS calced_YN,
		    '-' AS writer
		FROM (
		    SELECT
		        b.brand_id,
		        #{startDate} AS start_date,
		        #{endDate} AS end_date,
		        COALESCE(SUM(oi.line_subtotal + o.shipping_amount), 0) AS total_sales,
		        COALESCE(SUM(o.shipping_amount), 0) AS shipping_charge,
		        COALESCE(SUM(CASE WHEN c.writer_type = 'ADMIN' THEN o.discount_amount ELSE 0 END), 0) AS p_coupon,
		        COALESCE(SUM(CASE WHEN c.writer_type = 'BRAND_ADMIN' THEN o.discount_amount ELSE 0 END), 0) AS b_coupon,
		        COALESCE(SUM(o.using_point), 0) AS point,
		        FLOOR((SUM(oi.line_subtotal + o.shipping_amount)
   					- SUM(CASE WHEN c.writer_type = 'BRAND_ADMIN' THEN o.discount_amount ELSE 0 END)) AS pure_profit
		    FROM order_item oi 
		    JOIN orders o ON o.orders_id = oi.order_id
		    JOIN brand b ON oi.brand_id = b.brand_id
		    LEFT JOIN coupon c ON o.using_coupon = c.coupon_id
		    WHERE oi.status = 'CONFIRMED'
		      AND o.created_at BETWEEN #{startDate} AND #{endDate}
		    GROUP BY b.brand_id
		) t
		WHERE NOT EXISTS (
		    SELECT 1 FROM settlement s
		    WHERE s.brand_id = t.brand_id
		      AND s.start_date = t.start_date
		      AND s.end_date = t.end_date
		)
	</insert>

	<!-- 일괄 정산 처리 -->
	<update id="updateRefundAdjustment" parameterType="Map">
		<!-- 환불/교환 반영 : 1.총매출 갱신 -->
		UPDATE settlement s 
		LEFT JOIN ( SELECT 
						oi.brand_id, 
						COALESCE(SUM(CASE WHEN oi.status = 'RETURN_COMPLETED' THEN (oi.unit_price * oi.quantity) - oi.discount ELSE 0 END), 0) AS refund_amount, 
						COALESCE(SUM(CASE WHEN oi.status = 'RETURN_COMPLETED' AND r.shipping_cost_payer = 'brand' THEN r.shipping_cost ELSE 0 END), 0) AS r_brand_shipping_cost, 
						COALESCE(SUM(CASE WHEN oi.status = 'RETURN_COMPLETED' AND r.shipping_cost_payer = 'member' THEN r.shipping_cost ELSE 0 END ), 0) AS r_member_shipping_cost 
					FROM returns r 
					JOIN order_item oi ON r.order_item_id = oi.order_item_id 
					WHERE r.updated_at BETWEEN #{startDate} AND #{endDate} 
					GROUP BY oi.brand_id) refund ON s.brand_id = refund.brand_id 
		LEFT JOIN ( SELECT 
						oi.brand_id, 
						COALESCE(SUM(CASE WHEN oi.status = 'EXCHANGE_COMPLETED' AND e.shipping_cost_payer = 'brand' THEN e.shipping_cost ELSE 0 END), 0) AS e_brand_shipping_cost, 
						COALESCE(SUM(CASE WHEN oi.status = 'EXCHANGE_COMPLETED' AND e.shipping_cost_payer = 'member' THEN e.shipping_cost ELSE 0 END), 0) AS e_member_shipping_cost 
					FROM exchange e 
					JOIN order_item oi ON e.order_item_id = oi.order_item_id 
					WHERE e.updated_at BETWEEN #{startDate} AND #{endDate} 
					GROUP BY oi.brand_id) ex ON s.brand_id = ex.brand_id 
		SET 
		s.total_sales = s.total_sales - COALESCE(refund.refund_amount, 0) - COALESCE(refund.r_member_shipping_cost, 0), 
		s.shipping_charge = s.shipping_charge + COALESCE(ex.e_member_shipping_cost, 0), 
		s.calced_YN = 'InProgress' 
		WHERE s.start_date = #{startDate} AND s.end_date = #{endDate} AND s.calced_YN = 'Waiting'; 
	</update>
	<update id="updatePureAdjustment" parameterType="Map">
		<!-- 환불/교환 반영 : 2.순수익 갱신 -->
		UPDATE settlement s 
		LEFT JOIN ( SELECT 
						oi.brand_id, 
						COALESCE(SUM(CASE WHEN oi.status = 'RETURN_COMPLETED' THEN (oi.unit_price * oi.quantity) - oi.discount ELSE 0 END), 0) AS refund_amount, 
						COALESCE(SUM(CASE WHEN oi.status = 'RETURN_COMPLETED' AND r.shipping_cost_payer = 'brand' THEN r.shipping_cost ELSE 0 END), 0) AS r_brand_shipping_cost, 
						COALESCE(SUM(CASE WHEN oi.status = 'RETURN_COMPLETED' AND r.shipping_cost_payer = 'member' THEN r.shipping_cost ELSE 0 END ), 0) AS r_member_shipping_cost 
					FROM returns r 
					JOIN order_item oi ON r.order_item_id = oi.order_item_id 
					WHERE r.updated_at BETWEEN #{startDate} AND #{endDate} 
					GROUP BY oi.brand_id) refund ON s.brand_id = refund.brand_id 
		LEFT JOIN ( SELECT 
						oi.brand_id, 
						COALESCE(SUM(CASE WHEN oi.status = 'EXCHANGE_COMPLETED' AND e.shipping_cost_payer = 'brand' THEN e.shipping_cost ELSE 0 END), 0) AS e_brand_shipping_cost, 
						COALESCE(SUM(CASE WHEN oi.status = 'EXCHANGE_COMPLETED' AND e.shipping_cost_payer = 'member' THEN e.shipping_cost ELSE 0 END), 0) AS e_member_shipping_cost 
					FROM exchange e 
					JOIN order_item oi ON e.order_item_id = oi.order_item_id 
					WHERE e.updated_at BETWEEN #{startDate} AND #{endDate} 
					GROUP BY oi.brand_id) ex ON s.brand_id = ex.brand_id 
		SET 
		s.pure_profit =(s.total_sales) + COALESCE(ex.e_member_shipping_cost, 0) - COALESCE(refund.r_brand_shipping_cost, 0) - COALESCE(ex.e_brand_shipping_cost, 0)
		WHERE s.start_date = #{startDate} AND s.end_date = #{endDate} AND s.calced_YN = 'InProgress';
	</update>
	<update id="updateFeeAdjustment" parameterType="Map">
		<!-- 환불/교환 반영 : 3.수수료, 최종정산액 갱신 -->
		UPDATE settlement s SET 
		s.fee = FLOOR(s.pure_profit * 0.07), 
		s.final_amount = FLOOR(s.pure_profit - s.fee)
		WHERE s.start_date = #{startDate} AND s.end_date = #{endDate} AND s.calced_YN = 'InProgress';
	</update>
	
	<update id="settleCompleted" parameterType="Map">
	    <!-- 최종 상태 갱신 -->
	    UPDATE settlement
	    SET calced_YN = 'Completed',
	        deposited_date = NOW()
	    WHERE start_date = #{startDate} AND end_date = #{endDate} AND calced_YN = 'InProgress';
	</update>
	
	<!-- 미정산 리스트 조회 -->
	<select id="selectWaitingSettle" resultType="settlement">
		SELECT * FROM settlement
		WHERE calced_YN = 'Waiting'
	</select>
	
	
	<!-- 정산할 건 수 -->
	<select id="settlementCnt" resultType="Integer" parameterType="searchCondition">
		select count(*) from settlement
		where 1=1
		<if test="middleFilter != null and middleFilter != ''">
			<choose>
				<when test="middleFilter == 'Waiting'">
					and calced_YN = 'Waiting'
				</when>
				<when test="middleFilter == 'InProgress'">
					and calced_YN = 'InProgress'
				</when>
				<when test="middleFilter == 'Completed'">
					and calced_YN = 'Completed'
				</when>
				<when test="middleFilter == 'Error'">
					and calced_YN = 'Error'
				</when>
			</choose>
		</if>
		<if test="totalSearch != null and totalSearch != '' and keyword != null and keyword != ''">
			<choose>
				<when test="totalSearch == '브랜드'">
					and title like concat('%',#{keyword},'%')
				</when>
				<when test="totalSearch == '내용'">
					and content like concat('%',#{keyword},'%')
				</when>
			</choose>
		</if>
	</select>
	
	<!-- 정산 리스트 -->
	<select id="settlementAllList" resultType="settlement" parameterType="Map">
		select s.*, b.brand_name from settlement s
		join brand b on s.brand_id = b.brand_id
		order by settlement_id desc limit #{start_p},#{post_ea}
	</select>


	<!-- 정산리스트 (검색) -->
	<select id="settlementSearchList" resultType="settlement" parameterType="searchCondition">
		select *
		from settlement s
		where 1=1
		<if test="middleFilter != null and middleFilter != ''">
			<choose>
				<when test="middleFilter == 'Waiting'">
					and calced_YN = 'Waiting'
				</when>
				<when test="middleFilter == 'InProgress'">
					and calced_YN = 'InProgress'
				</when>
				<when test="middleFilter == 'Completed'">
					and calced_YN = 'Completed'
				</when>
				<when test="middleFilter == 'Error'">
					and calced_YN = 'Error'
				</when>
			</choose>
		</if>
		<if test="totalSearch != null and totalSearch != '' and keyword != null and keyword != ''">
			<choose>
				<when test="totalSearch == '브랜드명'">
					and title like concat('%',#{keyword},'%')
				</when>
				<when test="totalSearch == '내용'">
					and content like concat('%',#{keyword},'%')
				</when>
			</choose>
		</if>
		order by settlement_id desc limit #{start_p},#{post_ea}
	</select>
	
</mapper>