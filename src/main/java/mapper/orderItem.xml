<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.orderItem">
	<!-- ======================= [브랜드 어드민] 배송 목록 조회 ======================= -->
	<select id="selectShippingListForBrand" parameterType="map"
		resultType="shippingList">
		SELECT
		oi.order_item_id AS orderItemId,
		oi.order_id AS orderId,
		o.order_code AS orderCode,
		o.ship_recipient AS shipRecipient,
		o.ship_phone AS shipPhone,
		CONCAT(o.ship_postcode, ' ', o.ship_line1, '
		', o.ship_line2) AS shipAddress,
		o.note AS note,
		o.created_at AS
		orderDate,
		oi.tracking_no AS trackingNo,
		oi.carrier_name AS carrierName,
		oi.status AS status,
		(SELECT p2.name
		FROM order_item oi2
		JOIN product p2
		ON oi2.product_id = p2.product_id
		WHERE oi2.order_id = oi.order_id
		LIMIT 1) AS representProductName,
		(SELECT GROUP_CONCAT(p3.name
		SEPARATOR ', ')
		FROM order_item oi3
		JOIN product p3 ON oi3.product_id =
		p3.product_id
		WHERE oi3.order_id = oi.order_id) AS allProductNames,
		CASE
		WHEN oi.status IN ('SHIPPING','DELIVERED','COLLECTING','EXCHANGE
		SHIPPING') THEN oi.status
		ELSE 'DELIVERED'
		END AS displayStatus
		FROM
		order_item oi
		INNER JOIN orders o ON oi.order_id = o.orders_id

		<where>
			oi.brand_id = #{brandId}
			AND oi.status NOT IN
			('PAID','PREPARING','CANCELLED')

			<if test="startDate != null and startDate != ''">
				AND o.created_at &gt;= #{startDate}
			</if>
			<if test="endDate != null and endDate != ''">
				AND o.created_at &lt;= #{endDate}
			</if>

			<if test="status != null and status != ''">
				<choose>
					<when test="status == 'SHIPPING'">
						AND oi.status = 'SHIPPING'
					</when>
					<when test="status == 'DELIVERED'">
						AND (
						oi.status = 'DELIVERED'
						OR oi.status NOT IN
						('PAID','PREPARING','CANCELLED','SHIPPING','COLLECTING','EXCHANGE
						SHIPPING')
						)
					</when>
					<when test="status == 'COLLECTING'">
						AND oi.status = 'COLLECTING'
					</when>
					<when test="status == 'EXCHANGE SHIPPING'">
						AND oi.status = 'EXCHANGE SHIPPING'
					</when>
				</choose>
			</if>

			<if
				test="searchType != null and searchKeyword != null and searchKeyword != ''">
				<choose>
					<when test="searchType == 'RECIPIENT'">
						AND o.ship_recipient LIKE CONCAT('%',
						#{searchKeyword}, '%')
					</when>
					<when test="searchType == 'NAME'">
						AND (
						(SELECT GROUP_CONCAT(p3.name SEPARATOR ', ')
						FROM order_item oi3
						JOIN product p3 ON oi3.product_id =
						p3.product_id
						WHERE oi3.order_id = oi.order_id)
						LIKE CONCAT('%',
						#{searchKeyword}, '%')
						)
					</when>
					<when test="searchType == 'TRACKINGNO'">
						AND oi.tracking_no LIKE CONCAT('%',
						#{searchKeyword}, '%')
					</when>
				</choose>
			</if>
		</where>

		GROUP BY oi.order_id, oi.status
		ORDER BY oi.order_id DESC
		LIMIT #{limit}
		OFFSET #{offset}
	</select>


	<!-- ======================= [브랜드 어드민] 배송 건수 조회 ======================= -->
	<select id="selectShippingCountForBrand" parameterType="map"
		resultType="Integer">
		SELECT COUNT(*)
		FROM (
		SELECT oi.order_id, oi.status
		FROM order_item oi
		INNER JOIN orders o ON oi.order_id = o.orders_id

		<where>
			oi.brand_id = #{brandId}
			AND oi.status NOT IN
			('PAID','PREPARING','CANCELLED')

			<if test="startDate != null and startDate != ''">
				AND o.created_at &gt;= #{startDate}
			</if>
			<if test="endDate != null and endDate != ''">
				AND o.created_at &lt;= #{endDate}
			</if>

			<if test="status != null and status != ''">
				<choose>
					<when test="status == 'SHIPPING'">
						AND oi.status = 'SHIPPING'
					</when>
					<when test="status == 'DELIVERED'">
						AND (
						oi.status = 'DELIVERED'
						OR oi.status NOT IN
						('PAID','PREPARING','CANCELLED','SHIPPING','COLLECTING','EXCHANGE
						SHIPPING')
						)
					</when>
					<when test="status == 'COLLECTING'">
						AND oi.status = 'COLLECTING'
					</when>
					<when test="status == 'EXCHANGE SHIPPING'">
						AND oi.status = 'EXCHANGE SHIPPING'
					</when>
				</choose>
			</if>

			<if
				test="searchType != null and searchKeyword != null and searchKeyword != ''">
				<choose>
					<when test="searchType == 'RECIPIENT'">
						AND o.ship_recipient LIKE CONCAT('%',
						#{searchKeyword}, '%')
					</when>
					<when test="searchType == 'NAME'">
						AND (
						(SELECT GROUP_CONCAT(p3.name SEPARATOR ', ')
						FROM order_item oi3
						JOIN product p3 ON oi3.product_id =
						p3.product_id
						WHERE oi3.order_id = oi.order_id)
						LIKE CONCAT('%',
						#{searchKeyword}, '%')
						)
					</when>
					<when test="searchType == 'TRACKINGNO'">
						AND oi.tracking_no LIKE CONCAT('%',
						#{searchKeyword}, '%')
					</when>
				</choose>
			</if>
		</where>

		GROUP BY oi.order_id, oi.status
		) AS countTable
	</select>

	<!-- ======================= [브랜드 어드민] 배송 단일 조회 ======================= -->
	<select id="selectShippinDetailForBrand" parameterType="map"
		resultType="shippingList">
		SELECT
		oi.order_item_id AS orderItemId,
		oi.order_id AS orderId,
		o.order_code AS orderCode,
		o.ship_recipient AS shipRecipient,
		o.ship_phone AS shipPhone,
		CONCAT(o.ship_postcode, ' ', o.ship_line1, ' ', o.ship_line2) AS shipAddress,
		o.note AS note,
		o.created_at AS orderDate,
		oi.tracking_no AS trackingNo,
		oi.carrier_name AS carrierName,
		oi.status AS status,
		(SELECT p2.name
		FROM order_item oi2
		JOIN product p2 ON oi2.product_id = p2.product_id
		WHERE oi2.order_id = oi.order_id
		AND oi2.status = oi.status
		LIMIT 1) AS representProductName,
		(SELECT GROUP_CONCAT(p3.name SEPARATOR ', ')
		FROM order_item oi3
		JOIN product p3 ON oi3.product_id = p3.product_id
		WHERE oi3.order_id = oi.order_id
		AND oi3.status = oi.status) AS allProductNames,
		CASE
		WHEN oi.status IN ('SHIPPING','DELIVERED','COLLECTING','EXCHANGE
		SHIPPING') THEN oi.status
		ELSE 'DELIVERED'
		END AS displayStatus
		FROM order_item oi
		INNER JOIN orders o ON oi.order_id = o.orders_id
		<where>
			oi.order_id = #{orderId}
			AND oi.status = #{status}
			AND oi.brand_id = #{brandId}
		</where>
		LIMIT 1
	</select>

	<!-- ======================= [브랜드 어드민] 배송 상세 상품 목록 조회 ======================= -->
<select id="selectShippingDetailItemsForBrand"
        parameterType="map" resultType="shippingDetailItem">
    SELECT
        oi.order_item_id AS orderItemId,
        oi.product_id AS productId,
        oi.option_id AS optionId,
        p.name AS productName,
        po.option_value AS optionName,
        oi.quantity AS quantity,
        oi.status AS status,
        CASE
            WHEN oi.status IN ('SHIPPING','DELIVERED','COLLECTING','EXCHANGE SHIPPING') 
            THEN oi.status
            ELSE 'DELIVERED'
        END AS displayStatus
    FROM order_item oi
    INNER JOIN product p ON oi.product_id = p.product_id
    LEFT JOIN product_option po ON oi.option_id = po.product_option_id
    <where>
        oi.order_id = #{orderId}
        AND oi.status = #{status}
        AND oi.brand_id = #{brandId}
    </where>
    ORDER BY oi.order_item_id ASC
</select>


</mapper>