<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.product">
	<!--======================= 소비자용 ======================= -->
	<!-- 상품 상세 조회 (상품 상세 페이지용) -->
	<select id="selectProductByProductId" parameterType="Long"
		resultType="dto.Product">
		SELECT * FROM product
		WHERE product_id = #{productId}
		AND
		is_visible = 1
	</select>

	<!-- 상품 재고 업데이트 (주문 시) -->
	<update id="updateStock" parameterType="map">
		UPDATE product SET
		stock_qty = stock_qty - #{quantity}
		WHERE product_id = #{productId}
		AND
		has_option = 0 /* 옵션이 없는 상품만 */
		AND stock_qty >= #{quantity} /* 재고가 충분할
		때만 */
	</update>

	<!-- 상품의 실제 판매가격 계산 (할인 적용) -->
	<select id="selectCalculatedPrice" parameterType="long"
		resultType="map">
		SELECT
		product_id as productId,
		price as originalPrice,
		CASE
		WHEN discount_type = 'RATE' AND
		(start_date IS NULL OR start_date &lt;=
		NOW()) AND
		(end_date IS NULL OR end_date >= NOW())
		THEN ROUND(price * (1
		- discount_value / 100), 0)
		WHEN discount_type = 'AMOUNT' AND
		(start_date IS NULL OR start_date &lt;= NOW()) AND
		(end_date IS NULL OR
		end_date >= NOW())
		THEN price - discount_value
		ELSE price
		END as
		finalPrice,
		discount_type as discountType,
		discount_value as
		discountValue
		FROM product
		WHERE product_id = #{productId}
	</select>

	<!-- 장바구니/주문용 - 상품 기본 정보 조회 -->
	<select id="selectForOrder" parameterType="list"
		resultType="map">
		SELECT
		product_id as productId,
		name,
		price,
		order_limit as orderLimit,
		stock_qty as stockQty,
		has_option as hasOption,
		shipping_method as
		shippingMethod
		FROM product
		WHERE product_id IN
		<foreach collection="list" item="productId" open="("
			separator="," close=")">
			#{productId}
		</foreach>
		AND is_visible = 1
	</select>

	<!-- ========== [brandDetail 용도] 브랜드의 상품 목록 조회 ======== -->
	<select id="selectProductsByBrandId" parameterType="Long"
		resultType="map">
		SELECT
		product_id as productId,
		name as productName,
		price,
		thumbnail_file_id as thumbnailFileId,
		discount_type as discountType,
		discount_value as discountValue
		FROM product
		WHERE brand_id = #{brandId}
		AND is_visible = 1
		ORDER BY created_at DESC
	</select>

	<!-- ================[소비자] 기획상품 목록 조회 =================== -->
	<select id="selectPlannedProducts" parameterType="map"
		resultType="productPlan">
		SELECT
		p.product_id AS productId,
		p.brand_id AS brandId,
		p.has_option AS
		hasOption,
		b.brand_name AS brandName,
		p.name AS name,
		p.is_exclusive AS
		isExclusive,
		p.is_visible AS isVisible,
		p.is_planned AS isPlanned,
		p.category1_id AS category1Id,
		p.category2_id AS category2Id,
		p.category3_id AS category3Id,
		p.thumbnail_file_id AS thumbnailFileId,
		p.price AS price,
		p.discount_type AS discountType,
		p.discount_value AS
		discountValue,
		p.start_date AS startDate,
		p.end_date AS endDate,
		p.created_at AS createdAt,
		p.updated_at AS updatedAt,

		IFNULL(s.total_sold, 0) AS totalSold,
		IFNULL(r.review_count, 0) AS
		reviewCount,
		IFNULL(r.avg_rating, 0) AS avgRating,
		IFNULL(w.wish_count,
		0) AS wishCount,
		(
		(IFNULL(s.total_sold, 0) * 0.5) +
		(IFNULL(r.review_count, 0) * 0.2) +
		(IFNULL(r.avg_rating, 0) * 0.1) +
		(IFNULL(w.wish_count, 0) * 0.2)
		) AS popularityScore,
		CASE WHEN
		uw.wishlist_id IS NOT NULL
		THEN 1 ELSE 0 END AS isWished,
		CASE
		WHEN
		p.discount_type = 'RATE' THEN p.price - (p.price * p.discount_value /
		100)
		WHEN p.discount_type = 'AMOUNT' THEN p.price - p.discount_value
		ELSE p.price
		END AS finalPrice
		FROM product p
		JOIN brand b ON p.brand_id
		= b.brand_id
		LEFT JOIN (
		SELECT oi.product_id, SUM(oi.quantity) AS
		total_sold
		FROM
		order_item oi
		WHERE oi.status IN
		('PAID','PREPARING','SHIPPING','DELIVERED','CONFIRMED')
		AND
		oi.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
		GROUP BY
		oi.product_id
		) s ON p.product_id = s.product_id
		LEFT JOIN (
		SELECT
		rv.product_id,
		COUNT(rv.review_id) AS review_count,
		AVG(rv.rating) AS
		avg_rating
		FROM review rv
		WHERE rv.status = 'PUBLISHED'
		AND
		rv.questioned_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
		GROUP BY
		rv.product_id
		) r ON p.product_id = r.product_id
		LEFT JOIN (
		SELECT
		wl.product_id, COUNT(wl.wishlist_id) AS wish_count
		FROM
		wishlist wl
		WHERE wl.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
		GROUP BY
		wl.product_id
		) w ON p.product_id = w.product_id
		LEFT JOIN (
		SELECT
		wishlist_id, product_id
		FROM wishlist
		WHERE member_id
		= #{memberId}
		) uw
		ON p.product_id = uw.product_id

		WHERE p.is_planned = 1
		AND p.is_visible
		= 1

		<if test="category1Id != null">
			AND p.category1_id = #{category1Id}
		</if>

		<choose>
			<when test="sort == 'RECENT'">
				ORDER BY p.created_at DESC
			</when>
			<when test="sort == 'SALES'">
				ORDER BY totalSold DESC
			</when>
			<when test="sort == 'PRICELOW'">
				ORDER BY finalPrice ASC
			</when>
			<when test="sort == 'PRICEHIGH'">
				ORDER BY finalPrice DESC
			</when>
			<when test="sort == 'POPULAR'">
				ORDER BY popularityScore DESC
			</when>
			<otherwise>
				ORDER BY p.created_at DESC
			</otherwise>
		</choose>
		LIMIT #{offset}, #{limit}
	</select>

	<!-- ================[소비자] 기획상품 개수 조회 =================== -->
	<select id="selectPlannedProductsCount" parameterType="map"
		resultType="Integer">
		SELECT COUNT(*)
		FROM (
		SELECT p.product_id
		FROM product p
		LEFT JOIN (
		SELECT oi.product_id,
		SUM(oi.quantity) AS total_sold
		FROM order_item oi
		WHERE oi.status IN
		('PAID','PREPARING','SHIPPING','DELIVERED','CONFIRMED')
		AND
		oi.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
		GROUP BY
		oi.product_id
		) s ON p.product_id = s.product_id
		LEFT JOIN (
		SELECT
		rv.product_id,
		COUNT(rv.review_id) AS review_count,
		AVG(rv.rating) AS
		avg_rating
		FROM review rv
		WHERE rv.status = 'PUBLISHED'
		AND
		rv.questioned_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
		GROUP BY
		rv.product_id
		) r ON p.product_id = r.product_id
		LEFT JOIN (
		SELECT
		wl.product_id,
		COUNT(wl.wishlist_id) AS wish_count
		FROM wishlist wl
		WHERE wl.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
		GROUP BY
		wl.product_id
		) w ON p.product_id = w.product_id
		WHERE p.is_planned = 1
		AND p.is_visible = 1
		<if test="category1Id != null">
			AND p.category1_id = #{category1Id}
		</if>

		GROUP BY p.product_id
		) AS countTable
	</select>

	<!-- ================[소비자] 상품 랭킹 목록 조회 =================== -->
	<select id="selectRankingProducts" parameterType="map"
		resultType="productRank">
		SELECT
		p.product_id AS productId,
		p.brand_id AS brandId,
		p.has_option AS
		hasOption,
		b.brand_name AS brandName,
		p.name AS name,
		p.is_exclusive AS
		isExclusive,
		p.is_visible AS isVisible,
		p.is_planned AS isPlanned,
		p.category1_id AS category1Id,
		p.category2_id AS category2Id,
		p.category3_id AS category3Id,
		p.thumbnail_file_id AS thumbnailFileId,
		p.price AS price,
		p.discount_type AS discountType,
		p.discount_value AS
		discountValue,
		p.start_date AS startDate,
		p.end_date AS endDate,
		p.created_at AS createdAt,
		p.updated_at AS updatedAt,

		IFNULL(s.total_sold, 0) AS totalSold,
		IFNULL(r.review_count, 0) AS
		reviewCount,
		IFNULL(r.avg_rating, 0) AS avgRating,
		IFNULL(w.wish_count,
		0) AS wishCount,

		(
		(IFNULL(s.total_sold, 0) * 0.5) +
		(IFNULL(r.review_count, 0) * 0.2) +
		(IFNULL(r.avg_rating, 0) * 0.1) +
		(IFNULL(w.wish_count, 0) * 0.2)
		) AS popularityScore,

		CASE WHEN
		uw.wishlist_id IS NOT NULL
		THEN 1 ELSE 0 END AS isWished,

		CASE
		WHEN
		p.discount_type = 'RATE' THEN p.price - (p.price * p.discount_value /
		100)
		WHEN p.discount_type = 'AMOUNT' THEN p.price - p.discount_value
		ELSE p.price
		END AS finalPrice

		FROM product p
		JOIN brand b ON p.brand_id
		= b.brand_id

		LEFT JOIN (
		SELECT oi.product_id, SUM(oi.quantity) AS
		total_sold
		FROM order_item oi
		WHERE oi.status IN
		('PAID','PREPARING','SHIPPING','DELIVERED','CONFIRMED')
		AND
		oi.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
		GROUP BY
		oi.product_id
		) s ON p.product_id = s.product_id

		LEFT JOIN (
		SELECT
		rv.product_id, COUNT(rv.review_id) AS review_count, AVG(rv.rating) AS
		avg_rating
		FROM review rv
		WHERE rv.status = 'PUBLISHED'
		AND
		rv.questioned_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
		GROUP BY
		rv.product_id
		) r ON p.product_id = r.product_id

		LEFT JOIN (
		SELECT
		wl.product_id, COUNT(wl.wishlist_id) AS wish_count
		FROM wishlist wl
		WHERE wl.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
		GROUP BY
		wl.product_id
		) w ON p.product_id = w.product_id

		LEFT JOIN (
		SELECT
		wishlist_id, product_id
		FROM wishlist
		WHERE member_id = #{memberId}
		) uw
		ON p.product_id = uw.product_id

		WHERE p.is_visible = 1

		<if test="category1Id != null">
			AND p.category1_id = #{category1Id}
		</if>

		<choose>
			<when test="sort == 'RECENT'">
				ORDER BY p.created_at DESC
			</when>
			<when test="sort == 'SALES'">
				ORDER BY totalSold DESC
			</when>
			<when test="sort == 'PRICELOW'">
				ORDER BY finalPrice ASC
			</when>
			<when test="sort == 'PRICEHIGH'">
				ORDER BY finalPrice DESC
			</when>
			<when test="sort == 'POPULAR'">
				ORDER BY popularityScore DESC
			</when>
			<otherwise>
				ORDER BY p.created_at DESC
			</otherwise>
		</choose>

		LIMIT #{offset}, #{limit}
	</select>

	<!-- ================[소비자] 상품 랭킹 개수 조회 =================== -->
	<select id="selectRankingProductsCount" parameterType="map"
		resultType="Integer">
		SELECT COUNT(*)
		FROM (
		SELECT p.product_id
		FROM product p
		WHERE
		p.is_visible = 1
		<if test="category1Id != null">
			AND p.category1_id = #{category1Id}
		</if>
		GROUP BY p.product_id
		) AS countTable
	</select>





	<!--======================= [브랜드 어드민] 상품 목록 조회 ======================= -->
	<select id="selectProductListForBrand" parameterType="map"
		resultType="productList">
		SELECT
		p.product_id,
		p.name,
		CONCAT_WS(' > ', c1.name, c2.name, c3.name)
		AS category_path,
		p.price,
		p.stock_qty,
		p.is_visible,
		CASE
		WHEN
		p.discount_type = 'RATE'
		THEN p.price - (p.price * p.discount_value /
		100)
		WHEN p.discount_type = 'AMOUNT'
		THEN p.price - p.discount_value
		ELSE p.price
		END AS sale_price,
		CASE
		WHEN p.is_visible = 0 THEN
		'STOP_SALE'
		WHEN p.stock_qty > 0 THEN 'SALE'
		WHEN p.stock_qty = 0 THEN
		'SOLD_OUT'
		END AS status,
		IFNULL(oi.sales_qty, 0) AS sales_qty,
		IFNULL(r.review_count, 0) AS
		review_count
		FROM product p
		LEFT JOIN
		category c1 ON p.category1_id =
		c1.category_id
		LEFT JOIN category c2 ON
		p.category2_id = c2.category_id
		LEFT JOIN category c3 ON p.category3_id
		= c3.category_id
		LEFT JOIN (
		SELECT product_id, SUM(quantity) AS
		sales_qty
		FROM order_item
		GROUP BY
		product_id
		) oi ON p.product_id =
		oi.product_id
		LEFT JOIN (
		SELECT
		product_id, COUNT(*) AS review_count
		FROM review
		GROUP BY product_id
		) r
		ON p.product_id = r.product_id
		<where>
			<!-- 판매 상태 필터 -->
			<if test="status != null and status != ''">
				<choose>
					<when test="status == 'SALE'">
						AND p.is_visible = 1
						AND p.stock_qty > 0
					</when>
					<when test="status == 'SOLD_OUT'">
						AND p.is_visible = 1
						AND p.stock_qty = 0
					</when>
					<when test="status == 'STOP_SALE'">
						AND p.is_visible = 0
					</when>
				</choose>
			</if>

			<!-- 검색 필터 -->
			<if
				test="searchType != null and searchKeyword != null and searchKeyword != ''">
				<choose>
					<when test="searchType == 'NAME'">
						AND p.name LIKE CONCAT('%', #{searchKeyword}, '%')
					</when>
					<when test="searchType == 'CATEGORY'">
						AND (
						p.category1_id IN (
						SELECT category_id FROM
						category
						WHERE name LIKE CONCAT('%', #{searchKeyword}, '%')
						)
						OR
						p.category2_id IN (
						SELECT category_id FROM category
						WHERE name LIKE
						CONCAT('%', #{searchKeyword}, '%')
						)
						OR p.category3_id IN (
						SELECT
						category_id FROM category
						WHERE name LIKE CONCAT('%',
						#{searchKeyword}, '%')
						)
						)
					</when>
				</choose>
			</if>
		</where>
		ORDER BY p.product_id DESC
		LIMIT #{limit} OFFSET #{offset}
	</select>

	<!--======================= [브랜드 어드민] 상품 개수 조회 ======================= -->
	<select id="selectProductCountForBrand" parameterType="map"
		resultType="Integer">
		SELECT COUNT(*)
		FROM (
		SELECT p.product_id
		FROM product p
		LEFT JOIN
		category c1 ON p.category1_id = c1.category_id
		LEFT JOIN category c2 ON
		p.category2_id = c2.category_id
		LEFT JOIN category c3 ON p.category3_id
		= c3.category_id
		<where>
			<!-- 판매 상태 필터 -->
			<if test="status != null and status != ''">
				<choose>
					<when test="status == 'SALE'">
						AND p.stock_qty > 0
					</when>
					<when test="status == 'SOLD_OUT'">
						AND p.stock_qty = 0
					</when>
					<when test="status == 'STOP_SALE'">
						AND p.is_visible = 0
					</when>
				</choose>
			</if>

			<!-- 검색 필터 -->
			<if
				test="searchType != null and searchKeyword != null and searchKeyword != ''">
				<choose>
					<when test="searchType == 'NAME'">
						AND p.name LIKE CONCAT('%', #{searchKeyword}, '%')
					</when>
					<when test="searchType == 'CATEGORY'">
						AND (
						p.category1_id IN (SELECT category_id FROM
						category WHERE name LIKE CONCAT('%',
						#{searchKeyword}, '%'))
						OR
						p.category2_id IN (SELECT category_id FROM category WHERE name
						LIKE CONCAT('%', #{searchKeyword}, '%'))
						OR p.category3_id IN
						(SELECT category_id FROM category WHERE name
						LIKE CONCAT('%',
						#{searchKeyword}, '%'))
						)
					</when>
				</choose>
			</if>
		</where>
		GROUP BY p.product_id
		) AS countTable
	</select>

	<!--======================= [브랜드 어드민] 상품 재고 변경 ======================= -->
	<update id="updateStockForBrand" parameterType="map">
		UPDATE product
		SET stock_qty = #{newStock}
		WHERE product_id = #{productId}
	</update>

	<!--======================= [브랜드 어드민] 상품 공개 여부 토글 ======================= -->
	<update id="toggleVisibilityForBrand" parameterType="long">
		UPDATE
		product
		SET is_visible = CASE WHEN is_visible = 1 THEN 0 ELSE 1 END
		WHERE product_id = #{productId}
	</update>

	<!--======================= [브랜드 어드민] 세일 등록 ======================= -->
	<update id="registerSaleForBrand" parameterType="map">
		UPDATE product
		SET discount_type = #{discountType},
		discount_value =
		#{discountValue},
		sale_start = #{startDate},
		sale_end = #{endDate}
		WHERE
		product_id IN
		<foreach item="id" collection="productIds" open="("
			separator="," close=")">
			#{id}
		</foreach>
	</update>

	<!--======================= [브랜드 어드민] 단일 상품 상세 조회 ======================= -->
	<select id="selectProductForBrand" parameterType="long"
		resultType="productDetail">
		SELECT
		p.product_id,
		p.brand_id,
		p.name,
		p.is_exclusive,
		p.is_visible,
		p.is_planned,
		p.category1_id,
		p.category2_id,
		p.category3_id,
		p.thumbnail_file_id,
		p.image1_file_id,
		p.image2_file_id,
		p.image3_file_id,
		p.image4_file_id,
		p.image5_file_id,
		p.ingredients,
		p.price,
		p.order_limit,
		p.has_option,
		p.stock_qty,
		p.shipping_method,
		p.discount_type,
		CASE
		WHEN p.discount_type = 'RATE'
		THEN p.price -
		(p.price * p.discount_value / 100)
		WHEN p.discount_type = 'AMOUNT'
		THEN
		p.price - p.discount_value
		ELSE p.price
		END AS sale_price,
		p.created_at,
		p.updated_at,
		GROUP_CONCAT(CASE WHEN cm.code_group = 'SKIN_ISSUE'
		THEN
		CONCAT(cd.code, ':', cd.name) END) AS skin_issues,
		GROUP_CONCAT(CASE
		WHEN cm.code_group = 'SKIN_TYPE'
		THEN CONCAT(cd.code, ':', cd.name)
		END) AS skin_types,
		GROUP_CONCAT(CASE WHEN cm.code_group =
		'PERSONAL_COLOR'
		THEN CONCAT(cd.code, ':', cd.name) END) AS
		personal_colors
		FROM product p
		LEFT JOIN product_filter_map pf ON
		p.product_id = pf.product_id
		LEFT JOIN code_detail cd ON pf.filter_id =
		cd.code_detail_id
		LEFT JOIN code_master cm ON cd.code_master_id =
		cm.code_master_id
		WHERE p.product_id = #{productId}
		GROUP BY
		p.product_id
	</select>

	<!--======================= [브랜드 어드민] 상품 등록 ======================= -->
	<insert id="insertProductForBrand" parameterType="productDetail"
		useGeneratedKeys="true" keyProperty="productId">
		INSERT INTO product (
		brand_id,
		name, is_exclusive, is_visible, is_planned,
		category1_id, category2_id,
		category3_id,
		thumbnail_file_id,
		image1_file_id, image2_file_id,
		image3_file_id, image4_file_id, image5_file_id,
		ingredients, price,
		order_limit,
		has_option, stock_qty,
		shipping_method
		) VALUES (
		#{brandId}, #{name},
		#{isExclusive}, #{isVisible}, #{isPlanned},
		#{category1Id}, #{category2Id}, #{category3Id},
		#{thumbnailFileId},
		#{image1FileId}, #{image2FileId}, #{image3FileId}, #{image4FileId},
		#{image5FileId},
		#{ingredients}, #{price}, #{orderLimit},
		#{hasOption},
		#{stockQty},
		#{shippingMethod}
		)
	</insert>

	<!--======================= [브랜드 어드민] 상품 수정 ======================= -->
	<update id="updateProductForBrand" parameterType="productDetail">
		UPDATE product
		<set>
			name = #{name},
			is_exclusive = #{isExclusive},
			is_visible =
			#{isVisible},
			is_planned = #{isPlanned},
			category1_id = #{category1Id},
			category2_id = #{category2Id},
			category3_id = #{category3Id},
			ingredients = #{ingredients},
			price = #{price},
			order_limit =
			#{orderLimit},
			has_option = #{hasOption},
			stock_qty = #{stockQty},
			shipping_method = #{shippingMethod},

			<!-- 이미지: 값이 null이 아닐 때만 업데이트 -->
			<if test="thumbnailFileId != null">
				thumbnail_file_id = #{thumbnailFileId},
			</if>
			<if test="image1FileId != null">
				image1_file_id = #{image1FileId},
			</if>
			<if test="image2FileId != null">
				image2_file_id = #{image2FileId},
			</if>
			<if test="image3FileId != null">
				image3_file_id = #{image3FileId},
			</if>
			<if test="image4FileId != null">
				image4_file_id = #{image4FileId},
			</if>
			<if test="image5FileId != null">
				image5_file_id = #{image5FileId},
			</if>

			updated_at = NOW()
		</set>
		WHERE product_id = #{productId}
	</update>

</mapper>