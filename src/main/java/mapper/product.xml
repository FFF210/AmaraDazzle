<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.product">
	<!--======================= 소비자용 ======================= -->
	<!-- 상품 상세 조회 (상품 상세 페이지용) -->
	<select id="selectProductByProductId" parameterType="Long"
		resultType="dto.Product">
		SELECT * FROM product
		WHERE product_id = #{productId}
		AND
		is_visible = 1
	</select>

	<!-- 전체 상품 목록 조회 (페이징) -->
	<select id="selectAllProducts" parameterType="map"
		resultType="dto.Product">
		SELECT * FROM product
		WHERE is_visible = 1
		ORDER BY
		created_at
		DESC
		LIMIT #{offset}, #{limit}
	</select>

	<!-- 카테고리별 상품 목록 조회 Id 수정했음!!!!! -->
	<select id="selectProductByCategory" parameterType="map"
		resultType="dto.Product">
		SELECT * FROM product
		WHERE category_id = #{categoryId}
		AND
		is_visible = 1
		ORDER BY created_at DESC
		LIMIT #{offset}, #{limit}
	</select>

	<!-- 브랜드별 상품 목록 조회 -->
	<select id="selectProductByBrand" parameterType="map"
		resultType="dto.Product">
		SELECT * FROM product
		WHERE brand_id = #{brandId}
		AND
		is_visible = 1
		ORDER BY created_at DESC
		LIMIT #{offset}, #{limit}
	</select>

	<!-- 상품 검색 (상품명으로) -->
	<select id="searchProductByName" parameterType="map"
		resultType="dto.Product">
		SELECT * FROM product
		WHERE name LIKE CONCAT('%',
		#{keyword},
		'%')
		AND is_visible = 1
		ORDER BY created_at DESC
		LIMIT
		#{offset},
		#{limit}
	</select>

	<!-- 신상품 목록 조회 (최근 등록순) -->
	<select id="selectNewProducts" parameterType="map"
		resultType="dto.Product">
		SELECT * FROM product
		WHERE is_visible = 1
		ORDER BY
		created_at
		DESC
		LIMIT #{limit}
	</select>

	<!-- 인기상품 목록 조회 (판매량 기준 - 별도 테이블 조인 필요할 수 있음) -->
	<select id="selectPopularProducts" parameterType="map"
		resultType="dto.Product">
		SELECT p.* FROM product p
		WHERE p.is_visible = 1
		ORDER BY
		p.created_at DESC
		LIMIT #{limit}
	</select>

	<!-- 할인 상품 목록 조회 -->
	<select id="selectDiscountProducts" parameterType="map"
		resultType="dto.Product">
		SELECT * FROM product
		WHERE is_visible = 1
		AND discount_type
		IS NOT NULL
		AND discount_value > 0
		AND (start_date IS NULL OR start_date
		&lt;= NOW())
		AND (end_date IS NULL OR end_date >= NOW())
		ORDER BY
		discount_value DESC
		LIMIT #{offset}, #{limit}
	</select>

	<!-- 기획상품 목록 조회 -->
	<select id="selectPlannedProducts" parameterType="map"
		resultType="dto.Product">
		SELECT * FROM product
		WHERE is_planned = 1
		AND is_visible = 1
		ORDER BY created_at DESC
		LIMIT #{offset}, #{limit}
	</select>

	<!-- 상품 재고 확인 -->
	<select id="selectStockQty" parameterType="long"
		resultType="int">
		SELECT
		CASE
		WHEN has_option = 1 THEN -1 /* 옵션이 있으면 별도 체크 필요
		*/
		ELSE stock_qty
		END as stockQty
		FROM product
		WHERE product_id =
		#{productId}
	</select>

	<!-- 상품 재고 업데이트 (주문 시) -->
	<update id="updateStock" parameterType="map">
		UPDATE product SET
		stock_qty = stock_qty - #{quantity}
		WHERE product_id = #{productId}
		AND
		has_option = 0 /* 옵션이 없는 상품만 */
		AND stock_qty >= #{quantity} /* 재고가 충분할
		때만 */
	</update>

	<!-- 상품의 실제 판매가격 계산 (할인 적용) -->
	<select id="selectCalculatedPrice" parameterType="long"
		resultType="map">
		SELECT
		product_id as productId,
		price as originalPrice,
		CASE
		WHEN discount_type = 'RATE' AND
		(start_date IS NULL OR start_date &lt;=
		NOW()) AND
		(end_date IS NULL OR end_date >= NOW())
		THEN ROUND(price * (1
		- discount_value / 100), 0)
		WHEN discount_type = 'AMOUNT' AND
		(start_date IS NULL OR start_date &lt;= NOW()) AND
		(end_date IS NULL OR
		end_date >= NOW())
		THEN price - discount_value
		ELSE price
		END as
		finalPrice,
		discount_type as discountType,
		discount_value as
		discountValue
		FROM product
		WHERE product_id = #{productId}
	</select>

	<!-- 상품 목록 총 개수 (페이징용) -->
	<select id="countAllProducts" resultType="int">
		SELECT COUNT(*) FROM
		product
		WHERE is_visible = 1
	</select>

	<!-- 검색 결과 총 개수 -->
	<select id="countSearchResults" parameterType="string"
		resultType="int">
		SELECT COUNT(*) FROM product
		WHERE name LIKE CONCAT('%',
		#{keyword}, '%')
		AND is_visible = 1
	</select>

	<!-- 장바구니/주문용 - 상품 기본 정보 조회 -->
	<select id="selectForOrder" parameterType="list"
		resultType="map">
		SELECT
		product_id as productId,
		name,
		price,
		order_limit as orderLimit,
		stock_qty as stockQty,
		has_option as hasOption,
		shipping_method as
		shippingMethod
		FROM product
		WHERE product_id IN
		<foreach collection="list" item="productId" open="("
			separator="," close=")">
			#{productId}
		</foreach>
		AND is_visible = 1
	</select>

	<!--======================= [브랜드 어드민] 상품 목록 조회 ======================= -->
	<select id="selectProductListForBrand" parameterType="map"
		resultType="productList">
		SELECT
		p.product_id,
		p.name,
		CONCAT_WS(' > ', c1.name, c2.name, c3.name)
		AS category_path,
		p.price,
		p.stock_qty,
		p.is_visible,
		CASE
		WHEN
		p.discount_type = 'RATE'
		THEN p.price - (p.price * p.discount_value /
		100)
		WHEN p.discount_type = 'AMOUNT'
		THEN p.price - p.discount_value
		ELSE p.price
		END AS sale_price,
		CASE
		WHEN p.is_visible = 0 THEN
		'STOP_SALE'
		WHEN p.stock_qty > 0 THEN 'SALE'
		WHEN p.stock_qty = 0 THEN
		'SOLD_OUT'
		END AS status,
		IFNULL(oi.sales_qty, 0) AS sales_qty,
		IFNULL(r.review_count, 0) AS
		review_count
		FROM product p
		LEFT JOIN
		category c1 ON p.category1_id =
		c1.category_id
		LEFT JOIN category c2 ON
		p.category2_id = c2.category_id
		LEFT JOIN category c3 ON p.category3_id
		= c3.category_id
		LEFT JOIN (
		SELECT product_id, SUM(quantity) AS
		sales_qty
		FROM order_item
		GROUP BY
		product_id
		) oi ON p.product_id =
		oi.product_id
		LEFT JOIN (
		SELECT
		product_id, COUNT(*) AS review_count
		FROM review
		GROUP BY product_id
		) r
		ON p.product_id = r.product_id
		<where>
			<!-- 판매 상태 필터 -->
			<if test="status != null and status != ''">
				<choose>
					<when test="status == 'SALE'">
						AND p.is_visible = 1
						AND p.stock_qty > 0
					</when>
					<when test="status == 'SOLD_OUT'">
						AND p.is_visible = 1
						AND p.stock_qty = 0
					</when>
					<when test="status == 'STOP_SALE'">
						AND p.is_visible = 0
					</when>
				</choose>
			</if>

			<!-- 검색 필터 -->
			<if
				test="searchType != null and searchKeyword != null and searchKeyword != ''">
				<choose>
					<when test="searchType == 'NAME'">
						AND p.name LIKE CONCAT('%', #{searchKeyword}, '%')
					</when>
					<when test="searchType == 'CATEGORY'">
						AND (
						p.category1_id IN (
						SELECT category_id FROM
						category
						WHERE name LIKE CONCAT('%', #{searchKeyword}, '%')
						)
						OR
						p.category2_id IN (
						SELECT category_id FROM category
						WHERE name LIKE
						CONCAT('%', #{searchKeyword}, '%')
						)
						OR p.category3_id IN (
						SELECT
						category_id FROM category
						WHERE name LIKE CONCAT('%',
						#{searchKeyword}, '%')
						)
						)
					</when>
				</choose>
			</if>
		</where>
		ORDER BY p.product_id DESC
		LIMIT #{limit} OFFSET #{offset}
	</select>


	<!--======================= [브랜드 어드민] 상품 개수 조회 ======================= -->
	<select id="selectProductCountForBrand" parameterType="map"
		resultType="Integer">
		SELECT COUNT(*)
		FROM (
		SELECT p.product_id
		FROM product p
		LEFT JOIN
		category c1 ON p.category1_id = c1.category_id
		LEFT JOIN category c2 ON
		p.category2_id = c2.category_id
		LEFT JOIN category c3 ON p.category3_id
		= c3.category_id
		<where>
			<!-- 판매 상태 필터 -->
			<if test="status != null and status != ''">
				<choose>
					<when test="status == 'SALE'">
						AND p.stock_qty > 0
					</when>
					<when test="status == 'SOLD_OUT'">
						AND p.stock_qty = 0
					</when>
					<when test="status == 'STOP_SALE'">
						AND p.is_visible = 0
					</when>
				</choose>
			</if>

			<!-- 검색 필터 -->
			<if
				test="searchType != null and searchKeyword != null and searchKeyword != ''">
				<choose>
					<when test="searchType == 'NAME'">
						AND p.name LIKE CONCAT('%', #{searchKeyword}, '%')
					</when>
					<when test="searchType == 'CATEGORY'">
						AND (
						p.category1_id IN (SELECT category_id FROM
						category WHERE name LIKE CONCAT('%',
						#{searchKeyword}, '%'))
						OR
						p.category2_id IN (SELECT category_id FROM category WHERE name
						LIKE CONCAT('%', #{searchKeyword}, '%'))
						OR p.category3_id IN
						(SELECT category_id FROM category WHERE name
						LIKE CONCAT('%',
						#{searchKeyword}, '%'))
						)
					</when>
				</choose>
			</if>
		</where>
		GROUP BY p.product_id
		) AS countTable
	</select>

	<!--======================= [브랜드 어드민] 상품 재고 변경 ======================= -->
	<update id="updateStockForBrand" parameterType="map">
		UPDATE product
		SET stock_qty = #{newStock}
		WHERE product_id = #{productId}
	</update>

	<!--======================= [브랜드 어드민] 상품 공개 여부 토글 ======================= -->
	<update id="toggleVisibilityForBrand" parameterType="long">
		UPDATE
		product
		SET is_visible = CASE WHEN is_visible = 1 THEN 0 ELSE 1 END
		WHERE product_id = #{productId}
	</update>

	<!--======================= [브랜드 어드민] 세일 등록 ======================= -->
	<update id="registerSaleForBrand" parameterType="map">
		UPDATE product
		SET discount_type = #{discountType},
		discount_value =
		#{discountValue},
		sale_start = #{startDate},
		sale_end = #{endDate}
		WHERE
		product_id IN
		<foreach item="id" collection="productIds" open="("
			separator="," close=")">
			#{id}
		</foreach>
	</update>

	<!--======================= [브랜드 어드민] 단일 상품 상세 조회 ======================= -->
	<select id="selectProductForBrand" parameterType="long"
		resultType="productDetail">
		SELECT
		p.product_id,
		p.brand_id,
		p.name,
		p.is_exclusive,
		p.is_visible,
		p.is_planned,
		p.category1_id,
		p.category2_id,
		p.category3_id,
		uf_thumb.storage_path AS thumb_path,
		uf_thumb.file_rename AS thumb_file,
		uf1.storage_path AS image1_path,
		uf1.file_rename AS image1_file,
		uf2.storage_path AS image2_path,
		uf2.file_rename AS image2_file,
		uf3.storage_path AS image3_path,
		uf3.file_rename AS image3_file,
		uf4.storage_path AS image4_path,
		uf4.file_rename AS image4_file,
		uf5.storage_path AS image5_path,
		uf5.file_rename AS image5_file,
		p.ingredients,
		p.price,
		p.order_limit,
		p.has_option,
		p.stock_qty,
		p.shipping_method,
		p.discount_type,
		CASE
		WHEN
		p.discount_type = 'RATE'
		THEN p.price - (p.price * p.discount_value /
		100)
		WHEN p.discount_type = 'AMOUNT'
		THEN p.price - p.discount_value
		ELSE p.price
		END AS sale_price,
		p.created_at,
		p.updated_at,
		GROUP_CONCAT(CASE WHEN cm.code_group = 'SKIN_ISSUE'
		THEN
		CONCAT(cd.code, ':', cd.name) END) AS skin_issues,
		GROUP_CONCAT(CASE
		WHEN cm.code_group = 'SKIN_TYPE'
		THEN CONCAT(cd.code, ':', cd.name)
		END) AS skin_types,
		GROUP_CONCAT(CASE WHEN cm.code_group =
		'PERSONAL_COLOR'
		THEN CONCAT(cd.code, ':', cd.name) END) AS
		personal_colors
		FROM product p
		LEFT JOIN upload_file uf_thumb ON
		p.thumbnail_file_id =
		uf_thumb.upload_file_id
		LEFT JOIN upload_file uf1
		ON p.image1_file_id = uf1.upload_file_id
		LEFT JOIN upload_file uf2 ON
		p.image2_file_id = uf2.upload_file_id
		LEFT JOIN upload_file uf3 ON
		p.image3_file_id = uf3.upload_file_id
		LEFT JOIN upload_file uf4 ON
		p.image4_file_id = uf4.upload_file_id
		LEFT JOIN upload_file uf5 ON
		p.image5_file_id = uf5.upload_file_id
		LEFT JOIN product_filter_map pf
		ON p.product_id = pf.product_id
		LEFT JOIN code_detail cd ON
		pf.filter_id = cd.code_detail_id
		LEFT JOIN code_master cm ON
		cd.code_master_id = cm.code_master_id
		WHERE p.product_id = #{productId}
		GROUP BY p.product_id
	</select>

	<!--======================= [브랜드 어드민] 상품 등록 ======================= -->
	<insert id="insertProductForBrand" parameterType="productDetail" useGeneratedKeys="true" keyProperty="productId">
		INSERT INTO product (
		brand_id, name, is_exclusive, is_visible, is_planned,
		category1_id,
		category2_id, category3_id,
		ingredients, price, order_limit,
		has_option, stock_qty,
		shipping_method
		) VALUES (
		#{brandId}, #{name},
		#{isExclusive}, #{isVisible}, #{isPlanned},
		#{category1Id},
		#{category2Id}, #{category3Id},
		#{ingredients},
		#{price}, #{orderLimit},
		#{hasOption}, #{stockQty},
		#{shippingMethod}
		)
	</insert>

	<!--======================= [브랜드 어드민] 상품 수정 ======================= -->
	<update id="updateProductForBrand" parameterType="productDetail">
		UPDATE product
		SET name
		= #{name},
		is_exclusive =
		#{isExclusive},
		is_visible = #{isVisible},
		is_planned = #{isPlanned},
		category1_id = #{category1Id},
		category2_id =
		#{category2Id},
		category3_id = #{category3Id},
		ingredients =
		#{ingredients},
		price =
		#{price},
		order_limit = #{orderLimit},
		has_option
		= #{hasOption},
		stock_qty = #{stockQty},
		shipping_method =
		#{shippingMethod},
		updated_at = NOW()
		WHERE product_id = #{productId}
	</update>

</mapper>