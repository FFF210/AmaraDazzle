<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.product">

	<!-- Product 객체와 DB 컬럼 매핑 -->
	<resultMap id="productResultMap" type="dto.Product">
		<id property="productId" column="product_id" />
		<result property="brandId" column="brand_id" />
		<result property="name" column="name" />
		<result property="isExclusive" column="is_exclusive" />
		<result property="isVisible" column="is_visible" />
		<result property="isPlanned" column="is_planned" />
		<result property="categoryId" column="category_id" />
		<result property="thumbnailFileId" column="thumbnail_file_id" />
		<result property="image1FileId" column="image1_file_id" />
		<result property="image2FileId" column="image2_file_id" />
		<result property="image3FileId" column="image3_file_id" />
		<result property="image4FileId" column="image4_file_id" />
		<result property="image5FileId" column="image5_file_id" />
		<result property="ingredients" column="ingredients" />
		<result property="price" column="price" />
		<result property="orderLimit" column="order_limit" />
		<result property="hasOption" column="has_option" />
		<result property="stockQty" column="stock_qty" />
		<result property="shippingMethod" column="shipping_method" />
		<result property="discountType" column="discount_type" />
		<result property="discountValue" column="discount_value" />
		<result property="startDate" column="start_date" />
		<result property="endDate" column="end_date" />
		<result property="eventId" column="event_id" />
		<result property="createdAt" column="created_at" />
		<result property="updatedAt" column="updated_at" />
	</resultMap>

	<!-- 상품 상세 조회 (상품 상세 페이지용) -->
	<select id="selectById" parameterType="long"
		resultMap="productResultMap">
		SELECT * FROM product
		WHERE product_id = #{productId}
		AND
		is_visible = 1
	</select>

	<!-- 전체 상품 목록 조회 (페이징) -->
	<select id="selectAllProducts" parameterType="map"
		resultMap="productResultMap">
		SELECT * FROM product
		WHERE is_visible = 1
		ORDER BY created_at
		DESC
		LIMIT #{offset}, #{limit}
	</select>

	<!-- 카테고리별 상품 목록 조회 -->
	<select id="selectByCategory" parameterType="map"
		resultMap="productResultMap">
		SELECT * FROM product
		WHERE category_id = #{categoryId}
		AND
		is_visible = 1
		ORDER BY created_at DESC
		LIMIT #{offset}, #{limit}
	</select>

	<!-- 브랜드별 상품 목록 조회 -->
	<select id="selectByBrand" parameterType="map"
		resultMap="productResultMap">
		SELECT * FROM product
		WHERE brand_id = #{brandId}
		AND
		is_visible = 1
		ORDER BY created_at DESC
		LIMIT #{offset}, #{limit}
	</select>

	<!-- 상품 검색 (상품명으로) -->
	<select id="searchByName" parameterType="map"
		resultMap="productResultMap">
		SELECT * FROM product
		WHERE name LIKE CONCAT('%', #{keyword},
		'%')
		AND is_visible = 1
		ORDER BY created_at DESC
		LIMIT #{offset},
		#{limit}
	</select>

	<!-- 신상품 목록 조회 (최근 등록순) -->
	<select id="selectNewProducts" parameterType="map"
		resultMap="productResultMap">
		SELECT * FROM product
		WHERE is_visible = 1
		ORDER BY created_at
		DESC
		LIMIT #{limit}
	</select>

	<!-- 인기상품 목록 조회 (판매량 기준 - 별도 테이블 조인 필요할 수 있음) -->
	<select id="selectPopularProducts" parameterType="map"
		resultMap="productResultMap">
		SELECT p.* FROM product p
		WHERE p.is_visible = 1
		ORDER BY
		p.created_at DESC
		LIMIT #{limit}
	</select>

	<!-- 할인 상품 목록 조회 -->
	<select id="selectDiscountProducts" parameterType="map"
		resultMap="productResultMap">
		SELECT * FROM product
		WHERE is_visible = 1
		AND discount_type
		IS NOT NULL
		AND discount_value > 0
		AND (start_date IS NULL OR start_date
		&lt;= NOW())
		AND (end_date IS NULL OR end_date >= NOW())
		ORDER BY
		discount_value DESC
		LIMIT #{offset}, #{limit}
	</select>

	<!-- 기획상품 목록 조회 -->
	<select id="selectPlannedProducts" parameterType="map"
		resultMap="productResultMap">
		SELECT * FROM product
		WHERE is_planned = 1
		AND is_visible = 1
		ORDER BY created_at DESC
		LIMIT #{offset}, #{limit}
	</select>

	<!-- 상품 재고 확인 -->
	<select id="selectStockQty" parameterType="long"
		resultType="int">
		SELECT
		CASE
		WHEN has_option = 1 THEN -1 /* 옵션이 있으면 별도 체크 필요
		*/
		ELSE stock_qty
		END as stockQty
		FROM product
		WHERE product_id =
		#{productId}
	</select>

	<!-- 상품 재고 업데이트 (주문 시) -->
	<update id="updateStock" parameterType="map">
		UPDATE product SET
		stock_qty = stock_qty - #{quantity}
		WHERE product_id = #{productId}
		AND
		has_option = 0 /* 옵션이 없는 상품만 */
		AND stock_qty >= #{quantity} /* 재고가 충분할
		때만 */
	</update>

	<!-- 상품의 실제 판매가격 계산 (할인 적용) -->
	<select id="selectCalculatedPrice" parameterType="long"
		resultType="map">
		SELECT
		product_id as productId,
		price as originalPrice,
		CASE
		WHEN discount_type = 'RATE' AND
		(start_date IS NULL OR start_date &lt;=
		NOW()) AND
		(end_date IS NULL OR end_date >= NOW())
		THEN ROUND(price * (1
		- discount_value / 100), 0)
		WHEN discount_type = 'AMOUNT' AND
		(start_date IS NULL OR start_date &lt;= NOW()) AND
		(end_date IS NULL OR
		end_date >= NOW())
		THEN price - discount_value
		ELSE price
		END as
		finalPrice,
		discount_type as discountType,
		discount_value as
		discountValue
		FROM product
		WHERE product_id = #{productId}
	</select>

	<!-- 상품 목록 총 개수 (페이징용) -->
	<select id="countAllProducts" resultType="int">
		SELECT COUNT(*) FROM
		product
		WHERE is_visible = 1
	</select>

	<!-- 검색 결과 총 개수 -->
	<select id="countSearchResults" parameterType="string"
		resultType="int">
		SELECT COUNT(*) FROM product
		WHERE name LIKE CONCAT('%',
		#{keyword}, '%')
		AND is_visible = 1
	</select>

	<!-- 장바구니/주문용 - 상품 기본 정보 조회 -->
	<select id="selectForOrder" parameterType="list"
		resultType="map">
		SELECT
		product_id as productId,
		name,
		price,
		order_limit as orderLimit,
		stock_qty as stockQty,
		has_option as hasOption,
		shipping_method as
		shippingMethod
		FROM product
		WHERE product_id IN
		<foreach collection="list" item="productId" open="("
			separator="," close=")">
			#{productId}
		</foreach>
		AND is_visible = 1
	</select>

	<!--======================= [브랜드 어드민] 상품 목록 조회 ======================= -->
	<select id="selectProductListForBrand" parameterType="map"
		resultType="ProductList">
		SELECT
		p.product_id,
		p.name,
		CONCAT_WS(' > ', c1.name, c2.name, c3.name) AS category_path,
		p.price,
		p.stock_qty,
		p.is_visible,
		CASE
		WHEN p.discount_type = 'RATE'
		THEN p.price - (p.price * p.discount_value / 100)
		WHEN p.discount_type = 'AMOUNT'
		THEN p.price - p.discount_value
		ELSE p.price
		END AS sale_price,
		COALESCE(SUM(oi.quantity), 0) AS sales_qty,
		COALESCE(COUNT(r.product_id), 0) AS review_count
		FROM product p
		LEFT JOIN category c1 ON p.category1_id = c1.category_id
		LEFT JOIN category c2 ON p.category2_id = c2.category_id
		LEFT JOIN category c3 ON p.category3_id = c3.category_id
		LEFT JOIN order_item oi ON p.product_id = oi.product_id
		LEFT JOIN review r ON p.product_id = r.product_id
		<where>
			<!-- 판매 상태 필터 -->
			<if test="status != null and status != ''">
				<choose>
					<when test="status == 'SALE'">
						AND p.stock_qty > 0
					</when>
					<when test="status == 'SOLD_OUT'">
						AND p.stock_qty = 0
					</when>
					<when test="status == 'STOP_SALE'">
						AND p.is_visible = 0
					</when>
				</choose>
			</if>

			<!-- 검색 필터 -->
			<if
				test="searchType != null and searchKeyword != null and searchKeyword != ''">
				<choose>
					<when test="searchType == 'NAME'">
						AND p.name LIKE CONCAT('%', #{searchKeyword}, '%')
					</when>
					<when test="searchType == 'CATEGORY'">
						AND (
						p.category1_id IN (
						SELECT category_id FROM category
						WHERE name LIKE CONCAT('%', #{searchKeyword}, '%')
						)
						OR p.category2_id IN (
						SELECT category_id FROM category
						WHERE name LIKE CONCAT('%', #{searchKeyword}, '%')
						)
						OR p.category3_id IN (
						SELECT category_id FROM category
						WHERE name LIKE CONCAT('%', #{searchKeyword}, '%')
						)
						)
					</when>
				</choose>
			</if>
		</where>
		GROUP BY p.product_id, p.name, c1.name, c2.name, c3.name,
		p.price, p.discount_type, p.discount_value,
		p.stock_qty, p.is_visible
		ORDER BY p.product_id DESC
		LIMIT #{limit} OFFSET #{offset}
	</select>


	<!--======================= [브랜드 어드민] 상품 개수 조회 ======================= -->
	<select id="selectProductCountForBrand" parameterType="map"
		resultType="Integer">
		SELECT COUNT(*)
		FROM (
		SELECT p.product_id
		FROM product p
		LEFT JOIN category c1 ON p.category1_id = c1.category_id
		LEFT JOIN category c2 ON p.category2_id = c2.category_id
		LEFT JOIN category c3 ON p.category3_id = c3.category_id
		LEFT JOIN order_item oi ON p.product_id = oi.product_id
		LEFT JOIN review r ON p.product_id = r.product_id
		<where>
			<!-- 판매 상태 필터 -->
			<if test="status != null and status != ''">
				<choose>
					<when test="status == 'SALE'">
						AND p.stock_qty > 0
					</when>
					<when test="status == 'SOLD_OUT'">
						AND p.stock_qty = 0
					</when>
					<when test="status == 'STOP_SALE'">
						AND p.is_visible = 0
					</when>
				</choose>
			</if>

			<!-- 검색 필터 -->
			<if
				test="searchType != null and searchKeyword != null and searchKeyword != ''">
				<choose>
					<when test="searchType == 'NAME'">
						AND p.name LIKE CONCAT('%', #{searchKeyword}, '%')
					</when>
					<when test="searchType == 'CATEGORY'">
						AND (
						p.category1_id IN (
						SELECT category_id FROM category WHERE name LIKE CONCAT('%',
						#{searchKeyword}, '%')
						)
						OR p.category2_id IN (
						SELECT category_id FROM category WHERE name LIKE CONCAT('%',
						#{searchKeyword}, '%')
						)
						OR p.category3_id IN (
						SELECT category_id FROM category WHERE name LIKE CONCAT('%',
						#{searchKeyword}, '%')
						)
						)
					</when>
				</choose>
			</if>
		</where>
		GROUP BY p.product_id
		) AS countTable
	</select>
</mapper>