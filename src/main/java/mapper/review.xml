<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.review">

	<!-- =================소비자=================== -->
	<!-- [소비자] 상품 ID로 해당 상품의 리뷰 목록 조회 (공개된 것만) [ProductDetail 용] -->
	<select id="selectReviewsByProductId" parameterType="map"
		resultType="java.util.Map">
		SELECT
		r.review_id,
		r.member_id,
		r.rating,
		r.content,
		r.questioned_at,
		r.image1_file_id,
		r.image2_file_id,
		r.image3_file_id,
		m.nickname,
		cd.name AS skin_type,
		po.option_value AS option_name
		FROM review r
		INNER JOIN member m ON r.member_id = m.member_id
		LEFT JOIN code_detail cd 
		ON m.skin_type_id = cd.code_detail_id
		LEFT JOIN product_option po 
		ON r.product_option_id = po.product_option_id
		WHERE r.product_id = #{productId}
		AND r.status = 'PUBLISHED'
		ORDER BY r.questioned_at DESC
		LIMIT #{limit} OFFSET #{offset}
	</select>

	<!-- [소비자] 상품의 리뷰 요약 정보 조회 [ProductDetail 용] -->
	<select id="getReviewSummaryByProductId" parameterType="Long"
		resultType="java.util.Map">
		SELECT
		COUNT(*) as totalCount,
		AVG(rating) as averageRating,
		SUM(CASE WHEN rating = 5 THEN 1 ELSE 0 END) as rating5Count,
		SUM(CASE
		WHEN rating = 4 THEN 1 ELSE 0 END) as rating4Count,
		SUM(CASE WHEN
		rating = 3 THEN 1 ELSE 0 END) as rating3Count,
		SUM(CASE WHEN rating = 2
		THEN 1 ELSE 0 END) as rating2Count,
		SUM(CASE WHEN rating = 1 THEN 1
		ELSE 0 END) as rating1Count
		FROM review
		WHERE product_id = #{productId}
		AND status = 'PUBLISHED'
	</select>

	<!-- 상품의 리뷰 개수 조회 (페이징 용) -->
	<select id="getReviewCountByProductId" parameterType="Long"
		resultType="Integer">
		SELECT COUNT(*) FROM review
		WHERE product_id = #{productId}
		AND status = 'PUBLISHED'
	</select>

	<!-- ========================== [소비자 마이페이지용] ========================== -->
	<!-- 리뷰 작성 가능한 상품 목록 조회 (배송완료/구매확정된 상품 중 아직 리뷰를 작성하지 않은 상품들) -->
	<select id="selectReviewableItems" parameterType="Long"
		resultType="java.util.Map">
		SELECT
		oi.order_item_id,
		oi.order_id,
		oi.product_id,
		oi.option_id AS product_option_id,
		oi.unit_price,
		oi.quantity,
		oi.status
		AS order_status,
		o.created_at AS
		order_date,
		p.name AS product_name,
		p.thumbnail_file_id,
		po.option_value
		AS option_name
		FROM order_item oi
		INNER JOIN orders o ON oi.order_id = o.orders_id
		INNER JOIN product p
		ON oi.product_id = p.product_id
		LEFT JOIN product_option po ON
		oi.option_id = po.product_option_id
		WHERE o.member_id = #{memberId}
		AND
		oi.status IN ('DELIVERED', 'CONFIRMED')
		AND NOT EXISTS (
		SELECT 1
		FROM
		review r
		WHERE r.order_item_id = oi.order_item_id
		)
		ORDER BY o.created_at
		DESC
	</select>

	<!-- ========= [소비자 마이페이지용] 내가 작성한 리뷰 목록 조회 ======================= -->
	<select id="selectMyReviews" parameterType="Long"
		resultType="java.util.Map">
		SELECT
		r.review_id,
		r.order_item_id,
		r.product_id,
		r.product_option_id,
		r.rating,
		r.content,
		r.image1_file_id,
		r.image2_file_id,
		r.image3_file_id,
		r.status AS
		review_status,
		r.questioned_at AS review_date,
		r.answer,
		r.answered_at,
		oi.order_id,
		oi.unit_price,
		oi.quantity,
		o.created_at AS order_date,
		p.name AS
		product_name,
		p.thumbnail_file_id,
		po.option_value AS
		option_name
		FROM
		review r
		INNER JOIN order_item oi ON r.order_item_id = oi.order_item_id
		INNER JOIN orders o ON oi.order_id = o.orders_id
		INNER JOIN product p
		ON r.product_id = p.product_id
		LEFT JOIN product_option po ON
		r.product_option_id = po.product_option_id
		WHERE r.member_id =
		#{memberId}
		ORDER BY r.questioned_at DESC
	</select>

	<!-- ====== [소비자 마이페이지용] 리뷰 작성 ======================= -->
	<insert id="insertReview" parameterType="dto.Review">
		INSERT INTO review (
		member_id,
		order_item_id,
		product_id,
		product_option_id,
		rating,
		content,
		image1_file_id,
		image2_file_id,
		image3_file_id,
		status
		) VALUES (
		#{memberId},
		#{orderItemId},
		#{productId},
		#{productOptionId},
		#{rating},
		#{content},
		#{image1FileId},
		#{image2FileId},
		#{image3FileId},
		'PUBLISHED'
		)
	</insert>

	<!-- ==== [소비자 마이페이지용] 리뷰 존재 여부 확인 ====================== -->
	<select id="checkReviewExists" parameterType="Long"
		resultType="Integer">
		SELECT COUNT(*)
		FROM review
		WHERE order_item_id =
		#{orderItemId}
	</select>

	<!-- ==== [소비자 마이페이지용] 리뷰 수정...안 할 거 같긴 한데... ======================= -->
	<update id="updateReview" parameterType="dto.Review">
		UPDATE review
		SET
		rating =
		#{rating},
		content = #{content},
		image1_file_id = #{image1FileId},
		image2_file_id = #{image2FileId},
		image3_file_id = #{image3FileId}
		WHERE review_id = #{reviewId}
		AND member_id = #{memberId}
	</update>

	<!-- 테스트용 쿼리 대체 이거 왜 안 되는 거임 스트레스 받아 -->
	<select id="testQuery" parameterType="Long"
		resultType="java.util.Map">
		SELECT oi.order_item_id, oi.status, o.member_id
		FROM
		order_item oi
		INNER JOIN orders o ON oi.order_id = o.orders_id
		WHERE
		o.member_id = #{memberId}
		AND oi.status IN ('DELIVERED', 'CONFIRMED')
	</select>

	<!--============ LEFT JOIN 없는 버전으로 테스트 ============ -->
	<select id="testQuery2" parameterType="Long"
		resultType="java.util.Map">
		SELECT
		oi.order_item_id,
		oi.status,
		o.member_id,
		COUNT(r.review_id) as review_count
		FROM order_item oi
		INNER JOIN orders
		o ON oi.order_id = o.orders_id
		LEFT JOIN review r ON oi.order_item_id =
		r.order_item_id
		WHERE o.member_id = #{memberId}
		AND oi.status IN
		('DELIVERED', 'CONFIRMED')
		GROUP BY oi.order_item_id, oi.status,
		o.member_id
		ORDER BY oi.order_item_id
	</select>


	<!-- ======================= [브랜드 어드민] 리뷰 목록 조회 ======================= -->
	<select id="selectReviewListForBrand" parameterType="map"
		resultType="reviewList">
		SELECT
		r.review_id,
		r.member_id,
		r.order_item_id,
		r.product_id,
		r.product_option_id,
		r.rating,
		r.content,
		r.image1_file_id,
		r.image2_file_id,
		r.image3_file_id,
		r.answer,
		r.status,
		r.questioned_at,
		r.answered_at,
		po.option_value AS option_name,
		p.thumbnail_file_id,
		p.name AS product_name,
		m.name AS member_name,
		CASE WHEN r.answer IS NOT
		NULL THEN 'ANSWERED' ELSE 'PENDING' END AS answer_status
		FROM review r
		INNER JOIN product p ON r.product_id = p.product_id
		LEFT JOIN
		product_option po ON r.product_option_id = po.product_option_id
		INNER
		JOIN member m ON r.member_id = m.member_id

		<where>
			p.brand_id = #{brandId}

			<if test="answerStatus != null and answerStatus != ''">
				<choose>
					<when test="answerStatus == 'ANSWERED'">
						AND r.answer IS NOT NULL
					</when>
					<when test="answerStatus == 'PENDING'">
						AND r.answer IS NULL
					</when>
				</choose>
			</if>

			<if test="startDate != null and startDate != ''">
				AND r.questioned_at &gt;= #{startDate}
			</if>
			<if test="endDate != null and endDate != ''">
				AND r.questioned_at &lt;= #{endDate}
			</if>

			<if
				test="searchType != null and searchKeyword != null and searchKeyword != ''">
				<choose>
					<when test="searchType == 'NAME'">
						AND p.name LIKE CONCAT('%', #{searchKeyword}, '%')
					</when>
					<when test="searchType == 'SENDER'">
						AND m.name LIKE CONCAT('%', #{searchKeyword}, '%')
					</when>
				</choose>
			</if>
		</where>

		<if test="sortField != null and sortField != ''">
			ORDER BY ${sortField}
			<if test="sortOrder == 'desc'">DESC</if>
			<if test="sortOrder == 'asc'">ASC</if>
		</if>

		LIMIT #{limit} OFFSET #{offset}
	</select>

	<!-- ======================= [브랜드 어드민] 리뷰 개수 조회 ======================= -->
	<select id="selectReviewCountForBrand" parameterType="map"
		resultType="Integer">
		SELECT COUNT(*)
		FROM (
		SELECT r.review_id
		FROM review r
		INNER JOIN product
		p ON r.product_id = p.product_id
		LEFT JOIN product_option po ON
		r.product_option_id = po.product_option_id
		INNER JOIN member m ON
		r.member_id = m.member_id
		<where>
			p.brand_id = #{brandId}

			<if test="answerStatus != null and answerStatus != ''">
				<choose>
					<when test="answerStatus == 'ANSWERED'">
						AND r.answer IS NOT NULL
					</when>
					<when test="answerStatus == 'PENDING'">
						AND r.answer IS NULL
					</when>
				</choose>
			</if>

			<if test="startDate != null and startDate != ''">
				AND r.questioned_at &gt;= #{startDate}
			</if>
			<if test="endDate != null and endDate != ''">
				AND r.questioned_at &lt;= #{endDate}
			</if>

			<if
				test="searchType != null and searchKeyword != null and searchKeyword != ''">
				<choose>
					<when test="searchType == 'NAME'">
						AND p.name LIKE CONCAT('%', #{searchKeyword}, '%')
					</when>
					<when test="searchType == 'SENDER'">
						AND m.name LIKE CONCAT('%', #{searchKeyword}, '%')
					</when>
				</choose>
			</if>
		</where>
		GROUP BY r.review_id
		) AS countTable
	</select>

	<!-- ======================= [브랜드 어드민] 리뷰 단건 조회 ======================= -->
	<select id="selectReviewDetailForBrand" parameterType="Long"
		resultType="reviewList">
		SELECT
		r.review_id,
		r.member_id,
		r.order_item_id,
		r.product_id,
		r.product_option_id,
		r.rating,
		r.content,
		r.image1_file_id,
		r.image2_file_id,
		r.image3_file_id,
		r.answer,
		r.status,
		r.questioned_at,
		r.answered_at,
		po.option_value AS option_name,
		p.thumbnail_file_id,
		p.name AS product_name,
		m.name AS member_name,
		CASE WHEN r.answer IS NOT
		NULL THEN 'ANSWERED' ELSE 'PENDING' END AS
		answer_status
		FROM review r
		INNER JOIN product p ON r.product_id = p.product_id
		LEFT JOIN
		product_option po ON r.product_option_id = po.product_option_id
		INNER
		JOIN member m ON r.member_id = m.member_id
		WHERE r.review_id = #{value}
	</select>

	<!-- ======================= [브랜드 어드민] 리뷰 답변 등록 ======================= -->
	<update id="updateReviewAnswer" parameterType="map">
		UPDATE review
		SET
		answer = #{answer},
		answered_at = NOW()
		WHERE review_id = #{reviewId}
	</update>

</mapper>