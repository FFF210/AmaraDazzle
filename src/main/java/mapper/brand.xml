<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.brand">

	<!-- ======================= 소비자용 ======================= -->
	<!-- 브랜드 ID로 브랜드 정보 조회 (상품 상세용) -->
	<select id="selectBrandByBrandId" parameterType="Long"
		resultType="dto.Brand">
		SELECT * FROM brand WHERE brand_id = #{brandId}
	</select>

	<!-- ================[소비자] 멤버십 가입 브랜드 조회 =================== -->
	<select id="selectActiveMembershipBrands"
		parameterType="Integer" resultType="membershipBrand">
		SELECT
		m.membership_id AS
		membershipId,
		m.brand_id AS brandId,
		b.brand_name AS brandName,
		b.logo_file_id AS logoFileId,
		b.hero_file_id AS heroFileId,
		b.intro AS
		intro
		FROM membership m
		INNER JOIN brand b ON m.brand_id = b.brand_id
		WHERE m.status = 'ACTIVE'
		ORDER BY m.created_at DESC
		LIMIT #{value}
	</select>






	<!--======================= [브랜드 어드민] 회원가입 ======================= -->
	<insert id="insertBrand" parameterType="brand"
		useGeneratedKeys="true" keyProperty="brandId">
		INSERT INTO brand
		(
		email,
		password,
		brn,
		brand_name,
		manager_name,
		phone,
		brand_status
		)
		VALUES
		(
		#{email},
		#{password},
		#{brn},
		#{brandName},
		#{managerName},
		#{phone},
		'SIGNUP_COMPLETED'
		)
	</insert>

	<!--======================= [브랜드 어드민] 브랜드 입점신청 ======================= -->
	<update id="updateBrandApply" parameterType="brand">
		UPDATE brand
		SET
		logo_file_id = #{logoFileId},
		hero_file_id = #{heroFileId},
		intro =
		#{intro},
		bank = #{bank},
		account_number = #{accountNumber},
		account_holder = #{accountHolder},
		settlement_date = #{settlementDate},
		brand_status = #{brandStatus}
		WHERE brand_id = #{brandId}
	</update>

	<!--======================= [브랜드 어드민] 이메일 존재 여부 ======================= -->
	<select id="selectByEmail" parameterType="string"
		resultType="int">
		SELECT COUNT(*) > 0 FROM brand WHERE email = #{value}
	</select>

	<!--======================= [브랜드 어드민] 사업자등록번호 존재 여부 ======================= -->
	<select id="selectByBrn" parameterType="string" resultType="int">
		SELECT COUNT(*) > 0 FROM brand WHERE brn = #{value}
	</select>

	<!--======================= [브랜드 어드민] 브랜드명 존재 여부 ======================= -->
	<select id="selectByBrandName" parameterType="string"
		resultType="int">
		SELECT COUNT(*) > 0 FROM brand WHERE brand_name = #{value}
	</select>

	<!-- ======================= [브랜드 어드민] 로그인 ======================= -->
	<select id="selectBrandByPassword" parameterType="string"
		resultType="brand">
		SELECT
		brand_id, email, password, brn, brand_name,
		manager_name, phone,
		brand_status, logo_file_id, hero_file_id, intro,
		bank,
		account_number, account_holder, settlement_date,
		created_at,
		updated_at
		FROM brand
		WHERE email = #{value}
		AND brand_status IN
		('SIGNUP_COMPLETED', 'APPLY_SUBMITTED', 'APPROVED')
	</select>

	<!-- ======================= [브랜드 어드민] 브랜드 정보 수정 ======================= -->
	<select id="selectBrandInfo" parameterType="long"
		resultType="brand">
		SELECT *
		FROM brand
		WHERE brand_id = #{brandId}
	</select>

	<!-- ======================= [브랜드 어드민] 브랜드 정보 수정 ======================= -->
	<update id="updateBrandInfo" parameterType="brand">
		UPDATE brand
		<set>
			<if test="managerName != null">manager_name = #{managerName},</if>
			<if test="phone != null">phone = #{phone},</if>
			<if test="logoFileId != null">logo_file_id = #{logoFileId},</if>
			<if test="heroFileId != null">hero_file_id = #{heroFileId},</if>
			<if test="intro != null">intro = #{intro},</if>
			<if test="bank != null">bank = #{bank},</if>
			<if test="accountNumber != null">account_number = #{accountNumber},</if>
			<if test="accountHolder != null">account_holder = #{accountHolder},</if>
			updated_at = CURRENT_TIMESTAMP
		</set>
		WHERE
		brand_id =
		#{brandId}
	</update>

	<!-- [브랜드 어드민] 오늘 할 일 대시보드 - 요약 정보 -->
	<select id="selectDashboardSummary" parameterType="long"
		resultType="dashboardSummary">
		SELECT
		(
		SELECT COUNT(DISTINCT oi.order_id)
		FROM order_item oi
		WHERE oi.brand_id = #{brandId}
		AND DATE(oi.created_at) = CURDATE()
		) AS
		today_order_count,

		(
		SELECT COUNT(*)
		FROM (
		SELECT e.exchange_id AS id,
		e.updated_at AS updated_at
		FROM exchange e
		JOIN order_item oi ON
		e.order_item_id = oi.order_item_id
		WHERE oi.brand_id = #{brandId}
		AND
		e.updated_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
		UNION ALL
		SELECT
		r.returns_id AS id, r.updated_at AS updated_at
		FROM returns r
		JOIN
		order_item oi ON r.order_item_id = oi.order_item_id
		WHERE oi.brand_id =
		#{brandId}
		AND r.updated_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
		) AS
		refund_exchange
		) AS refund_exchange_count,

		(
		SELECT COUNT(*)
		FROM (
		SELECT p.product_id
		FROM product p
		WHERE p.brand_id =
		#{brandId}
		AND
		p.has_option = 0
		AND p.stock_qty &lt;= 10
		UNION ALL
		SELECT
		po.product_option_id
		FROM product p
		JOIN product_option po ON
		p.product_id = po.product_id
		WHERE p.brand_id = #{brandId}
		AND
		p.has_option = 1
		AND po.stock_qty &lt;= 10
		) AS low_stock
		) AS
		low_stock_count,

		(
		SELECT COUNT(*)
		FROM review rv
		JOIN order_item oi ON
		rv.order_item_id = oi.order_item_id
		WHERE oi.brand_id = #{brandId}
		AND
		rv.rating &lt;= 2
		) AS bad_review_count
	</select>


	<!-- [브랜드 어드민] 오늘 할 일 대시보드 - 오늘 할 일 -->
	<select id="selectDashboardTodo" parameterType="long"
		resultType="dashboardTodo">
		SELECT
		(
		SELECT COUNT(DISTINCT oi.order_id)
		FROM order_item oi
		WHERE oi.brand_id = #{brandId}
		AND oi.status = 'PAID'
		) AS
		paid_order_count,

		(
		SELECT COUNT(DISTINCT oi.order_id)
		FROM order_item oi
		WHERE oi.brand_id = #{brandId}
		AND oi.status = 'PREPARING'
		) AS
		preparing_order_count,

		(
		SELECT COUNT(DISTINCT oi.order_id)
		FROM
		order_item oi
		WHERE oi.brand_id = #{brandId}
		AND oi.status =
		'RETURN_REQUESTED'
		) AS return_requested_count,

		(
		SELECT COUNT(DISTINCT
		oi.order_id)
		FROM order_item oi
		WHERE oi.brand_id = #{brandId}
		AND
		oi.status = 'EXCHANGE_REQUESTED'
		) AS exchange_requested_count,

		(
		SELECT
		IFNULL((
		SELECT COUNT(*)
		FROM ticket t
		JOIN order_item oi ON t.order_id =
		oi.order_id
		WHERE oi.brand_id = #{brandId}
		AND (t.answer IS NULL OR
		t.answer = '')
		), 0)
		+
		IFNULL((
		SELECT COUNT(*)
		FROM qna q
		WHERE q.brand_id
		= #{brandId}
		AND (q.answer IS NULL OR q.answer = '')
		), 0)
		) AS
		unanswered_inquiry_count
	</select>

	<!-- [브랜드 어드민] 이벤트 일정 알림 -->
	<select id="selectEventAlerts" parameterType="long"
		resultType="eventAlert">
		SELECT
		e.event_id,
		e.event_name,
		e.event_type,
		e.status,
		e.start_date,
		e.end_date,
		DATEDIFF(e.start_date, CURDATE()) AS
		days_until_start,
		DATEDIFF(e.end_date, CURDATE()) AS days_until_end
		FROM event_application ea
		JOIN event e ON
		ea.event_id = e.event_id
		WHERE
		ea.brand_id = #{brandId}
		AND (
		(e.status = 'RECRUIT' AND e.start_date
		BETWEEN CURDATE() AND
		DATE_ADD(CURDATE(), INTERVAL 3 DAY))
		OR
		(e.status =
		'ONGOING' AND CURDATE() BETWEEN DATE(e.start_date) AND
		DATE(e.end_date))
		)
		ORDER BY e.start_date ASC
	</select>

	<!-- [브랜드 어드민] 이번 주 인기 상품 Top3 -->
	<select id="selectWeeklyTop3Products" parameterType="long"
		resultType="topProduct">
		SELECT
		p.product_id AS productId,
		p.name AS productName,
		p.thumbnail_file_id AS thumbnailFileId,
		SUM(oi.quantity) AS totalSold,
		DATE_SUB(CURDATE(), INTERVAL (DAYOFWEEK(CURDATE()) - 2) DAY) AS
		weekStartDate,
		CURDATE() AS baseDate
		FROM order_item oi
		JOIN product p ON
		oi.product_id =
		p.product_id
		WHERE
		oi.brand_id = #{brandId}
		AND oi.status
		IN ('PAID', 'PREPARING',
		'SHIPPING', 'DELIVERED',
		'CONFIRMED')
		AND
		YEARWEEK(oi.updated_at, 1) =
		YEARWEEK(CURDATE(), 1)
		GROUP BY
		p.product_id, p.name,
		p.thumbnail_file_id
		ORDER BY totalSold DESC
		LIMIT
		3
	</select>

	<!-- ======================= ADMIN ======================= -->
	<!-- 가입한 브랜드 전체 수 -->
	<select id="brandAllCnt" resultType="Integer" parameterType="searchCondition">
		select count(*) from brand b
		<where>
			<if test="startDateTime != null and endDateTime != null">
				and (b.created_at &gt;= #{startDateTime}
						and b.created_at &lt; #{endDateTime})
			</if>
			<if test="middleFilter != null and middleFilter != ''">
				<choose>
					<when test="middleFilter == 'APPLY_SUBMITTED'">
						and b.brand_status = 'APPLY_SUBMITTED'
					</when>
					<when test="middleFilter == 'APPROVED'">
						and b.brand_status = 'APPROVED'
					</when>
					<when test="middleFilter == 'SIGNUP_COMPLETED'">
						and b.brand_status = 'SIGNUP_COMPLETED'
					</when>
				</choose>
			</if>
			<if test="totalSearch != null and totalSearch != '' and keyword != null and keyword != ''">
				<choose>
					<when test="totalSearch == '브랜드명'">
						and b.brand_name like concat('%',#{keyword},'%')
					</when>
					<when test="totalSearch == '담당자명'">
						and b.manager_name like concat('%',#{keyword},'%')
					</when>
					<when test="totalSearch == '사업자번호'">
						and b.brn like concat('%',#{keyword},'%')
					</when>
					<when test="totalSearch == '아이디'">
						and b.email like concat('%',#{keyword},'%')
					</when>
				</choose>
			</if>
		</where>
	</select>

	<!-- 브랜드 검색 리스트 -->
	<select id="brandSearchList" resultType="brand" parameterType="searchCondition">
		select b.*, f.file_rename
		from brand b
		left join upload_file f on (b.logo_file_id = f.upload_file_id)
		<where>
			<if test="startDateTime != null and endDateTime != null">
				and (b.created_at &gt;= #{startDateTime}
						and b.created_at &lt; #{endDateTime})
			</if>
			<if test="middleFilter != null and middleFilter != ''">
				<choose>
					<when test="middleFilter == 'APPLY_SUBMITTED'">
						and b.brand_status = 'APPLY_SUBMITTED'
					</when>
					<when test="middleFilter == 'APPROVED'">
						and b.brand_status = 'APPROVED'
					</when>
					<when test="middleFilter == 'SIGNUP_COMPLETED'">
						and b.brand_status = 'SIGNUP_COMPLETED'
					</when>
				</choose>
			</if>
			<if test="totalSearch != null and totalSearch != '' and keyword != null and keyword != ''">
				<choose>
					<when test="totalSearch == '브랜드명'">
						and b.brand_name like concat('%',#{keyword},'%')
					</when>
					<when test="totalSearch == '담당자명'">
						and b.manager_name like concat('%',#{keyword},'%')
					</when>
					<when test="totalSearch == '사업자번호'">
						and b.brn like concat('%',#{keyword},'%')
					</when>
					<when test="totalSearch == '아이디'">
						and b.email like concat('%',#{keyword},'%')
					</when>
				</choose>
			</if>
		</where>
		order by b.brand_id desc limit #{start_p},#{post_ea}
	</select>

</mapper>