<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.banner">

	<!-- brand2 -->

	<!-- 배너 신청 -->
	<insert id="insertBannerForm" parameterType="banner">
		INSERT INTO banner
		(
		brand_id,
		manager_name,
		manager_tel, start_date, end_date,
		banner_name,
		banner_message, status,
		brand_url, upload_file_id)
		VALUES
		(#{brandId},
		#{managerName},
		#{managerTel}, #{startDate},
		#{endDate},
		#{bannerName},
		#{bannerMessage}, #{status}, #{brandUrl}, #{uploadFileId})
	</insert>

	<!-- <update id="update" parameterType="banner"> UPDATE banner SET manager_name 
		= #{managerName}, manager_tel = #{managerTel}, updated_at = NOW(), start_date 
		= #{startDate}, end_date = #{endDate}, banner_name = #{bannerName}, banner_message 
		= #{bannerMessage}, status = #{status}, brand_url = #{brandUrl}, is_exposed 
		= #{isExposed}, state_change = #{stateChange}, admin_id = #{adminId} WHERE 
		banner_id = #{bannerId} </update> -->

	<!-- 상세보기 버튼 -->
	<select id="selectBannerById" parameterType="long"
		resultType="banner">
		SELECT
		banner_id AS bannerId,
		brand_id as brandId,
		banner_name AS bannerName,
		start_date AS startDate,
		end_date AS endDate,
		status AS status,
		manager_name AS managerName,
		manager_tel AS managerTel,
		created_at AS createdAt,
		banner_message AS bannerMessage,
		upload_file_id AS uploadFileId,
		DATEDIFF(end_date, start_date) AS period
		FROM banner
		WHERE banner_id = #{bannerId}
	</select>

	<!-- 삭제하기 버튼 -->
	<update id="updateBannerStatus" parameterType="map">
		UPDATE banner
		SET status = #{status},
		updated_at=now()
		WHERE banner_id = #{bannerId}
	</update>


	<!-- 배너 광고 신청 목록 조회 -->
	<select id="selectAdbannerList" parameterType="banner"
		resultType="banner">
		SELECT
		b.banner_id,
		b.manager_name,
		b.manager_tel,
		b.start_date,
		b.end_date,
		b.banner_name,
		b.banner_message,
		b.status,
		b.created_at,
		b.updated_at,
		b.is_exposed,
		b.brand_url,
		b.state_change,
		b.admin_id,
		CASE
		when ap.payment_id IS NOT NULL THEN 1
		ELSE 0
		END AS paid
		FROM
		banner b
		LEFT JOIN admin_payment ap
		ON ap.banner_id = b.banner_id
		AND
		ap.payment_type = 'BANNER_AD'
		<where>
			<!-- 상태 필터링 -->
			<if test="status != null and status != ''">
				<choose>
					<when test="status=='PENDING'">
						AND status = 'PENDING'
					</when>
					<when test="status=='APPROVED'">
						AND status = 'APPROVED'
					</when>
					<when test="status=='ONGOING'">
						AND status = 'ONGOING'
					</when>
					<when test="status=='CANCELED'">
						AND status = 'CANCELED'
					</when>
					<when test="status=='COMPLETED'">
						AND status = 'COMPLETED'
					</when>
				</choose>
			</if>

			<!-- 검색 유형 : 광고명, 광고담당자 -->
			<if
				test="searchType != null and searchKeyword != null and searchKeyword != ''">
				<choose>
					<when test="searchType eq 'BANNERNAME'">
						AND b.banner_name LIKE CONCAT('%',
						#{searchKeyword}, '%')
					</when>
					<when test="searchType eq 'MANAGERNAME'">
						AND b.manager_name LIKE CONCAT('%',
						#{searchKeyword}, '%')
					</when>
				</choose>
			</if>
		</where>
		ORDER BY b.banner_id DESC
		LIMIT #{limit} OFFSET #{offset}
	</select>

	<!-- 배너 광고 신청 개수 조회 -->
	<select id="selectAdbannerCount" parameterType="map"
		resultType="int">
		SELECT COUNT(*)
		FROM banner b
	</select>

	<!-- 결제 완료 후 배너 상태 변경 <update id="updateBannerStatus" parameterType="map"> 
		UPDATE banner SET status = #{status}, updated_at = NOW() WHERE banner_id 
		= #{bannerId} </update> -->

	<!-- adbannerList 상세보기 버튼 -->


	<!-- brand2 -->


	<!-- ================[소비자] 메인페이지 배너 노출 목록 =================== -->
	<select id="selectBannerListForMain"
		resultType="banner">
		SELECT
		b.banner_id AS bannerId,
		b.brand_id AS brandId,
		b.manager_name AS managerName,
		b.manager_tel AS managerTel,
		b.start_date AS startDate,
		b.end_date AS endDate,
		b.banner_name AS bannerName,
		b.banner_message AS bannerMessage,
		b.status AS status,
		b.created_at AS createdAt,
		b.updated_at AS updatedAt,
		b.is_exposed AS isExposed,
		b.brand_url AS brandUrl,
		b.state_change AS stateChange,
		b.admin_id AS adminId,
		b.upload_file_id AS uploadFileId
		FROM banner b
		WHERE b.is_exposed = 1
		AND b.state_change = 'POSTING'
		AND b.status IN ('ONGOING')
		AND NOW() BETWEEN b.start_date AND b.end_date
		ORDER BY b.created_at DESC
	</select>

</mapper>