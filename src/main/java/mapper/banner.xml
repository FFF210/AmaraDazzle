<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.banner">

	<!-- brand2 -->

	<!-- 배너 신청 -->
	<insert id="insertBannerForm" parameterType="banner">
		INSERT INTO banner
		(
		brand_id,
		manager_name,
		manager_tel, start_date, end_date,
		banner_name,
		banner_message, status,
		brand_url, upload_file_id)
		VALUES
		(#{brandId},
		#{managerName},
		#{managerTel}, #{startDate},
		#{endDate},
		#{bannerName},
		#{bannerMessage}, #{status}, #{brandUrl}, #{uploadFileId})
	</insert>

	<!-- 상세보기 버튼 -->
	<select id="selectBannerById" parameterType="long"
		resultType="banner">
		SELECT
		banner_id AS bannerId,
		brand_id as brandId,
		banner_name AS bannerName,
		start_date AS startDate,
		end_date AS endDate,
		status AS status,
		manager_name AS managerName,
		manager_tel AS
		managerTel,
		created_at AS createdAt,
		banner_message AS bannerMessage,
		upload_file_id AS uploadFileId,
		DATEDIFF(end_date, start_date) AS period
		FROM banner
		WHERE banner_id = #{bannerId}
	</select>

	<!-- 삭제하기 버튼 -->
	<update id="updateBannerStatus" parameterType="map">
		UPDATE banner
		SET
		status = #{status},
		changed_at=now()
		WHERE banner_id = #{bannerId}
	</update>

	<!-- 배너 광고 신청 목록 조회 -->
	<select id="selectAdbannerList" parameterType="banner"
		resultType="banner">
		SELECT
		b.banner_id,
		b.manager_name,
		b.manager_tel,
		b.start_date,
		b.end_date,
		b.banner_name,
		b.banner_message,
		b.status,
		b.created_at,
		b.changed_at,
		b.brand_url,
		b.state_change,
		b.admin_id,
		CASE
		when ap.payment_id IS NOT NULL THEN 1
		ELSE 0
		END AS paid
		FROM
		banner b
		LEFT JOIN admin_payment ap
		ON ap.banner_id = b.banner_id
		AND
		ap.payment_type = 'BANNER_AD'
		<where>
			<!-- 상태 필터링 -->
			<if test="status != null and status != ''">
				<choose>
					<when test="status=='PENDING'">
						AND status = 'PENDING'
					</when>
					<when test="status=='APPROVED'">
						AND status = 'APPROVED'
					</when>
					<when test="status=='ONGOING'">
						AND status = 'ONGOING'
					</when>
					<when test="status=='CANCELED'">
						AND status = 'CANCELED'
					</when>
					<when test="status=='COMPLETED'">
						AND status = 'COMPLETED'
					</when>
				</choose>
			</if>

			<!-- 검색 유형 : 광고명, 광고담당자 -->
			<if
				test="searchType != null and searchKeyword != null and searchKeyword != ''">
				<choose>
					<when test="searchType eq 'BANNERNAME'">
						AND b.banner_name LIKE CONCAT('%',
						#{searchKeyword}, '%')
					</when>
					<when test="searchType eq 'MANAGERNAME'">
						AND b.manager_name LIKE CONCAT('%',
						#{searchKeyword}, '%')
					</when>
				</choose>
			</if>
		</where>
		ORDER BY b.banner_id DESC
		LIMIT #{limit} OFFSET #{offset}
	</select>

	<!-- 배너 광고 신청 개수 조회 -->
	<select id="selectAdbannerCount" parameterType="map"
		resultType="int">
		SELECT COUNT(*)
		FROM banner b
	</select>

	<!-- 결제 완료 후 배너 상태 변경 <update id="updateBannerStatus" parameterType="map"> 
		UPDATE banner SET status = #{status}, changed_at = NOW() WHERE banner_id 
		= #{bannerId} </update> -->

	<!-- brand2 end -->


	<!-- admin -->
	<!-- banner 전체 개수 -->
	<select id="BannerAllCnt" resultType="Integer" parameterType="searchCondition">
		select count(*) from banner bn
		left join brand b on (bn.brand_id = b.brand_id)
		join admin_info a on (bn.admin_id = a.admin_info_id)
		<where>
			<if test="startDateTime != null and endDateTime != null">
				and (bn.created_at &gt;= #{startDateTime}
				and bn.created_at &lt; #{endDateTime})
			</if>
			<if test="startDateTime2 != null and endDateTime2 != null">
				and (bn.changed_at &gt;= #{startDateTime2}
				and bn.changed_at &lt; #{endDateTime2})
			</if>
			<if test="middleFilter != null and middleFilter != ''">
				<choose>
					<when test="middleFilter == 'POSTING'">
						and bn.state_change = 'POSTING'
					</when>
					<when test="middleFilter == 'OFF'">
						and bn.state_change = 'OFF'
					</when>
				</choose>
			</if>
			<if
				test="totalSearch != null and totalSearch != '' and keyword != null and keyword != ''">
				<choose>
					<when test="totalSearch == '브랜드명'">
						and b.brand_name like concat('%',#{keyword},'%')
					</when>
					<when test="totalSearch == '제목'">
						and bn.banner_name like concat('%',#{keyword},'%')
					</when>
				</choose>
			</if>
		</where>
	</select>

	<!-- 전체 배너 리스트 -->
	<select id="selectAllBannerList" resultType="banner" parameterType="Map">
		select bn.*, b.brand_name, a.aname, f.file_rename
		from banner bn
		left join brand b on (bn.brand_id = b.brand_id)
		join admin_info a on (bn.admin_id = a.admin_info_id)
		join upload_file f on (bn.upload_file_id = f.upload_file_id)
		order by banner_id desc limit #{start_p},#{post_ea}
	</select>

	<!-- 배너 검색 리스트 -->
	<select id="selectSearchBannerList" resultType="banner" parameterType="searchCondition">
		select bn.*, b.brand_name, a.aname, f.file_rename
		from banner bn
		left join brand b on (bn.brand_id = b.brand_id)
		join admin_info a on (bn.admin_id = a.admin_info_id)
		join upload_file f on (bn.upload_file_id = f.upload_file_id)
		<where>
			<if test="startDateTime != null and endDateTime != null">
				and (bn.created_at &gt;= #{startDateTime}
				and bn.created_at &lt; #{endDateTime})
			</if>
			<if test="startDateTime2 != null and endDateTime2 != null">
				and (bn.changed_at &gt;= #{startDateTime2}
				and bn.changed_at &lt; #{endDateTime2})
			</if>
			<if test="middleFilter != null and middleFilter != ''">
				<choose>
					<when test="middleFilter == 'POSTING'">
						and bn.state_change = 'POSTING'
					</when>
					<when test="middleFilter == 'OFF'">
						and bn.state_change = 'OFF'
					</when>
				</choose>
			</if>
			<if test="totalSearch != null and totalSearch != '' and keyword != null and keyword != ''">
				<choose>
					<when test="totalSearch == '브랜드명'">
						and b.brand_name like concat('%',#{keyword},'%')
					</when>
					<when test="totalSearch == '제목'">
						and bn.banner_name like concat('%',#{keyword},'%')
					</when>
				</choose>
			</if>
		</where>
		order by bn.banner_id desc limit #{start_p},#{post_ea}
	</select>
	
	<!-- 어드민 배너 등록 -->
	<insert id="adminBannerWrite" parameterType="banner">
		insert into banner 
			(banner_id, start_date, end_date, banner_name, 
			brand_url, admin_id, upload_file_id, created_at)
		values 
			(0, #{startDate}, #{endDate}, #{bannerName},
			#{brandUrl},#{adminId}, #{UploadFileId}, now())
	</insert>
	
	<!-- 배너 게시물 상세보기 -->
	<select id="bannerDetail" resultType="banner" parameterType="int" >
		select bn.*, b.brand_name, p.amount as payAmount, a.aname, f.file_name, f.file_rename
		from banner bn
		left join brand b on (bn.brand_id = b.brand_id)
		left join admin_payment p on (bn.banner_id = p.banner_id)
		join admin_info a on (bn.admin_id = a.admin_info_id)
		join upload_file f on (bn.upload_file_id = f.upload_file_id)
		where bn.banner_id = #{num}
	</select>


	<!-- ================[소비자] 메인페이지 배너 노출 목록 =================== -->
	<select id="selectBannerListForMain" resultType="banner">
		SELECT
		b.banner_id AS bannerId,
		b.brand_id AS brandId,
		b.manager_name AS
		managerName,
		b.manager_tel AS managerTel,
		b.start_date AS startDate,
		b.end_date AS endDate,
		b.banner_name AS bannerName,
		b.banner_message AS
		bannerMessage,
		b.status AS status,
		b.created_at AS createdAt,
		b.changed_at AS changedAt,
		b.brand_url AS
		brandUrl,
		b.state_change AS stateChange,
		b.admin_id AS adminId,
		b.upload_file_id AS uploadFileId
		FROM banner b
		WHERE b.state_change = 'POSTING'
		AND b.status IN ('ONGOING')
		AND NOW()
		BETWEEN b.start_date AND b.end_date
		ORDER BY b.created_at DESC
	</select>

</mapper>